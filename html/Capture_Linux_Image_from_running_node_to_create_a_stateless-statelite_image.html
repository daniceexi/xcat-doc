<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#basic-idea">Basic Idea</a></li>
<li><a href="#xcat-interface">xCAT Interface</a><ul>
<li><a href="#new-xcat-command-capimage">New xCAT command: <strong>capimage</strong></a></li>
<li><a href="#the-filesdirecotries-to-be-excluded">The files/direcotries to be excluded</a></li>
</ul></li>
<li><a href="#the-implementation">The implementation</a></li>
<li><a href="#notes">Notes</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#basic-idea">Basic Idea</a></li>
<li><a href="#xcat-interface">xCAT Interface</a></li>
<li><a href="#new-xcat-command-capimage">New xCAT command: <strong>capimage</strong></a></li>
<li><a href="#the-filesdirecotries-to-be-excluded">The files/direcotries to be excluded</a></li>
<li><a href="#the-implementation">The implementation</a></li>
<li><a href="#notes">Notes</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p>{{:Design Warning}}</p>
<p>This feature aims to capture the image from running node to create a stateless/statelite image. Currently it support Linux only.</p>
<h2 id="basic-idea"><a href="#TOC">Basic Idea</a></h2>
<p>There're many available capture utility candidates, including <strong>cpio</strong>, <strong>tar</strong>, <strong>pax</strong> and <strong>afio</strong>. These utilites handle the files as the targets to be archieved and they are capable of <em>excluding specific files and/or directories from the targets</em>. They are even create a single archive which contains files from multiple file systems.</p>
<p><strong>Note</strong>: the <em>cpio</em> utility was standardized in POSIX. 1-1988, and was dropped from the later version, starting with POSIX. 1-2001 due to its 8 GB filesize limit. The POSIX standardized <em>pax</em> utility can be used to read and write cpio archives instead.</p>
<ul>
<li>In order to capture the Linux image, we need to specify one diskful Linux node.</li>
<li>We also need one file to contain the files excluded from the image, the files and directories in this file will be excluded.</li>
<li>The diskful Linux node should be managed by xCAT, because <em>xdsh</em> and <em>xdcp</em> are necessary.</li>
<li><p>Following the existing <em>genimage</em> code to generate stateless image:</p>
<p>/bin/find . ! -path './xxxx*' |cpio -H newc -o |gzip -c - &gt; /tmp/rootimg.gz</p></li>
<li>Use the <em>xdcp</em> command to copy the <em>rootimg.gz</em> file from the specified diskful node to the MN.</li>
<li>Extract the contents of <em>rootimg.gz</em> to <em>/install/netboot/&lt;osver&gt;/&lt;arch&gt;/&lt;profile&gt;/rootimg</em></li>
<li>Perform the <em>genimage</em> command on the <em>/install/netbot/&lt;osver&gt;/&lt;arch&gt;/&lt;profile&gt;/rootimg</em> directory</li>
<li>Run the <em>packimage</em> or <em>liteimg</em> command</li>
<li><p>Run the <em>nodeset &lt;nr&gt; statelite/netboot</em> command</p></li>
</ul>
<h2 id="xcat-interface"><a href="#TOC">xCAT Interface</a></h2>
<h3 id="new-xcat-command-capimage"><a href="#TOC">New xCAT command: <strong>capimage</strong></a></h3>
<pre><code> capimage node [ -p|--profile &amp;lt;profile&amp;gt; ] </code></pre>
<p>Requirements:</p>
<ul>
<li>The <em>node</em> here should be one <strong>diskful</strong> Linux node;</li>
<li><em>-p</em> is optional, the user can specify the profile name for the statelite/stateless image to be created; if not specified, the current <em>profile</em> attribute of the <em>node</em> will be used for the image to be created.</li>
</ul>
<h3 id="the-filesdirecotries-to-be-excluded"><a href="#TOC">The files/direcotries to be excluded</a></h3>
<p>Some files/directories should be excluded when capturing the diskful Linux image from the running node, or else capturing will be failed. In my investagation, the following directories should be excluded:</p>
<pre><code> /tmp/
 /proc/
 /sys/
 /dev/
 /xcatpost/
 /install/</code></pre>
<h2 id="the-implementation"><a href="#TOC">The implementation</a></h2>
<ul>
<li>Parse the paramaters of the <em>capimage</em> command, get the <em>node</em> name and the <em>profile</em> name;</li>
<li><p>Build the command</p>
<p>/bin/find / ! -path './tmp<em>' ! -path './proc</em>' ! -path './sys<em>' ! -path './dev</em>' ! -path './xcatpost<em>' ! -path './install</em>' |cpio -H newc -o |gzip -c - &gt; /tmp/rootimg.gz</p></li>
<li>Use <em>xdsh</em> and the command above to capture and generate the image on the specified diskful node.</li>
<li>Use <em>xdcp</em> to copy the <em>/tmp/rootimg.gz</em> file from the specified diskful node</li>
<li>Extract the contents of <em>rootimg.gz</em> to the <em>/install/netboot/&lt;osver&gt;/&lt;arch&gt;/&lt;profile&gt;/rootimg</em> directory on MN.</li>
<li><p>Create the directories excluded when capturing the image</p>
<p>/tmp/ /proc/ /sys/ /dev/</p></li>
</ul>
<p>The next steps will be documented.</p>
<ul>
<li>Run the <em>genimage</em> command with the<em>&lt;osver&gt;</em>, <em>&lt;arch&gt;</em>, <em>&lt;profile&gt;</em> option.</li>
<li>Run the <em>liteimg</em>/<em>packimage</em> command</li>
<li>Run the <em>nodeset &lt;nr&gt; statelite/netboot</em> command</li>
</ul>
<h2 id="notes"><a href="#TOC">Notes</a></h2>
<p>It seems the root image captured from the diskful node requires many memory capabilities. For example, I captured the image from the diskful Linux node, which is installed by xCAT; then I tried to boot one LPAR with this image, but it always failed until I updated the memory capability to 5120MB. Here is output of the <em>df -h</em> command, you can see the usage of the memory in the stateless mode:</p>
<pre><code>[root@945n02 ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
test_ppc64            2.5G  2.3G  190M  93% /
tmpfs                 2.5G     0  2.5G   0% /dev/shm
tmpfs                  10M  192K  9.9M   2% /tmp
tmpfs                  10M     0   10M   0% /var/tmp</code></pre>
</body>
</html>
