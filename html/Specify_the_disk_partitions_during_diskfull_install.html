<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#overview">overview</a></li>
<li><a href="#external-interface">External Interface</a><ul>
<li><a href="#use-partition-definition-file">use partition definition file</a></li>
<li><a href="#use-script-to-create-partition-definition">use script to create partition definition</a></li>
</ul></li>
<li><a href="#internal-implementation">Internal implementation</a></li>
<li><a href="#limitation">Limitation</a></li>
<li><a href="#other-design-considerations">Other Design Considerations</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#overview">overview</a></li>
<li><a href="#external-interface">External Interface</a></li>
<li><a href="#use-partition-definition-file">use partition definition file</a></li>
<li><a href="#use-script-to-create-partition-definition">use script to create partition definition</a></li>
<li><a href="#internal-implementation">Internal implementation</a></li>
<li><a href="#limitation">Limitation</a></li>
<li><a href="#other-design-considerations">Other Design Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><a href="Design_Warning">Design_Warning</a></p>
<h2 id="overview"><a href="#TOC">overview</a></h2>
<p>xCAT use &quot;nodeset &lt;noderange&gt; install&quot; to create the install configure file(RHEL/CentOS/Fedora/SL/ESXI call kickstart file, SLES/SUSE/WINDOWS use xml file, Debian/Ubuntu call squeeze file) for each node. Command nodeset use *.tmpl file as a template and create each node's configure file. Currently the partition part in the *.tmpl file are hard code. There is a new requirement which from PCM is &quot;Ability to specify the disk partitions that should be setup during diskfull install&quot;.</p>
<h2 id="external-interface"><a href="#TOC">External Interface</a></h2>
<h3 id="use-partition-definition-file"><a href="#TOC">use partition definition file</a></h3>
<p>1. Write a file contains the partition definition. The definition format should be based on the OS type.</p>
<p>for RHEL/CentOS/Fedora/SL/ESXI likes:</p>
<pre><code> part swap --size 2048
 part / --size 1 --grow --fstype ext3</code></pre>
<p>for SLES/SUSE likes:</p>
<pre><code>   &lt;drive&gt;
     &lt;device&gt;/dev/sda&lt;/device&gt;
     &lt;initialize config:type=&quot;boolean&quot;&gt;true&lt;/initialize&gt;
     &lt;use&gt;all&lt;/use&gt;
   &lt;/drive&gt;</code></pre>
<p>for Windows likes:</p>
<pre><code> &lt;DiskConfiguration&gt;
   &lt;WillShowUI&gt;OnError&lt;/WillShowUI&gt;
   &lt;Disk&gt;
     &lt;DiskID&gt;0&lt;/DiskID&gt;
     &lt;WillWipeDisk&gt;true&lt;/WillWipeDisk&gt;
     &lt;CreatePartitions&gt;
       &lt;CreatePartition&gt;
         &lt;Order&gt;1&lt;/Order&gt;
         &lt;Type&gt;Primary&lt;/Type&gt;
         &lt;Extend&gt;true&lt;/Extend&gt;
         &lt;/CreatePartition&gt;
        &lt;/CreatePartitions&gt;
   &lt;/Disk&gt;
 &lt;/DiskConfiguration&gt;</code></pre>
<p>for Debian/Ubuntu likes:</p>
<pre><code> d-i partman-auto/expert_recipe string               \
     boot-root ::                                    \
             40 50 100 ext3                          \
             $primary{ } $bootable{ }                \
             method{ format } format{ }              \
             use_filesystem{ } filesystem{ ext3 }    \
             mountpoint{ /boot }                     \</code></pre>
<p>2. use &quot;chdef -t osimage &lt;imagename&gt; partitionfile=&lt;definition file absolute path&gt;&quot; to modify the osimage object.</p>
<p>3. run &quot;nodeset &lt;noderange&gt; install&quot;. The install configure file will contains the partition definition in the specified file.</p>
<h3 id="use-script-to-create-partition-definition"><a href="#TOC">use script to create partition definition</a></h3>
<p>1. write a script file, which can create a partition definition, and save the definition into /tmp/partitionfile (this file name can not be changed). Like:</p>
<pre><code> echo &quot;part swap --size 1024&quot; &gt; /tmp/partitionfile
 echo &quot;part / --size 1 --grow --fstype ext3&quot; &gt;&gt; /tmp/partitionfile</code></pre>
<p>2. use &quot;chdef -t osimage &lt;imagename&gt; partitionfile=s:&lt;script file absolute path&gt;&quot; to modify the osimage object.</p>
<p>3. run &quot;nodeset &lt;noderange&gt; install&quot;. The install configure file will contains the script which contained in %pre part and use &quot;%include /tmp/partitionfile&quot; to define the partition strategy.</p>
<h2 id="internal-implementation"><a href="#TOC">Internal implementation</a></h2>
<p>1. Database change: add an attribute partitionfile into osimage object. Put the partitionfile attribute into the linuximage schema. The user can use the chdef command to set/change the partitionfile attribute for the image.</p>
<p>2. *.tmpl file change: find out the partition definition subset in all *.tmpl files, use special comment line embrace the subset.</p>
<ul>
<li>for non-xml format .tmpl file, use #XCAT_PARTITION_START# and #XCAT_PARTITION_END# to embrace the subset.</li>
<li>for xml format .tmpl file, useandto embrace the subset.</li>
</ul>
<p>3. template.pm :</p>
<ul>
<li><p>In mkinstall():</p>
<ol style="list-style-type: lower-alpha">
<li>get the osimage's partitionfile attribute.</li>
<li>call subvars(), use the partitionfile attribute value as a parameter.</li>
</ol></li>
<li><p>In subvars();</p>
<ol style="list-style-type: lower-alpha">
<li>if the partitionfile is not exist: do not do any operations (will use the default definition in our *.tmpl file).</li>
<li>if the partitionfile is exist,</li>
<li>If the partitionfile is start with s:... , add the content in the partitionfile into %pre part in the kickstartfile, use %include /tmp/partitionfile to replace the subset witch embrace by comment line</li>
</ol>
<ol start="2" style="list-style-type: lower-roman">
<li>else, If partitionfile is readable, use the content in the partition file to replace the subset witch embrace by comment line(will use the specified definition).</li>
</ol></li>
</ul>
<h2 id="limitation"><a href="#TOC">Limitation</a></h2>
<ul>
<li>only the .tmpl files from xCAT-server package can work.</li>
<li>use script to create partition definition only works on redhat and sles linux. other version linux is still under design.</li>
</ul>
<h2 id="other-design-considerations"><a href="#TOC">Other Design Considerations</a></h2>
<ul>
<li>Required reviewers: Bruce Potter, Li Guang Cheng</li>
<li>Required approvers: Bruce Potter</li>
<li>Database schema changes: N/A</li>
<li>Affect on other components: N/A</li>
<li>External interface changes, documentation, and usability issues: add the document how to use this function</li>
<li>Packaging, installation, dependencies: N/A</li>
<li>Portability and platforms (HW/SW) supported: N/A</li>
<li>Performance and scaling considerations: N/A</li>
<li>Migration and coexistence: N/A</li>
<li>Serviceability: N/A</li>
<li>Security: N/A</li>
<li>NLS and accessibility: N/A</li>
<li>Invention protection: N/A</li>
</ul>
</body>
</html>
