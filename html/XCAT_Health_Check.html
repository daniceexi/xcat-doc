<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#interface">Interface</a><ul>
<li><a href="#xcat-files-for-the-health-check">xCAT Files for the health check</a></li>
<li><a href="#the-definition-of-health-check-resource">The definition of health check resource</a></li>
<li><a href="#syntax-of-xhealthcheck">Syntax of xhealthcheck</a></li>
<li><a href="#the-general-interface-for-dohealthcheck">The General Interface for dohealthcheck</a></li>
<li><a href="#the-interface-for-each-healthcheck-tool">The interface for each healthcheck tool</a></li>
</ul></li>
<li><a href="#implementation">Implementation</a><ul>
<li><a href="#inside-of-xhealthcheck">Inside of xhealthcheck</a></li>
<li><a href="#inside-of-dohealthcheck">Inside of dohealthcheck</a></li>
</ul></li>
<li><a href="#check-scenarios">Check Scenarios</a></li>
<li><a href="#more-consideration">More consideration</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#interface">Interface</a></li>
<li><a href="#xcat-files-for-the-health-check">xCAT Files for the health check</a></li>
<li><a href="#the-definition-of-health-check-resource">The definition of health check resource</a></li>
<li><a href="#syntax-of-xhealthcheck">Syntax of xhealthcheck</a></li>
<li><a href="#the-general-interface-for-dohealthcheck">The General Interface for dohealthcheck</a></li>
<li><a href="#the-interface-for-each-healthcheck-tool">The interface for each healthcheck tool</a></li>
<li><a href="#implementation">Implementation</a></li>
<li><a href="#inside-of-xhealthcheck">Inside of xhealthcheck</a></li>
<li><a href="#inside-of-dohealthcheck">Inside of dohealthcheck</a></li>
<li><a href="#check-scenarios">Check Scenarios</a></li>
<li><a href="#more-consideration">More consideration</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><a href="Design_Warning">Design_Warning</a></p>
<h2 id="interface"><a href="#TOC">Interface</a></h2>
<h3 id="xcat-files-for-the-health-check"><a href="#TOC">xCAT Files for the health check</a></h3>
<ul>
<li>/opt/xcat/bin/xhealthcheck</li>
</ul>
<p>The xCAT command to initiate the health check action</p>
<ul>
<li>/opt/xcat/sbin/dohealthcheck</li>
</ul>
<p>The script will be run on the target node (xCAT MN/SN or compute node) to parse the check request, call each check and generate the return message.</p>
<ul>
<li>/install/healthcheck/&lt;health check tools&gt;</li>
</ul>
<p>The 'health check tool' is an OS executable file which can perform some specific checking.</p>
<ul>
<li>/install/healthcheck/hc.checksum</li>
</ul>
<p>A specific file to maintain the change of files in /install/healthcheck</p>
<h3 id="the-definition-of-health-check-resource"><a href="#TOC">The definition of health check resource</a></h3>
<p>A <strong>health check resource</strong> is an unit which can be selected to check for end user. The name of 'health check resource' is composed of 'resource group' and 'sub resource name' by character '@'. e.g. I have a resource group named <strong>tcpip</strong> which is used to check any tcpip configuration, and this group includes several sub resources like 'dns', 'http', 'ib' ... Then the resource name will be tcpip@dns, tcpip@http, tcpip@ib.</p>
<p>From the implementation perspective, the health check resources are offered by health check tool which is an executable OS file. In general, the 'health check resource group' is name of a 'health check tool'. .e.g A file named 'tcpip' will be added in /install/healthcheck/ and it offers the checking for sub resources like 'dns', 'http', 'ib'.</p>
<h3 id="syntax-of-xhealthcheck"><a href="#TOC">Syntax of xhealthcheck</a></h3>
<pre><code>    xhealthcheck -h | -v
    xhealthcheck -d 
         Display all the available check resources which have been installed in /install/healthcheck
    xhealthcheck {noderange} g1@r1 g1@r2 g2@r1 g3
         if just specifying a group name, all the resources in the group will be run.
    xhealthcheck {noderange} g1@r1=paramlist g3=paramlist
         The paramlist is a string which separated by &#39;,&#39;
    xhealthcheck {noderange} -f check_src_file
         the check_src_file contains the list of check resources
    The {noderange} here is optional, that means you could ignore the {noderange} if you want to run the check on xCAT MN and SN.</code></pre>
<h3 id="the-general-interface-for-dohealthcheck"><a href="#TOC">The General Interface for dohealthcheck</a></h3>
<p>The json format will be used. This is also the interface that is used to offer functions for external UI.</p>
<ul>
<li><p>Input Interface:</p>
<p>[<br /> { # to make every check to be an element of array so that to control the running order of health check group1: { globalparam: [p1, p2, ...], resource1: { param: [p1, p2, ...], } }, }, { check2 ... }, ]</p></li>
<li><p>Output Interface:</p>
<p>{ group1:{ resource1: { errorcode: 1, error: &quot;errormessage&quot;, returncode: &quot;0 - OK, 1 - Warning, 2 - Error ...&quot;, message: &quot;return message&quot;, } }, }</p></li>
</ul>
<h3 id="the-interface-for-each-healthcheck-tool"><a href="#TOC">The interface for each healthcheck tool</a></h3>
<ul>
<li>The tool can be any binary or scripts which can be run on an Operating System directly; (shell, python, peel, binary)</li>
<li>The tool must have executable permission;</li>
<li>The tool must be installed to /install/healthcheck directory before running the xhealthcheck command;</li>
<li><p>The tool must check the level of Operating System which it is running on. If it cannot run on the OS, return the error message like following:</p>
<p>{errorcode: xx, error: &lt;Cannot run on the operating system.&gt;}</p></li>
<li><p>The interface of tool:</p></li>
<li><p>Support the option -d</p>
<p>display all the check resources.</p></li>
<li>intput</li>
<li><p>output</p></li>
</ul>
<h2 id="implementation"><a href="#TOC">Implementation</a></h2>
<h3 id="inside-of-xhealthcheck"><a href="#TOC">Inside of xhealthcheck</a></h3>
<p>The inside code logic of xhealthcheck:</p>
<ul>
<li><p>1. Check the 'health check resource' have been installed in /install/healthcheck</p></li>
<li><p>1.1 If the 'health check resource' name is 'tcpip@dns', check the existence of '/install/healthcheck/tcpip' first. Then call '/install/healthcheck/tcpip -r' to see whether it can handle 'tcpip@dns'</p></li>
<li><p>2. Check the /install/healthcheck/hcsrc.tar.gz is up to date, otherwise create it. Or recreate it when there's 'health check tool' changed (or new file added):</p></li>
<li>2.1 create it by tar all the files in /install/healthcheck except hc.checksum</li>
<li><p>2.2 regenerate the /install/healcheck/hc.checksum</p>
<p>Run 'ls -l /install/healthcheck' and sort the output to a string and put it in /install/healcheck/hc.checksum.</p></li>
<li><p>2.3 How to test whether there's file change in /install/healthcheck/?</p></li>
</ul>
<p>If the new generated 'check sum string' is not same with the /install/healthcheck/hc.checksum, that means there was file change.</p>
<ul>
<li>3. xdcp /install/healthcheck/hcsrc.tar.gz to all the target nodes at /tmp/xcat/. (This should be done by rsync so that we don't need to transmit it in every running of xhealthcheck)</li>
<li><p>4. Run xdsh {noderange} -e /opt/xcat/sbin/dohealthcheck &lt;paramlist&gt;</p>
<p>The &lt;paramlist&gt; is a json formated string. Refer to the input json format. The output format also needs follow the format in the output json format.</p></li>
<li><p>5. parse the jason format and display the result.</p></li>
</ul>
<p>Note: Consider the run of healthcheck from a Web GUI:</p>
<p>Note: steps 2, 3, 4 are not necessary if you want to run check on xCAT MN/SN (miss the {noderange} when calling xhealthcheck)</p>
<h3 id="inside-of-dohealthcheck"><a href="#TOC">Inside of dohealthcheck</a></h3>
<ul>
<li>1. Find the /tmp/xcat/hcsrc.tar.gz</li>
<li>2. tar out the files from /tmp/xcat/hcsrc.tar.gz to /tmp/xcat/healthcheck/</li>
<li><p>3. Parse the health check parameters to get a run list</p>
<p>g1@r1 &lt;param&gt; g1@r2 &lt;param&gt; g2 &lt;param&gt;</p></li>
<li><p>4. Run each entry in the run list</p>
<p>use the group name like 'g1' to get the file name of 'healtch check tool' run it as g1 -r r1 -p &lt;param&gt;</p></li>
<li><p>5. Parse the output of each check resource and generate the json output, and send back to xcat mn</p></li>
</ul>
<h2 id="check-scenarios"><a href="#TOC">Check Scenarios</a></h2>
<ul>
<li><p>Local run:</p>
<p>Run on xCAT MN or SN</p></li>
<li><p>Compute node run:</p>
<p>Run directly on compute node.</p></li>
<li><p>Cross run:</p>
<p>The target node is n1, but n1 need access n2 to finish the check</p></li>
<li><p>Hierarchy run</p>
<p>Run on MN, but need run sub resource on compute node</p></li>
</ul>
<h2 id="more-consideration"><a href="#TOC">More consideration</a></h2>
<p>1. Run resource on one node in parallel</p>
</body>
</html>
