<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#introduction-scalable-user-authentication-with-ldap">Introduction: Scalable User Authentication with LDAP</a><ul>
<li><a href="#ldap-installation-requirements">LDAP Installation Requirements</a></li>
</ul></li>
<li><a href="#setup-ldap-on-primary-server">Setup LDAP on Primary Server</a><ul>
<li><a href="#install-ldap">Install LDAP</a></li>
<li><a href="#configure-ldap-on-the-primary-server"><strong>Configure LDAP on the Primary Server</strong></a><ul>
<li><a href="#edit-etcopenldapldap.conf"><strong>Edit /etc/openldap/ldap.conf</strong></a></li>
<li><a href="#setup-ldap-tuning-options"><strong>Setup LDAP tuning options</strong></a></li>
<li><a href="#start-ldap-on-the-primary-server">Start LDAP on the Primary Server</a></li>
<li><a href="#migrate-users-on-the-master-node-into-ldap"><strong>Migrate Users on the Master Node into LDAP</strong></a></li>
<li><a href="#add-a-user-to-ldap">Add a User to LDAP</a></li>
<li><a href="#modify-a-user-in-ldap"><strong>Modify a User in LDAP</strong></a></li>
<li><a href="#set-ldap-userid-password">Set LDAP Userid Password</a></li>
</ul></li>
</ul></li>
<li><a href="#setup-hierarchical-ldap">Setup Hierarchical LDAP</a><ul>
<li><a href="#setup-service-nodes-as-ldap-shadow-server"><strong>Setup Service node(s) as LDAP Shadow Server</strong></a><ul>
<li><a href="#install-required-ldap-rpms-and-dependencies"><strong>Install required LDAP rpms and dependencies</strong></a></li>
<li><a href="#update-the-ldap-configuration-in-service-node-image"><strong>Update the LDAP Configuration in Service Node image</strong></a><ul>
<li><a href="#edit-etcopenldapldap.conf-1"><strong>Edit /etc/openldap/ldap.conf</strong></a></li>
<li><a href="#edit-slapd-configuration-file"><strong>Edit slapd configuration file</strong></a></li>
<li><a href="#edit-etcldap.conf"><strong>Edit /etc/ldap.conf</strong></a></li>
<li><a href="#edit-etcnsswitch"><strong>Edit /etc/nsswitch</strong></a></li>
<li><a href="#setup-user-password-authentication"><strong>Setup user password authentication</strong></a></li>
<li><a href="#setup-ldap-tuning-options-1"><strong>Setup LDAP tuning options</strong></a></li>
</ul></li>
<li><a href="#build-the-service-node-diskless-image-and-install"><strong>Build the Service Node diskless image and install</strong></a></li>
<li><a href="#install-the-service-node-diskfull"><strong>Install the Service Node diskfull</strong></a></li>
<li><a href="#test-the-shadow-server"><strong>Test the Shadow Server</strong></a></li>
</ul></li>
</ul></li>
<li><a href="#setup-ldap-client">Setup LDAP Client</a><ul>
<li><a href="#setup-ldap-on-the-compute-nodes">Setup LDAP on the Compute Nodes</a></li>
<li><a href="#update-the-ldap-configuration">Update the LDAP Configuration</a><ul>
<li><a href="#update-etcopenldapldap.conf">Update /etc/openldap/ldap.conf</a></li>
<li><a href="#update-etcldap.conf">Update /etc/ldap.conf</a></li>
<li><a href="#update-etcnsswitch">Update /etc/nsswitch</a></li>
<li><a href="#setup-user-password-authentication-with-ldap">Setup user password authentication with LDAP</a></li>
</ul></li>
<li><a href="#install-and-test">Install and test</a><ul>
<li><a href="#test-ldap-client">Test LDAP Client</a></li>
</ul></li>
</ul></li>
<li><a href="#other-documentation-available">Other Documentation Available</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#introduction-scalable-user-authentication-with-ldap">Introduction: Scalable User Authentication with LDAP</a></li>
<li><a href="#ldap-installation-requirements">LDAP Installation Requirements</a></li>
<li><a href="#setup-ldap-on-primary-server">Setup LDAP on Primary Server</a></li>
<li><a href="#install-ldap">Install LDAP</a></li>
<li><a href="#configure-ldap-on-the-primary-server"><strong>Configure LDAP on the Primary Server</strong></a>
<ul>
<li><a href="#edit-etcopenldapldapconf"><strong>Edit /etc/openldap/ldap.conf</strong></a></li>
<li><a href="#setup-ldap-tuning-options"><strong>Setup LDAP tuning options</strong></a></li>
<li><a href="#start-ldap-on-the-primary-server">Start LDAP on the Primary Server</a></li>
<li><a href="#migrate-users-on-the-master-node-into-ldap"><strong>Migrate Users on the Master Node into LDAP</strong></a></li>
<li><a href="#add-a-user-to-ldap">Add a User to LDAP</a></li>
<li><a href="#modify-a-user-in-ldap"><strong>Modify a User in LDAP</strong></a></li>
<li><a href="#set-ldap-userid-password">Set LDAP Userid Password</a></li>
</ul></li>
<li><a href="#setup-hierarchical-ldap">Setup Hierarchical LDAP</a></li>
<li><a href="#setup-service-nodes-as-ldap-shadow-server"><strong>Setup Service node(s) as LDAP Shadow Server</strong></a>
<ul>
<li><a href="#install-required-ldap-rpms-and-dependencies"><strong>Install required LDAP rpms and dependencies</strong></a></li>
<li><a href="#update-the-ldap-configuration-in-service-node-image"><strong>Update the LDAP Configuration in Service Node image</strong></a></li>
<li><a href="#edit-etcopenldapldapconf-1"><strong>Edit /etc/openldap/ldap.conf</strong></a></li>
<li><a href="#edit-slapd-configuration-file"><strong>Edit slapd configuration file</strong></a></li>
<li><a href="#edit-etcldapconf"><strong>Edit /etc/ldap.conf</strong></a></li>
<li><a href="#edit-etcnsswitch"><strong>Edit /etc/nsswitch</strong></a></li>
<li><a href="#setup-user-password-authentication"><strong>Setup user password authentication</strong></a></li>
<li><a href="#setup-ldap-tuning-options-1"><strong>Setup LDAP tuning options</strong></a></li>
<li><a href="#build-the-service-node-diskless-image-and-install"><strong>Build the Service Node diskless image and install</strong></a></li>
<li><a href="#install-the-service-node-diskfull"><strong>Install the Service Node diskfull</strong></a></li>
<li><a href="#test-the-shadow-server"><strong>Test the Shadow Server</strong></a></li>
</ul></li>
<li><a href="#setup-ldap-client">Setup LDAP Client</a>
<ul>
<li><a href="#setup-ldap-on-the-compute-nodes">Setup LDAP on the Compute Nodes</a></li>
<li><a href="#update-the-ldap-configuration">Update the LDAP Configuration</a></li>
<li><a href="#update-etcopenldapldapconf">Update /etc/openldap/ldap.conf</a></li>
<li><a href="#update-etcldapconf">Update /etc/ldap.conf</a></li>
<li><a href="#update-etcnsswitch">Update /etc/nsswitch</a></li>
<li><a href="#setup-user-password-authentication-with-ldap">Setup user password authentication with LDAP</a></li>
</ul></li>
<li><a href="#install-and-test">Install and test</a>
<ul>
<li><a href="#test-ldap-client">Test LDAP Client</a></li>
</ul></li>
<li><a href="#other-documentation-available">Other Documentation Available</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><strong>Warning: This doc is out of date and needs to be updated. Any help would be appreciated.</strong></p>
<h2 id="introduction-scalable-user-authentication-with-ldap"><a href="#TOC">Introduction: Scalable User Authentication with LDAP</a></h2>
<p><strong>WARNING</strong>: LDAP security is not addressed. Consult your local LDAP expert (or become one). At a minimum consider hosts.allow and hosts.deny. LDAP performance is not addressed. You may need to investigate LDAP setup options for performance enhancements.</p>
<p><strong>NOTE</strong>: If you really want to understand LDAP, then pick up the text <em>Mastering OpenLDAP</em>, by Matt Butcher.</p>
<p><strong>NOTE:</strong> root and non-root userids that will be used to run xCAT commands cannot be managed by LDAP. They must be in /etc/passwd.</p>
<p>LDAP is a client/server directory service that can be used to distribute just about anything of interest. In the case of authentication we are only concerned about users, groups, and passwords.</p>
<p>LDAP may be configured as flat (one-to-many), i.e. all LDAP clients will use the same LDAP server. Or, LDAP may be configured as hierarchical (one-to-many, many-to-many), i.e. all LDAP clients can use the primary LDAP server or a shadow (replicated) LDAP server. The 2nd option increases scalability.</p>
<p>Throughout this document the primary LDAP server will be referred to as the <em>management</em> node. Shadow (or replication) LDAP servers will be referred to as <em>service</em> nodes. All LDAP client nodes will be referred to as <em>compute</em>, <em>user</em>, or <em>head</em> nodes.</p>
<p>There are four configuration files that need to be maintained (not all nodes need all configuration files):</p>
<ul>
<li>/etc/ldap.conf: This LDAP configuration file is used only by nodes that require user (not root) authentication, i.e. <em>compute</em>, <em>user</em>, and <em>head</em> nodes. Do not setup users on nodes that users should not be on, i.e. <em>management</em> and <em>service</em> nodes.</li>
<li>/etc/openldap/ldap.conf: This LDAP configuration file is used by the ldap* client commands, e.g. ldapsearch, ldappasswd, etc. All nodes should have this setup for testing and troubleshooting.</li>
<li>/etc/openldap/slapd.conf: This LDAP configuration file is used by nodes that need to provide LDAP services to clients, i.e. <em>management</em> and <em>service</em> nodes.</li>
<li>/etc/nsswitch. This system configuration file is used by anything that needs to resolve users, groups, or passwords, i.e. authentication, direction listings, etc... This file should only be setup on nodes that will need to resolve user information (e.g. username from user ID). More on this later.</li>
</ul>
<h3 id="ldap-installation-requirements"><a href="#TOC">LDAP Installation Requirements</a></h3>
<p>All nodes should have the LDAP clients installed (i.e. the ldap* commands):</p>
<pre><code>  openldap-clients-*</code></pre>
<p>Only the management and service nodes need to have the LDAP servers installed: openldap-*</p>
<pre><code>   openldap-servers-*</code></pre>
<p>NSS support for LDAP should only be installed on nodes that require user, group, and password name services (e.g. <em>compute</em>, <em>user</em>, <em>head</em>, and <em>login</em> nodes):</p>
<pre><code>nss_ldap-*</code></pre>
<p><strong>NOTE</strong>: You may wish or find it easier to install all the RPMs on all nodes and then configure them properly.</p>
<h2 id="setup-ldap-on-primary-server"><a href="#TOC">Setup LDAP on Primary Server</a></h2>
<h3 id="install-ldap"><a href="#TOC">Install LDAP</a></h3>
<pre><code>yum install openldap-servers</code></pre>
<p>or download from:</p>
<pre><code> &amp;lt;http://download.fedora.redhat.com/pub/fedora/linux/releases/8/Everything/x86_64/os/Packages/&amp;gt;</code></pre>
<p>The following rpms should be installed:</p>
<pre><code>openldap-*
openldap-devel-*
openldap-clients-*
openldap-servers-*


**If using LDAP 2.4  also install:**


migrationtools-*</code></pre>
<h3 id="configure-ldap-on-the-primary-server"><a href="#TOC"><strong>Configure LDAP on the Primary Server</strong></a></h3>
<p>Throughout this document the LDAP suffix <strong>dc=cluster,dc=net</strong> will be used. You can use any value you like. The convention is to match your domain name. e.g. foo.bar.org becomes dc=foo,dc=bar,dc=org.</p>
<p>All nodes should have /etc/openldap/ldap.conf defined. This LDAP client configuration file tells the ldap* commands what node is the LDAP server. This file requires the following two lines:</p>
<pre><code>BASE dc=**cluster**,dc=**net**
URI ldap://ldap_server_hostname</code></pre>
<p>The BASE is the default suffix and the URI is the location of the LDAP server.</p>
<p>**For nodes that run as LDAP servers **(e.g. service and management) then URI should be set to 'ldap://127.0.0.1'. This setup will aid with troubleshooting server problems, i.e. if you cannot talk to yourself, then nobody can talk to your either.</p>
<p><strong>For client nodes</strong> the URI should be point to a service or management node. For our example, our management node is mn20, our service node is rrra000: 'ldap://mn20 ldap://mn20'.</p>
<h4 id="edit-etcopenldapldap.conf"><a href="#TOC"><strong>Edit /etc/openldap/ldap.conf</strong></a></h4>
<p>On LDAP primary Server or master node , edit /etc/openldap/ldap.conf as follows:</p>
<pre><code>BASE **dc=cluster,dc=net**
URI ldap://127.0.0.1</code></pre>
<p>Backup /etc/openldap/slapd.conf.</p>
<pre><code>cp /etc/openldap/slapd.conf  /etc/openldap/slapd.conf.ORIG</code></pre>
<p>The following /etc/openldap/slapd.conf is a good base for the LDAP primary server node, i.e. the node that will manage the LDAP data. Create a new /etc/openldap/slapd.conf file containing the following lines:</p>
<pre><code>include /etc/openldap/schema/core.schema
include /etc/openldap/schema/cosine.schema
include /etc/openldap/schema/inetorgperson.schema
include /etc/openldap/schema/nis.schema
include /etc/openldap/schema/misc.schema
pidfile /var/run/openldap/slapd.pid
argsfile /var/run/openldap/slapd.args
loglevel 0
database hdb
suffix &quot;**dc=cluster,dc=net**&quot;
rootdn &quot;cn=root,**dc=cluster,dc=net**&quot;
rootpw **{SSHA}SHdbpFVBnX7qreNL+DYPsqqlrJWq/W16 **
directory /var/lib/ldap
index objectclass,entryCSN,entryUUID eq,pres
index ou,cn,mail,surname,givenname eq,pres,sub
index uidNumber,gidNumber,loginShell eq,pres
index uid,memberUid eq,pres,sub
password-hash {SSHA}
access to attrs=userPassword
  by dn=&quot;uid=admin,ou=People,**dc=cluster,dc=net**&quot; write
  by anonymous auth
  by self write
  by * none
access to attrs=shadowLastChange
  by dn=&quot;uid=admin,ou=People,**dc=cluster,dc=net**&quot; write
  by self write
  by * read
###sync provider
modulepath /usr/lib64/openldap
moduleload syncprov
overlay syncprov
syncprov-checkpoint 100 10
syncprov-sessionlog 100
###sync</code></pre>
<p>The values in <strong>bold</strong> should be changed to match your environment. With the exception of the LDAP rootpw, the changes are limited to the suffix.</p>
<p>The big picture explanation for this LDAP server configuration file:</p>
<ol style="list-style-type: decimal">
<li>loglevel 0 means log nothing. loglevel 4 will give good debug, loglevel -1 will give all debug</li>
<li>Use the hdb database format and store my stuff in /var/lib/ldap.</li>
<li>Index a bunch of stuff to increase performance.</li>
<li>Declare the LDAP root password using the SSHA hash algorithm. Use the slappasswd command to generate this. e.g. slappasswd prompts for new password and gives encrypted string which is placed in the slapd.conf file for rootpw attribute. Our password is <strong>cluster,</strong> which will be used in later client configuration file and when running ldap commands.<br />[root@xcat20RRmn ~]# slappasswd<br />New password:<br />Re-enter new password:<br />{SSHA}SHdbpFVBnX7qreNL+DYPsqqlrJWq/W16</li>
<li>Allow root to change any password.</li>
<li>Allow users to change their own passwords.</li>
<li>Become a sync provider to allow service nodes to replicate.</li>
</ol>
<p><strong>NOTE</strong>: The lines under access to must be indented. Indented lines in slapd.conf indicate an extension of the previous line.</p>
<p><strong>NOTE</strong>: The last section (sync provider) can be removed if you have no plans to add service nodes to help with large scale-out environments. However it will not hurt to leave it there for future use.</p>
<h4 id="setup-ldap-tuning-options"><a href="#TOC"><strong>Setup LDAP tuning options</strong></a></h4>
<p><strong>For openldap earlier than 2.4:</strong></p>
<pre><code>cp /etc/openldap/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</code></pre>
<p><strong>If using openLDAP 2.4 or later:</strong></p>
<pre><code>vi /var/lib/ldap/DB_CONFIG and add the following lines:


set_cachesize 0 268435456 1
set_lg_regionmax 262144
set_lg_bsize 2097152</code></pre>
<h4 id="start-ldap-on-the-primary-server"><a href="#TOC">Start LDAP on the Primary Server</a></h4>
<p>Make ldap userid id the owner and group for the /var/lib/ldap directory . This is the location of your database and other ldap files.</p>
<pre><code>cd /var/lib
chown ldap.ldap ldap</code></pre>
<p>start ldap to make sure &quot;OK&quot;</p>
<pre><code>service ldap start</code></pre>
<p>Check the syntax of your slapd.conf file</p>
<pre><code>slaptest -v -f /etc/openldap/slapd.conf
_may get hdb_monitor_db_open: monitoring disabled; configure monitor database to enable  - ignore_
config file testing succeeded</code></pre>
<h4 id="migrate-users-on-the-master-node-into-ldap"><a href="#TOC"><strong>Migrate Users on the Master Node into LDAP</strong></a></h4>
<p><strong>The following new user id can be setup for testing the migration</strong></p>
<ul>
<li><p>export /home (rw) for testing</p>
<p>echo '/home *(rw,no_root_squash,sync)' &gt;&gt; /etc/exports exportfs -a</p></li>
<li><p>add a test userid &quot;ibm&quot; which will be added to the LDAP database</p>
<p>useradd ibm mkdir ~ibm/.ssh mkdir ~ibm/.pbs_spool</p></li>
<li><p>Assign a password</p>
<p>passwd ibm</p></li>
<li><p>Generate root ssh keys for mn20 and give ibm id root ssh authority</p>
<p>ssh-keygen -t rsa -q -N &quot;&quot; -f ~ibm/.ssh/id_rsa cp ~ibm/.ssh/id_rsa.pub ~ibm/.ssh/authorized_keys</p>
<p>vi ~ibm/.ssh/config</p></li>
</ul>
<p>Add the following lines:</p>
<pre><code>ForwardX11 yes
StrictHostKeyChecking no
FallBackToRsh no
BatchMode yes
ConnectionAttempts 5
UsePrivilegedPort no
Compression no
Cipher blowfish
UserKnownHostsFile /dev/null
CheckHostIP no</code></pre>
<ul>
<li><p>Set permissions :</p>
<p>chown -R ibm.ibm ~ibm chmod 700 ~ibm/.ssh chmod 600 ~ibm/.ssh/*</p></li>
</ul>
<p>Note: openLDAP 2.4 and above package the migration tools are in the migrationtools* rpm; make sure this is installed. See (UNDEFINED REFERENCE: &quot;1.1.1Install the LDAP rpms &quot;).</p>
<p>For openLDAP 2.4 :</p>
<pre><code>cd /usr/share/migrationtools/migration</code></pre>
<p>For openLDAP 2.3 ( or earlier)</p>
<pre><code> cd /usr/share/openldap/migration</code></pre>
<ul>
<li><p>Migrate :</p>
<p>cp migrate_common.ph migrate_common.ph.save</p></li>
</ul>
<p>Edit migrate_common.ph and change the following lines to be:</p>
<pre><code> vi migrate_common.ph
 $DEFAULT_MAIL_DOMAIN = &quot;cluster.net&quot;;
 $DEFAULT_BASE = &quot;dc=cluster,dc=net&quot;;
 $EXTENDED_SCHEMA = 1;</code></pre>
<p>Run:</p>
<pre><code> ./migrate_base.pl &amp;gt;/tmp/base.ldif
 ./migrate_passwd.pl /etc/passwd &amp;gt;&amp;gt;/tmp/base.ldif
 ./migrate_group.pl /etc/group &amp;gt;&amp;gt;/tmp/base.ldif
 cd /var/lib/ldap
 service ldap stop
 slapadd -l /tmp/base.ldif
 chown ldap.ldap *
service ldap start</code></pre>
<ul>
<li><p>Test the database by searching for a the user ibm:</p>
<p>ldapsearch -x -v -D &quot;cn=root,dc=cluster,dc=net&quot; -w cluster -b &quot;ou=People,dc=cluster,dc=net&quot; &quot;uid=ibm&quot;</p></li>
</ul>
<p>Output should be as follows:</p>
<pre><code> ldap_initialize( &amp;lt;DEFAULT&amp;gt; )
 filter: uid=ibm
 requesting: All userApplication attributes
 # extended LDIF
 #
 # LDAPv3
 # base &amp;lt;ou=People,dc=cluster,dc=net&amp;gt; with scope subtree
 # filter: uid=ibm
 # requesting: ALL
 #
 # ibm, People, cluster.net
  dn: uid=ibm,ou=People,dc=cluster,dc=net
  uid: ibm
  cn: ibm
  sn: ibm
  mail: ibm@cluster.net
  objectClass: person
  objectClass: organizationalPerson
  objectClass: inetOrgPerson
  objectClass: posixAccount
  objectClass: top
  objectClass: shadowAccount
  userPassword:: e2NyeXB0fSEh
  shadowLastChange: 13998
  shadowMax: 99999
  shadowWarning: 7
  loginShell: /bin/bash
  uidNumber: 501
  gidNumber: 501
  homeDirectory: /home/ibm
  # search result
  search: 2
  result: 0 Success
  # numResponses: 2
  # numEntries: 1</code></pre>
<h4 id="add-a-user-to-ldap"><a href="#TOC">Add a User to LDAP</a></h4>
<p>Setup a new user adduser.ldif file with the following contents:</p>
<pre><code>dn: uid=ibm4,ou=People,dc=cluster,dc=net
uid: ibm4
cn: ibm4
sn: ibm4
mail: ibm4@cluster.net
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
shadowLastChange: 13998
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 504
gidNumber: 504
homeDirectory: /home/ibm4  </code></pre>
<p>Run:</p>
<pre><code>ldapadd -x -c -D  &quot;cn=root,dc=cluster,dc=net&quot; -w cluster -f adduser.ldif


adding new entry &quot;uid=ibm4,ou=People,dc=cluster,dc=net&quot;</code></pre>
<p>Verify:</p>
<pre><code>ldapsearch -x -v -D  &quot;cn=root,dc=cluster,dc=net&quot; -w cluster  -b &quot;ou=People,dc=cluster,dc=net&quot; &quot;uid=ibm4&quot;</code></pre>
<h4 id="modify-a-user-in-ldap"><a href="#TOC"><strong>Modify a User in LDAP</strong></a></h4>
<p>Setup a new user moduser.ldif file with the following contents:</p>
<pre><code>dn: uid=ibm4,ou=People,dc=cluster,dc=net
uid: ibm4
cn: ibm4
sn: ibm4
mail: ibm4@cluster.net
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
shadowLastChange: 13998
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 504
gidNumber: 504
homeDirectory: /home/ibm44 &amp;lt;---- modification</code></pre>
<p>Run:</p>
<pre><code>ldapmodify -x -c -D  &quot;cn=root,dc=cluster,dc=net&quot; -w cluster -f moduser.ldif


modifying entry &quot;uid=ibm4,ou=People,dc=cluster,dc=net&quot;</code></pre>
<p>Verify:</p>
<pre><code>ldapsearch -x -v -D  &quot;cn=root,dc=cluster,dc=net&quot; -w cluster  -b &quot;ou=People,dc=cluster,dc=net&quot; &quot;uid=ibm4&quot;</code></pre>
<h4 id="set-ldap-userid-password"><a href="#TOC">Set LDAP Userid Password</a></h4>
<p>Root sets the password to ibm4</p>
<pre><code>ldappasswd -x -w cluster -D &#39;cn=root,dc=cluster,dc=net&#39; -s ibm4 &#39;uid=ibm4,ou=People,dc=cluster,dc=net&#39;
Result: Success (0)</code></pre>
<p>User sets the password to ibm4</p>
<pre><code>ldappasswd -x -w ibm4 -D &#39;uid=ibm4,ou=People,dc=cluster,dc=net&#39; -s ibm4 &#39;uid=ibm4,ou=People,dc=cluster,dc=net&#39;
Result: Success (0)</code></pre>
<h2 id="setup-hierarchical-ldap"><a href="#TOC">Setup Hierarchical LDAP</a></h2>
<p><strong>If you do not plan to use Hierarchical LDAP with shadow LDAP Servers you can skip to</strong> <a href="#setup-ldap-client">Setup LDAP Client</a>.</p>
<p>For Hierarchical LDAP the Service Node(s) will be set as a shadow server(s) to the LDAP Master server on the Master Node. The process will describe putting the configuration changes into the diskless image. If you are using diskfull service nodes, then make the same configuration changes on the installed service nodes.</p>
<h3 id="setup-service-nodes-as-ldap-shadow-server"><a href="#TOC"><strong>Setup Service node(s) as LDAP Shadow Server</strong></a></h3>
<p>The installation and setup of LDAP on the service nodes described below will be either done into the diskless image or on the service node files, if using diskfull installation. For diskfull, you may choose to create the appropriate edited files on the Primary Server in a temporary directory and then xdcp them to the Service node (s), since the files will be the same for all shadow servers.</p>
<h4 id="install-required-ldap-rpms-and-dependencies"><a href="#TOC"><strong>Install required LDAP rpms and dependencies</strong></a></h4>
<p>For diskless install the rpms into the image:</p>
<pre><code>yum --installroot=/install/netboot/fedora8/x86_64/service/rootimg \
     install openldap-clients nss_ldap nfs-utils vi openldap-devel openldap-servers</code></pre>
<p>For diskfull install these same rpms on the service node (s) which will be LDAP shadow servers.</p>
<h4 id="update-the-ldap-configuration-in-service-node-image"><a href="#TOC"><strong>Update the LDAP Configuration in Service Node image</strong></a></h4>
<p>For diskless:</p>
<pre><code> Export SNIMAGE=/install/netboot/fedora8/x86_64/service/rootimg</code></pre>
<h5 id="edit-etcopenldapldap.conf-1"><a href="#TOC"><strong>Edit /etc/openldap/ldap.conf</strong></a></h5>
<p>For diskless:</p>
<pre><code>edit $SNIMAGE/etc/openldap/ldap.conf as follows:
BASE **dc=cluster,dc=net**
URI ldap://127.0.0.1</code></pre>
<p>For diskfull:</p>
<pre><code>edit /etc/openldap/ldap.conf as follows:
BASE **dc=cluster,dc=net**
URI ldap://127.0.0.1</code></pre>
<h5 id="edit-slapd-configuration-file"><a href="#TOC"><strong>Edit slapd configuration file</strong></a></h5>
<p>Backup /etc/openldap/slapd.conf.</p>
<p>For diskless:</p>
<pre><code>Edit $SNIMAGE/etc/openldap/slapd.conf file:</code></pre>
<p>For diskfull:</p>
<pre><code>Edit the /etc/openldap/slapd.conf file:</code></pre>
<p>sldap.conf looks similar to the management or primary LDAP server configuration ( see <a href="#configure-ldap-on-the-primary-server">Configure LDAP on the Primary Server</a>) with access to and sync provider omitted, but with a syncrepl section added:</p>
<pre><code>include /etc/openldap/schema/core.schema
include /etc/openldap/schema/cosine.schema
include /etc/openldap/schema/inetorgperson.schema
include /etc/openldap/schema/nis.schema
include /etc/openldap/schema/misc.schema
pidfile /var/run/openldap/slapd.pid
argsfile /var/run/openldap/slapd.args
loglevel 0
database hdb
suffix &quot;**dc=cluster,dc=net**&quot;
rootdn &quot;cn=root,**dc=cluster,dc=net**&quot;
rootpw **{SSHA}AW/VeGc+5csvRZoayPl+FnRGluxDJyaJ**
directory /var/lib/ldap
index objectclass,entryCSN,entryUUID eq,pres
index ou,cn,mail,surname,givenname eq,pres,sub
index uidNumber,gidNumber,loginShell eq,pres
index uid,memberUid eq,pres,sub
index nisMapName,nisMapEntry eq,pres,sub
password-hash {SSHA}
###sync consumer
syncrepl rid=**NNN**
provider=ldap://**management_node**
type=refreshOnly
interval=**00:00:01:00**
searchbase=&quot;**dc=cluster,dc=net**&quot;
binddn=&quot;cn=root,**dc=cluster,dc=net**&quot;
credentials=**cluster**
###sync consumer</code></pre>
<p>The fields in <strong>bold</strong> should be customized for your environment. Most should be obvious with the exception of credentials and rid. rid should be a unique number per service node. credentials should be the plain text (ouch!) rootpw password. Make sure ldap owns this file and the permissions are 600.</p>
<p>The last two configurations files (/etc/ldap.conf and /etc/nsswitch) go hand-in-hand. Nodes that require user, group, and password name services will need both files setup (e.g. <em>compute, user</em>, <em>head</em>, and <em>login</em> nodes).</p>
<h5 id="edit-etcldap.conf"><a href="#TOC"><strong>Edit /etc/ldap.conf</strong></a></h5>
<p>Edit the $SNIMAGE/etc/ldap.conf file or /etc/ldap.conf for diskfull.</p>
<p>The following ldap.conf should provide anonymous access to <em>ldap_server</em>.</p>
<pre><code>host **ldap_server**
base **dc=cluster,dc=net**
timelimit 120
bind_timelimit 120
idle_timelimit 3600
nss_base_passwd ou=People,**dc=cluster,dc=net**
nss_base_shadow ou=People,**dc=cluster,dc=net**
nss_base_group ou=Group,**dc=cluster,dc=net**
nss_initgroups_ignoreusers  root,ldap,named,avahi,haldaemon,dbus,radvd,tomcat,radiusd,news,mailman,nscd</code></pre>
<p><strong>The fields in bold should be customized for your environment.</strong></p>
<h5 id="edit-etcnsswitch"><a href="#TOC"><strong>Edit /etc/nsswitch</strong></a></h5>
<p>$SNIMAGE/etc/nsswitch or /etc/nsswitch for diskfull should have the following lines updated to include ldap:</p>
<pre><code>passwd: files ldap
shadow: files
group: files ldap</code></pre>
<p>shadow was explicitly skipped. Most cluster environments do not allow users to login to nodes with password authentication. However <em>user</em> and <em>head</em> nodes often allow this.</p>
<h5 id="setup-user-password-authentication"><a href="#TOC"><strong>Setup user password authentication</strong></a></h5>
<p>In the case where you require that users access nodes with password authentication update $SNIMAGE/etc/nsswitch or /etc/nsswitch for diskfull with:</p>
<p>shadow: files ldap</p>
<p>And append to $SNIMAGE/etc/ldap.conf or /etc/ldap.conf for diskfull:</p>
<pre><code>pam_filter objectclass=People
pam_login_attribute uid
pam_lookup_policy yes
pam_password md5</code></pre>
<p>Make ldap userid id the owner and group for the /var/lib/ldap directory</p>
<pre><code>cd $SNIMAGE/var/lib or /var/lib
chown ldap.ldap ldap</code></pre>
<h5 id="setup-ldap-tuning-options-1"><a href="#TOC"><strong>Setup LDAP tuning options</strong></a></h5>
<p>Copy the configuration tuning file into the image or on the Service Node</p>
<pre><code>**For openldap earlier than 2.4:**</code></pre>
<p>For diskless: cp $SNIMAGE/etc/openldap/DB_CONFIG.example $SNIMAGE/var/lib/ldap/DB_CONFIG</p>
<pre><code>For diskfull:
  cp /etc/openldap/DB_CONFIG.example /var/lib/ldap/DB_CONFIG


**If using openLDAP 2.4 or later:**


For diskles:
  vi $SNIMAGE/var/lib/ldap/DB_CONFIG and add the following lines:
For diskfull:
  vi /var/lib/ldap/DB_CONFIG and add the following lines:


set_cachesize 0 268435456 1
set_lg_regionmax 262144
set_lg_bsize 2097152</code></pre>
<h4 id="build-the-service-node-diskless-image-and-install"><a href="#TOC"><strong>Build the Service Node diskless image and install</strong></a></h4>
<p>Set to start LDAP in the servicenode table after install , if not already set.</p>
<pre><code>chtab node=service servicenode.ldapserver=1





cd /opt/xcat/share/xcat/netboot/fedora
./geninitrd -i eth0 -n tg3,bnx2,sunrpc,lockd,nfs,nfs_acl -o fedora8 -p service


nodeset rra000 netboot
rpower rra000 boot</code></pre>
<h4 id="install-the-service-node-diskfull"><a href="#TOC"><strong>Install the Service Node diskfull</strong></a></h4>
<p>Set to start LDAP in the servicenode table after install , if not already set.</p>
<pre><code>chtab node=service servicenode.ldapserver=1





nodeset rra000 install
rpower rra000 reset</code></pre>
<h4 id="test-the-shadow-server"><a href="#TOC"><strong>Test the Shadow Server</strong></a></h4>
<p>Add a userid ( e.g. Ibm6) to the database on the Master Node:</p>
<p>See section <a href="#add-a-user-to-ldap">Add a User to LDAP</a>.</p>
<p>Go to the Service Node and search the database for the new user id.</p>
<p>Run:</p>
<pre><code>ldapsearch -x -v -D  &quot;cn=root,dc=cluster,dc=net&quot; -w cluster  -b &quot;ou=People,dc=cluster,dc=net&quot; &quot;uid=ibm6&quot;</code></pre>
<h2 id="setup-ldap-client"><a href="#TOC">Setup LDAP Client</a></h2>
<h4 id="setup-ldap-on-the-compute-nodes"><a href="#TOC">Setup LDAP on the Compute Nodes</a></h4>
<p>Note: if using diskless image the LDAP this setup will be added the configuration file changes needed to that image before the install. If the compute nodes are diskfull, just add the changes to the LDAP configuration files on the installed node. For example, you can create an updated LDAP configuration file in a tmp space on the Management Node and then xdcp it to all the diskfull nodes.</p>
<p>All nodes should have the LDAP clients installed (i.e. the ldap* commands):</p>
<pre><code>openldap-clients-*</code></pre>
<p>NSS support for LDAP should only be installed on nodes that require user, group, and password name services (e.g. <em>compute</em>, <em>user</em>, <em>head</em>, and <em>login</em> nodes):</p>
<pre><code>nss_ldap-*</code></pre>
<p><strong>NOTE</strong>: The lazy (or efficient) may wish to install all the RPMs on all nodes and then configure them properly.</p>
<p>For diskless, install need ldap rpms and dependencies into the image:</p>
<pre><code>yum --installroot=/install/netboot/fedora8/x86_64/compute/rootimg \
        install openldap-clients nss_ldap nfs-utils vi</code></pre>
<p>For diskfull, install additional rpms on the compute nodes.</p>
<h4 id="update-the-ldap-configuration"><a href="#TOC">Update the LDAP Configuration</a></h4>
<p>For diskless:</p>
<p>export CPIMAGE=/install/netboot/fedora8/x86_64/compute/rootimg</p>
<pre><code>cd $CPIMAGE/etc/openldap</code></pre>
<p>For diskfull:</p>
<pre><code>cd /etc/openldap</code></pre>
<p><strong>Note: there are two files /etc/ldap.conf and /etc/openldap/ldap.conf to edit</strong></p>
<h5 id="update-etcopenldapldap.conf"><a href="#TOC">Update /etc/openldap/ldap.conf</a></h5>
<p>**All nodes <strong>should have</strong> /etc/openldap/ldap.conf *<em>defined or $CPIMAGE/etc/openldap/ldap.conf if diskless. This LDAP client configuration file tells the ldap</em> commands what LDAP server to communicate with. This file requires the following two lines:</p>
<p>If non-hierarchical:</p>
<pre><code>BASE    dc=cluster,dc=net
URI     ldap://mn20</code></pre>
<p>If hierarchical:</p>
<pre><code>BASE    dc=cluster,dc=net
URI     ldap://rra000 </code></pre>
<p>The BASE is the default suffix and the URI is the location of the LDAP server. In our example the server is mn20. For client nodes the URI should be point to a management node or the service node of the client, if using hierarchy.</p>
<h5 id="update-etcldap.conf"><a href="#TOC">Update /etc/ldap.conf</a></h5>
<p>The last two configurations files (/etc/ldap.conf and /etc/nsswitch) go hand-in-hand. Nodes that require user, group, and password name services will need both files setup (e.g. compute, user, head, and login nodes).</p>
<p>The following /etc/ldap.conf should provide anonymous access to <em>ldap_server</em>. This is sufficient, if using hierarchical xCAT support for LDAP and the Service Node is setup as a shadow server with anonymous access to the LDAP server. See <a href="#setup-hierarchical-ldap">Setup Hierarchical LDAP</a>.</p>
<p>If diskless:</p>
<p>Create $CPIMAGE/etc/ldap.conf with the following lines:</p>
<p>If diskfull</p>
<p>Create /etc/ldap.conf with the following lines:</p>
<p>host <strong>&lt;management_node or Service node&gt;</strong></p>
<p>base <strong>dc=cluster,dc=net</strong></p>
<p>timelimit 120</p>
<p>bind_timelimit 120</p>
<p>idle_timelimit 3600</p>
<p>nss_base_passwd ou=People,<strong>dc=cluster,dc=net</strong></p>
<p>nss_base_shadow ou=People,<strong>dc=cluster,dc=net</strong></p>
<p>nss_base_group ou=Group,<strong>dc=cluster,dc=net</strong></p>
<p>nss_initgroups_ignoreusers root,ldap,named,avahi,haldaemon,dbus,radvd,tomcat,radiusd,news,mailman,nscd</p>
<p>**But if you are not using a Service Node with anonymous access ,that is the nodes use the management node for LDAP the following lines should also be be added to /etc/ldap.conf or $CPIMAGE/etc/ldap.conf for diskless. **</p>
<p>binddn cn=root,<strong>dc=cluster,dc=net</strong></p>
<p>bindpw <strong>cluster</strong></p>
<p>rootbinddn <strong>cn=root,dc=cluster,dc=net</strong></p>
<p>This is because the management node setup above is not setup for anonymous access. The service node setup for anonymous access because it is read-only replica of the management node. The fields in <strong>bold</strong> should be customized for your environment.</p>
<h5 id="update-etcnsswitch"><a href="#TOC">Update /etc/nsswitch</a></h5>
<p>Last but not least /etc/nsswitch or $CPIMAGE/etc/nsswitch should have the following lines updated to include ldap:</p>
<p>passwd: files ldap</p>
<p>shadow: files</p>
<p>group: files ldap</p>
<p>shadow was explicitly skipped. Most cluster environments do not allow users to login to nodes with password authentication. However <em>user</em> and <em>head</em> nodes often allow this.</p>
<h5 id="setup-user-password-authentication-with-ldap"><a href="#TOC">Setup user password authentication with LDAP</a></h5>
<p>In the case where you require that users access nodes with password authentication then update /etc/nsswitch on the node or in the image with:</p>
<p>shadow: files ldap</p>
<p>And append to /etc/ldap.conf:</p>
<p>pam_filter objectclass=People</p>
<p>pam_login_attribute uid</p>
<p>pam_lookup_policy yes</p>
<p>pam_password md5</p>
<p><strong>Add to fstab to Mount /home for testing:</strong></p>
<pre><code>mn20:/home /home nfs timeo=14,intr 1 2</code></pre>
<h3 id="install-and-test"><a href="#TOC">Install and test</a></h3>
<p>Add the following rpms for testing. Note: the order of modules in the geninitrd command is important!</p>
<pre><code>bnx2,sunrpc,lockd,nfs,nfs_acl</code></pre>
<p>If using diskless:</p>
<pre><code>cd /opt/xcat/share/xcat/netboot/fedora
./geninitrd -i eth0 -n tg3,bnx2,sunrpc,lockd,nfs,nfs_acl -o fedora8 -p compute
packimage -o fedora8 -p compute -a x86_64
nodeset rra001a netboot
rpower rra001a boot</code></pre>
<p>If diskfull:</p>
<pre><code>  nodesetup rra0001a install
  rpower rra001a reset</code></pre>
<h4 id="test-ldap-client"><a href="#TOC">Test LDAP Client</a></h4>
<pre><code>ssh to rra001a</code></pre>
<p>Run:</p>
<pre><code>ldapsearch -x -v -D  &quot;cn=root,dc=cluster,dc=net&quot; -w cluster  -b &quot;ou=People,dc=cluster,dc=net&quot; &quot;uid=ibm&quot;</code></pre>
<p>Check to see if you get output from the LDAP server as in section <a href="#migrate-users-on-the-master-node-into-ldap">Migrate Users on the Master Node into LDAP</a>.</p>
<p>Now authenticate the ibm users from LDAP by changing it's password and su to ibm.</p>
<pre><code>passwd ibm
su - ibm</code></pre>
<h2 id="other-documentation-available"><a href="#TOC">Other Documentation Available</a></h2>
<ul>
<li>xCAT man pages: &lt;http://xcat.sf.net/man1/xcat.1.html&gt;</li>
<li>xCAT DB table descriptions: &lt;http://xcat.sf.net/man5/xcatdb.5.html&gt;</li>
<li>xCAT wiki: &lt;http://xcat.wiki.sourceforge.net/&gt;</li>
<li>xCAT mailing list: &lt;http://xcat.org/mailman/listinfo/xcat-user&gt;</li>
<li>xCAT bugs: <a href="https://sourceforge.net/tracker/?group_id=208749&amp;atid=1006945">https://sourceforge.net/tracker/?group_id=208749&amp;atid=1006945</a></li>
<li>xCAT feature requests: <a href="https://sourceforge.net/tracker/?group_id=208749&amp;atid=1006948">https://sourceforge.net/tracker/?group_id=208749&amp;atid=1006948</a></li>
<li>Mastering <em>OpenLDAP</em>, by Matt Butcher.</li>
</ul>
</body>
</html>
