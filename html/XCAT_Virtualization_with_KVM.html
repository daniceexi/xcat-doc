<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-example-used-thoughout-this-document">The Example Used Thoughout This Document</a></li>
<li><a href="#set-up-the-management-server-for-kvm">Set Up the Management Server for KVM</a><ul>
<li><a href="#check-the-ability-of-the-kvm-hypervisor-node"><strong>Check the ability of the kvm hypervisor node</strong></a></li>
<li><a href="#set-up-the-kvm-storage-directory-on-the-management-node"><strong>Set Up the kvm storage directory on the management node</strong></a></li>
<li><a href="#export-the-storage-directory"><strong>Export the storage directory</strong></a></li>
<li><a href="#install-the-kvm-related-packages"><strong>Install the kvm related packages</strong></a></li>
</ul></li>
<li><a href="#install-the-kvm-hypervisor"><strong>Install the kvm hypervisor</strong></a><ul>
<li><a href="#add-the-kvm-related-packages"><strong>Add the kvm related packages</strong></a></li>
<li><a href="#add-a-postscript-to-create-network-bridge-on-the-kvm-host"><strong>Add a postscript to create network bridge on the kvm host</strong></a></li>
<li><a href="#export-shared-directory-optional-you-can-work-around-it-if-you-create-the-images-by-yourself"><strong>Export shared directory (Optional, you can work around it if you create the images by yourself)</strong></a></li>
<li><a href="#install-the-kvm-hypervisor-node"><strong>Install the kvm hypervisor node</strong></a></li>
</ul></li>
<li><a href="#enable-the-kvm-hypervisor-on-an-existed-node.-e.g.-on-redhat-6-node">Enable the kvm hypervisor on an existed node. (e.g. on redhat 6 node)</a><ul>
<li><a href="#install-the-perl-sys-virt-on-the-management-node-mn1"><strong>Install the perl-Sys-Virt on the management node mn</strong>1</a></li>
<li><a href="#install-the-libvirt-and-qemu-kvm-on-the-target-node-kvmhost1"><strong>Install the libvirt and qemu-kvm on the target node kvmhost</strong>1</a></li>
<li><a href="#rerun-the-postscript-mkhyperv-from-the-management-node-to-setup-the-kvm-host"><strong>Rerun the postscript mkhyperv from the management node to setup the kvm host</strong></a></li>
</ul></li>
<li><a href="#create-and-install-virtual-machines">Create and Install Virtual Machines</a><ul>
<li><a href="#define-virtual-machines"><strong>Define virtual machines</strong></a></li>
<li><a href="#define-the-attributes-of-virtual-machine"><strong>Define the attributes of virtual machine</strong></a></li>
<li><a href="#define-the-console-attributes-for-the-virtual-machine"><strong>Define the console attributes for the virtual machine</strong></a></li>
</ul></li>
<li><a href="#in-the-end-the-definition-of-kvm1-should-look-more-or-less-like-this">In the end, the definition of kvm1 should look (more or less) like this</a><ul>
<li><a href="#create-the-virtual-machine"><strong>Create the virtual machine</strong></a></li>
<li><a href="#try-to-power-on-the-kvm1"><strong>Try to power on the kvm1</strong></a></li>
<li><a href="#remove-a-virtual-machine-optional"><strong>Remove a virtual machine (Optional)</strong></a></li>
<li><a href="#you-are-able-to-look-at-the-node-in-rconswcons"><strong>You are able to look at the node in rcons/wcons</strong></a></li>
</ul></li>
<li><a href="#installing-the-virtual-machine-kvm1"><strong>Installing the virtual machine kvm1</strong></a></li>
<li><a href="#connecting-to-the-virtual-machines-vnc-console"><strong>Connecting to the virtual machine's vnc console</strong></a></li>
<li><a href="#setting-up-a-network-bridge"><strong>Setting up a network bridge</strong></a></li>
<li><a href="#clone-a-kvm-node"><strong>Clone a kvm node</strong></a><ul>
<li><a href="#in-attaching-mode"><strong>In attaching mode</strong></a></li>
<li><a href="#in-detaching-mode"><strong>In detaching mode</strong></a></li>
</ul></li>
<li><a href="#faq">FAQ</a><ul>
<li><a href="#libvirtd-run-into-problem"><strong>libvirtd run into problem</strong></a></li>
<li><a href="#virtual-disk-has-problem"><strong>Virtual disk has problem</strong></a></li>
<li><a href="#vnc-client-complains-the-credentials-are-not-valid"><strong>VNC client complains the credentials are not valid</strong></a></li>
<li><a href="#rpower-fails-with-qemu-could-not-open-disk-image-varlibxcatpools2e66895a-e09a-53d5-74d3-eccdd9746eb5vmxyz.hda.qcow2-permission-denied-error-message"><strong>rpower fails with &quot;qemu: could not open disk image /var/lib/xcat/pools/2e66895a-e09a-53d5-74d3-eccdd9746eb5/vmXYZ.hda.qcow2: Permission denied&quot; error message</strong></a></li>
<li><a href="#error-cannot-communicate-via-libvirt-to-host">** Error: Cannot communicate via libvirt to &lt;host&gt; **</a></li>
<li><a href="#cannot-ping-to-the-vm-after-the-first-boot-of-stateful-install">Cannot ping to the vm after the first boot of stateful install</a></li>
</ul></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-example-used-thoughout-this-document">The Example Used Thoughout This Document</a></li>
<li><a href="#set-up-the-management-server-for-kvm">Set Up the Management Server for KVM</a></li>
<li><a href="#check-the-ability-of-the-kvm-hypervisor-node"><strong>Check the ability of the kvm hypervisor node</strong></a></li>
<li><a href="#set-up-the-kvm-storage-directory-on-the-management-node"><strong>Set Up the kvm storage directory on the management node</strong></a></li>
<li><a href="#export-the-storage-directory"><strong>Export the storage directory</strong></a></li>
<li><a href="#install-the-kvm-related-packages"><strong>Install the kvm related packages</strong></a></li>
<li><a href="#install-the-kvm-hypervisor"><strong>Install the kvm hypervisor</strong></a></li>
<li><a href="#add-the-kvm-related-packages"><strong>Add the kvm related packages</strong></a></li>
<li><a href="#add-a-postscript-to-create-network-bridge-on-the-kvm-host"><strong>Add a postscript to create network bridge on the kvm host</strong></a></li>
<li><a href="#export-shared-directory-optional-you-can-work-around-it-if-you-create-the-images-by-yourself"><strong>Export shared directory (Optional, you can work around it if you create the images by yourself)</strong></a></li>
<li><a href="#install-the-kvm-hypervisor-node"><strong>Install the kvm hypervisor node</strong></a></li>
<li><a href="#enable-the-kvm-hypervisor-on-an-existed-node-eg-on-redhat-6-node">Enable the kvm hypervisor on an existed node. (e.g. on redhat 6 node)</a></li>
<li><a href="#install-the-perl-sys-virt-on-the-management-node-mn1"><strong>Install the perl-Sys-Virt on the management node mn</strong>1</a></li>
<li><a href="#install-the-libvirt-and-qemu-kvm-on-the-target-node-kvmhost1"><strong>Install the libvirt and qemu-kvm on the target node kvmhost</strong>1</a></li>
<li><a href="#rerun-the-postscript-mkhyperv-from-the-management-node-to-setup-the-kvm-host"><strong>Rerun the postscript mkhyperv from the management node to setup the kvm host</strong></a></li>
<li><a href="#create-and-install-virtual-machines">Create and Install Virtual Machines</a></li>
<li><a href="#define-virtual-machines"><strong>Define virtual machines</strong></a></li>
<li><a href="#define-the-attributes-of-virtual-machine"><strong>Define the attributes of virtual machine</strong></a></li>
<li><a href="#define-the-console-attributes-for-the-virtual-machine"><strong>Define the console attributes for the virtual machine</strong></a></li>
<li><a href="#in-the-end-the-definition-of-kvm1-should-look-more-or-less-like-this">In the end, the definition of kvm1 should look (more or less) like this</a></li>
<li><a href="#create-the-virtual-machine"><strong>Create the virtual machine</strong></a></li>
<li><a href="#try-to-power-on-the-kvm1"><strong>Try to power on the kvm1</strong></a></li>
<li><a href="#remove-a-virtual-machine-optional"><strong>Remove a virtual machine (Optional)</strong></a></li>
<li><a href="#you-are-able-to-look-at-the-node-in-rconswcons"><strong>You are able to look at the node in rcons/wcons</strong></a></li>
<li><a href="#installing-the-virtual-machine-kvm1"><strong>Installing the virtual machine kvm1</strong></a></li>
<li><a href="#connecting-to-the-virtual-machines-vnc-console"><strong>Connecting to the virtual machine's vnc console</strong></a></li>
<li><a href="#setting-up-a-network-bridge"><strong>Setting up a network bridge</strong></a></li>
<li><a href="#clone-a-kvm-node"><strong>Clone a kvm node</strong></a></li>
<li><a href="#in-attaching-mode"><strong>In attaching mode</strong></a></li>
<li><a href="#in-detaching-mode"><strong>In detaching mode</strong></a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#libvirtd-run-into-problem"><strong>libvirtd run into problem</strong></a></li>
<li><a href="#virtual-disk-has-problem"><strong>Virtual disk has problem</strong></a></li>
<li><a href="#vnc-client-complains-the-credentials-are-not-valid"><strong>VNC client complains the credentials are not valid</strong></a></li>
<li><a href="#rpower-fails-with-qemu-could-not-open-disk-image-varlibxcatpools2e66895a-e09a-53d5-74d3-eccdd9746eb5vmxyzhdaqcow2-permission-denied-error-message"><strong>rpower fails with &quot;qemu: could not open disk image /var/lib/xcat/pools/2e66895a-e09a-53d5-74d3-eccdd9746eb5/vmXYZ.hda.qcow2: Permission denied&quot; error message</strong></a></li>
<li><a href="#-error-cannot-communicate-via-libvirt-to-&amp;lthost&amp;gt-">** Error: Cannot communicate via libvirt to &lt;host&gt; **</a></li>
<li><a href="#cannot-ping-to-the-vm-after-the-first-boot-of-stateful-install">Cannot ping to the vm after the first boot of stateful install</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<div class="figure">
<img src="http://sourceforge.net/p/xcat/wiki/XCAT_Documentation/attachment/Official-xcat-doc.png" /><p class="caption"></p>
</div>
<h2 id="introduction"><a href="#TOC">Introduction</a></h2>
<p>The Kernel-based Virtual Machine (KVM) is the way forward for virtualization technology for Enterprise Linux distributions. For this reason we recommend KVM over other open source technologies like Xen (Although there is support for Xen in xCAT)</p>
<p>KVM is included in RHEL 6 and SLES 11 (and later versions). <strong>KVM was also available in RHEL 5, but not as stable, so we don't recommend using it in RHEL 5.</strong> KVM is included in the Linux kernel as of 2.6.20 . The xCAT based KVM solution offers users the ability to:</p>
<ul>
<li>provision the hypervisor on bare metal nodes</li>
<li>provision virtual machines</li>
<li>migrate virtual machines to different hosts</li>
<li>install all versions of Linux supported in the standard xCAT provisioning methods (you can install stateless virtual machines, iSCSI, and scripted install virtual machines)</li>
<li>install copy on write instances of virtual machines</li>
<li>copy virtual machines</li>
</ul>
<p>For the best KVM experience with xCAT, use the following components:</p>
<ol style="list-style-type: decimal">
<li>A shared file system for hosting virtual machines. This should be the same directory for all nodes. Having this shared file system (which we recommend be on a SAN, NAS or GPFS) allows xCAT to migrate VMs from one hypervisor to another.</li>
<li>xnba gPXE bootloader and xnba KVM bootloader that comes packaged in the xcat-dep tarball. This has updated KVM support that plugs nicely into xCAT.</li>
</ol>
<h2 id="the-example-used-thoughout-this-document"><a href="#TOC">The Example Used Thoughout This Document</a></h2>
<p>The following example node names are used in the rest of this document:</p>
<ul>
<li>One management node: mn1</li>
<li>One kvm hypervisor machine: kvmhost1 (In this document, &quot;kvm host&quot; and &quot;kvm hypervisor&quot; mean the same thing.)</li>
<li>Virtual machines: kvm1, kvm2 ...</li>
<li>Virtual machine master: kvmm, kvmmd</li>
<li>Operating System: rhel 6 (RHEL 6 has good support for kvm and xCAT has good support for rhel 6 for kvm, so if you have flexibility in your distro choice, we recommended using rhel 6 as the kvm hypervisor.)</li>
</ul>
<h2 id="set-up-the-management-server-for-kvm"><a href="#TOC">Set Up the Management Server for KVM</a></h2>
<h3 id="check-the-ability-of-the-kvm-hypervisor-node"><a href="#TOC"><strong>Check the ability of the kvm hypervisor node</strong></a></h3>
<p>To run KVM you need a newer Intel or AMD processor with virtualization technology. (Intel VT or AMD-V). Run this command on the node to check whether kvm will be supported by the machine. If it has output, that means it has the capability:</p>
<pre><code>    egrep &quot;flags.*:.*(svm|vmx)&quot; /proc/cpuinfo</code></pre>
<h3 id="set-up-the-kvm-storage-directory-on-the-management-node"><a href="#TOC"><strong>Set Up the kvm storage directory on the management node</strong></a></h3>
<p>The easiest method is to use the /install directory as the kvm storage directory and share it via NFS to the hypervisors. That is what we'll do in this example.</p>
<p>Create a directory to store the virtual disk files:</p>
<pre><code>    mkdir -p /install/vms</code></pre>
<h3 id="export-the-storage-directory"><a href="#TOC"><strong>Export the storage directory</strong></a></h3>
<p>Note: make sure the root permission is turned on for the nfs clients (i.e. use the no_root_squash option). Otherwise, the virtual disk file can <strong>not</strong> be used correctly. The option 'fsid=0' is useful for nfsv4:</p>
<pre><code>    echo &quot;/install/vms *(rw,no_root_squash,sync,fsid=0)&quot; &amp;gt;&amp;gt;/etc/exports
    exportfs -r</code></pre>
<h3 id="install-the-kvm-related-packages"><a href="#TOC"><strong>Install the kvm related packages</strong></a></h3>
<p>Additional packages need to be installed on the management node for kvm support:</p>
<pre><code>    yum -y install iscsi-initiator-utils bridge-utils kvm perl-Sys-Virt</code></pre>
<p>For rh5 and CentOS5, make sure that when you install these packages that the kvm is taken from the xCAT dependencies directory instead of from the operating system directory. Make sure that the kvm RPM version is greater than or equal to kvm-85-1.</p>
<h2 id="install-the-kvm-hypervisor"><a href="#TOC"><strong>Install the kvm hypervisor</strong></a></h2>
<p>xCAT distributes some templates for the kvm hypervisor. For Redhat OS, you can get them here: /opt/xcat/share/xcat/install/rh/kvm.* from the management node.</p>
<h3 id="add-the-kvm-related-packages"><a href="#TOC"><strong>Add the kvm related packages</strong></a></h3>
<p>xCAT uses the *.pkglist to specify the packages that need to be installed for a new node. The *.pkglist for the rh6 has already been created at /opt/xcat/share/xcat/install/rh/kvm.rhel6.pkglist. That means if you want to install rh6 as the OS for the kvmhost1, ignore this step.<br />For a specific OS like CentOS, you can create a new .pkglist for it.</p>
<pre><code>    mkdir /install/custom/install/centos/ 
    cp /opt/xcat/share/xcat/install/rh/kvm.pkglist  \
    /install/custom/install/centos/</code></pre>
<p>Add the following packages name in it.</p>
<pre><code>    bridge-utils
    dnsmasq
    iscsi-initiator-utils
    kvm
    perl-Sys-Virt
    libvirt.x86_64
    gpxe-kvm</code></pre>
<p>Note: If some packages need to be installed from the xCAT dependency packages, use the otherpkgs mechanism to install them. Or you can install them manually after the installation.</p>
<h3 id="add-a-postscript-to-create-network-bridge-on-the-kvm-host"><a href="#TOC"><strong>Add a postscript to create network bridge on the kvm host</strong></a></h3>
<p>xCAT supplies a postscript named xHRM (MN:/install/postscript/xHRM) to create the network bridge for the kvm host during the installation or netbooting process. There are several parameters can be passed for this postscript to specify the target network device that the bridge created to.</p>
<p>Add this postscript to your kvm host node:</p>
<ul>
<li>create a bridge with default name 'default' against the installation network device which was specified by 'installnic' attribute</li>
</ul>
<pre><code>    chdef kvmhost1 -p postscripts=&quot;xHRM bridgeprereq&quot;</code></pre>
<ul>
<li>create a bridge named 'virbr0' against the installation network device which was specified by 'installnic' attribute</li>
</ul>
<pre><code>    chdef kvmhost1 -p postscripts=&quot;xHRM bridgeprereq virbr0&quot;</code></pre>
<ul>
<li>create a bridge named 'virbr0' against the network device 'eth0'</li>
</ul>
<pre><code>    chdef kvmhost1 -p postscripts=&quot;xHRM bridgeprereq eth0:virbr0&quot;</code></pre>
<h3 id="export-shared-directory-optional-you-can-work-around-it-if-you-create-the-images-by-yourself"><a href="#TOC"><strong>Export shared directory (Optional, you can work around it if you create the images by yourself)</strong></a></h3>
<p>To run the xCAT commands to create virtual machines, the nodes and the management server require a shared file system viewable in the same directory. An easy way to do this is to create another post install script to mount this directory. We made one and called it mountvms:</p>
<pre><code>    logger -t xcat &quot;Install: setting vms mount in fstab&quot;
    mkdir -p /install/vms
    echo &quot;$MASTER:/install/vms /install/vms nfs \
      rsize=8192,wsize=8192,timeo=14,intr,nfsvers=2 1 2&quot; &gt;&gt; /etc/fstab
</code></pre>
<p>The above script just creates a directory called /install/vms and then mounts this from the management server. If you have a file or another storage device where you want all your virtual machines to go, then you can change the scripts according to your needs.</p>
<pre><code>    chmod 755 mountvms
    chdef x01 -p postscripts=mountvms</code></pre>
<h3 id="install-the-kvm-hypervisor-node"><a href="#TOC"><strong>Install the kvm hypervisor node</strong></a></h3>
<p>Just install it as a common node.</p>
<pre><code>    nodeset kvmhost1 osimage=rhels6.2-x86_64-install-kvm
    rpower kvmhost1 boot</code></pre>
<p>When finished with the node you can ssh to it an verify it was setup correctly by running:</p>
<pre><code># brctl show</code></pre>
<p>then you can get the bridge information like following:</p>
<pre><code>    bridge name     bridge id               STP enabled     interfaces
    br0             8000.001a646002a4       no              eth0</code></pre>
<p>When you run the ifconfig command you'll have a br0 interface:</p>
<pre><code>    ifconfig
    br0 Link encap:Ethernet HWaddr 00:14:5E:55:5B:AC
    inet addr:192.168.15.72 Bcast:192.168.15.255 Mask:255.255.255.0
    inet6 addr: fe80::214:5eff:fe55:5bac/64 Scope:Link
    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
    RX packets:1930 errors:0 dropped:0 overruns:0 frame:0
    TX packets:846 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:0
    RX bytes:166778 (162.8 KiB) TX bytes:95512 (93.2 KiB)
    
    eth0 Link encap:Ethernet HWaddr 00:14:5E:55:5B:AC
    inet6 addr: fe80::214:5eff:fe55:5bac/64 Scope:Link
    UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
    RX packets:5072 errors:0 dropped:0 overruns:0 frame:0
    TX packets:1160 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:1000
    RX bytes:412342 (402.6 KiB) TX bytes:132939 (129.8 KiB)
    Interrupt:66
    
    lo Link encap:Local Loopback
    inet addr:127.0.0.1 Mask:255.0.0.0
    inet6 addr: ::1/128 Scope:Host
    UP LOOPBACK RUNNING MTU:16436 Metric:1
    RX packets:56 errors:0 dropped:0 overruns:0 frame:0
    TX packets:56 errors:0 dropped:0 overruns:0 carrier:0
    collisions:0 txqueuelen:0
    RX bytes:6151 (6.0 KiB) TX bytes:6151 (6.0 KiB)</code></pre>
<p>If you don't have that, it probably that you didn't use the xCAT post install script. You can hack it together quickly by running:</p>
<pre><code>    IPADDR=172.20.1.19/16
    brctl addif vlan1 eth0
    brctl addbr vlan1
    brctl setfd vlan1 0
    ip addr add dev vlan1 $IPADDR
    brctl addif vlan1 eth0
    ip link set vlan1 up
    ip addr del dev eth0 $IPADDR</code></pre>
<p>You also can try to rerun the postscript mkhyperv by updatenode command to fix the kvm hypervisor setup problem.</p>
<pre><code>    updatenode kvmhost1 -P mkhyperv</code></pre>
<h2 id="enable-the-kvm-hypervisor-on-an-existed-node.-e.g.-on-redhat-6-node"><a href="#TOC">Enable the kvm hypervisor on an existed node. (e.g. on redhat 6 node)</a></h2>
<h3 id="install-the-perl-sys-virt-on-the-management-node-mn1"><a href="#TOC"><strong>Install the perl-Sys-Virt on the management node mn</strong>1</a></h3>
<pre><code>    yum install perl-Sys-Virt.x86_64</code></pre>
<h3 id="install-the-libvirt-and-qemu-kvm-on-the-target-node-kvmhost1"><a href="#TOC"><strong>Install the libvirt and qemu-kvm on the target node kvmhost</strong>1</a></h3>
<pre><code>    yum install libvirt.x86_64 qemu-kvm.x86_64</code></pre>
<h3 id="rerun-the-postscript-mkhyperv-from-the-management-node-to-setup-the-kvm-host"><a href="#TOC"><strong>Rerun the postscript mkhyperv from the management node to setup the kvm host</strong></a></h3>
<pre><code>    updatenode kvmhost1 -P mkhyperv</code></pre>
<h2 id="create-and-install-virtual-machines"><a href="#TOC">Create and Install Virtual Machines</a></h2>
<p>After the installing and configuring of kvm hypervisor, you can start to create the virtual machine and deploy OS on it.</p>
<h3 id="define-virtual-machines"><a href="#TOC"><strong>Define virtual machines</strong></a></h3>
<p>The virtual machine kvm1 will be defined. First to add following entry in /etc/hosts:</p>
<pre><code>    192.168.0.10 kvm1</code></pre>
<p>Then add it to xCAT under the vm group:</p>
<pre><code>    nodeadd kvm1 groups=kvm,vm,all</code></pre>
<p>Next, update DNS with this new node:</p>
<pre><code>    
    makedns
    service named restart</code></pre>
<h3 id="define-the-attributes-of-virtual-machine"><a href="#TOC"><strong>Define the attributes of virtual machine</strong></a></h3>
<p>Run the chdef command to change the following attributes for the kvm1:</p>
<ul>
<li>Define the virtual cpu number</li>
</ul>
<pre><code>    chdef kvm1 vmcpus=2 </code></pre>
<ul>
<li>Define the kvm host of the virtual machine kvm1, it should be set to kvmhost1</li>
</ul>
<pre><code>    chdef kvm1 vmhost=kvmhost1 </code></pre>
<ul>
<li>Define the virtual memory size, the unit is Megabit</li>
</ul>
<p>Define 1G memory to the kvm1:</p>
<pre><code>    
    chdef kvm1 vmmemory=1024 </code></pre>
<p>Note: For diskless node, the vmmemory should be set larger than 2048, otherwise the node cannot be booted up.</p>
<ul>
<li>Define the hardware management module</li>
</ul>
<pre><code>    chdef kvm1 mgt=kvm </code></pre>
<ul>
<li>Define the virtual network card, it should be set to the bridge br0/virb0/default which defined above. If no bridge was set explicitly, no network device will be created for the node kvm1</li>
</ul>
<pre><code>     chdef kvm1 vmnics=br0 </code></pre>
<ul>
<li>The vmnicnicmodel attribute is used to set the type and corresponding driver for the nic. If not set, the default value is 'virtio'(xCAT 2.9 and higher) or 'e1000'(Before xCAT 2.9). On certain hypervisors, the default 'e1000' cannot be supported (the network cannot be started during boot) correctly. In this case the 'virtio' is recommended. Since Windows cannot support the driver 'virtio' very well, the 'e1000' is recommended for the vm which the Windows OS will be deployed.</li>
</ul>
<pre><code>     chdef kvm1 vmnicnicmodel=virtio</code></pre>
<ul>
<li>Define the storage for the kvm1</li>
</ul>
<p>Three formats for the storage source are supported:</p>
<p>1. Create storage on a nfs server</p>
<p>The format is 'nfs://&lt;IP&gt;/dir', that means the kvm disk files will be created at 'nfs://&lt;IP&gt;/dir'.</p>
<pre><code>     chdef kvm1 vmstorage=nfs://&amp;lt;IP of nfs server&amp;gt;/install/vms/ </code></pre>
<p>2. Create storage on a device of hypervisor</p>
<p>The format is 'phy:/dev/sdb1'.</p>
<pre><code>    chdef kvm1 vmstorage=phy:/dev/sdb1 </code></pre>
<p>3. Create storage on a directory of hypervisor</p>
<p>The format is 'dir:/install/vms'.</p>
<pre><code>    chdef kvm1 vmstorage=dir:///install/vms </code></pre>
<p>Note: The attribute vmstorage is only necessary for diskfull node. You can ignore it for diskless node.</p>
<p>Note: The mac address will be created automatically when running the mkvm if you leave it empty. You also can specify it manually before running the mkvm, and then the specified mac address will be used for the kvm1.</p>
<h3 id="define-the-console-attributes-for-the-virtual-machine"><a href="#TOC"><strong>Define the console attributes for the virtual machine</strong></a></h3>
<pre><code>    chdef kvm1 serialport=0 serialspeed=115200 </code></pre>
<h2 id="in-the-end-the-definition-of-kvm1-should-look-more-or-less-like-this"><a href="#TOC">In the end, the definition of kvm1 should look (more or less) like this</a></h2>
<pre><code>    Object name: kvm1
        arch=x86_64
        groups=kvm,vm,all
        mgt=kvm
        netboot=pxe
        os=rhels6
        postbootscripts=otherpkgs
        postscripts=syslog,remoteshell,syncfiles,otherpkgs
        primarynic=eth0
        profile=compute
        serialport=0
        serialspeed=115200
        vmcpus=1
        vmhost=kvmhost1
        vmmemory=1024
        vmnics=br0
        vmstorage=nfs://192.168.5.73/install/vms</code></pre>
<p>Note: depending on your hypervisor type, the nics interface may actually be &quot;virbr0&quot;. You can get the interface by connecting to the hypervisor and running &quot;brctl show&quot;!</p>
<h3 id="create-the-virtual-machine"><a href="#TOC"><strong>Create the virtual machine</strong></a></h3>
<p>Create the virtual machine kvm1 with 20G hard disk. &lt;/br&gt;</p>
<pre><code>    mkvm kvm1 -s 20G</code></pre>
<p>If the kvm1 was created successfully, a hard disk file named kvm1.hda.qcow2 can be found in nfs://192.168.5.73/install/vms. And you can run the lsdef kvm1 to see whether the mac attribute has been set automatically.</p>
<h3 id="try-to-power-on-the-kvm1"><a href="#TOC"><strong>Try to power on the kvm1</strong></a></h3>
<pre><code>    rpower kvm1 on</code></pre>
<p>If the kvm1 was powered on successfully, you can get following information when running 'virsh list' on the kvm host kvmhost1.</p>
<pre><code>    virsh list
     Id Name                 State
    --------------------------------   
      6 kvm1                 running</code></pre>
<p>Run the lsvm command to list the virtual machines on the kvm hypervisor. Before running the lsvm for the kvm host, change the hypervisor.type to kvm by command &quot;nodech kvmhost1 hypervisor.type=kvm&quot;.</p>
<p>Note: Only the virtual machine which is in power on state can be listed by lsvm command.</p>
<pre><code>     lsvm kvmhost1
     kvmhost1: kvm1 </code></pre>
<h3 id="remove-a-virtual-machine-optional"><a href="#TOC"><strong>Remove a virtual machine (Optional)</strong></a></h3>
<p>Remove the kvm1 even when it is in power on status.</p>
<pre><code>    rmvm kmv1 -f</code></pre>
<p>Remove the definition of kvm and related storage.</p>
<pre><code>    rmvm kvm1 -p</code></pre>
<h3 id="you-are-able-to-look-at-the-node-in-rconswcons"><a href="#TOC"><strong>You are able to look at the node in rcons/wcons</strong></a></h3>
<pre><code>    makeconservercf kvm1
    wcons kvm1</code></pre>
<p>Now, have a look as it boots up, you'll see it got the xCAT standby kernel!</p>
<h2 id="installing-the-virtual-machine-kvm1"><a href="#TOC"><strong>Installing the virtual machine kvm1</strong></a></h2>
<p>Now, you get a node which is ready to be installed. So, from here you can just install the kvm1 as a normal node.</p>
<pre><code>    nodeset kvm1 osimage=rhels6.2-x86_64-install-compute
    rpower kvm1 boot </code></pre>
<p>Then the node will automatically reboot and install. You'll have a normal node!</p>
<h2 id="connecting-to-the-virtual-machines-vnc-console"><a href="#TOC"><strong>Connecting to the virtual machine's vnc console</strong></a></h2>
<p>In order to connect to the virtual machine's console, you need to generate a new set of credentials. You can do it by running:</p>
<pre><code>    xcatclient getrvidparms kvm1
    kvm1: method: kvm
    kvm1: textconsole: /dev/pts/0
    kvm1: password: JOQTUtn0dUOBv9o3
    kvm1: vidproto: vnc
    kvm1: server: kvmhost1
    kvm1: vidport: 5900</code></pre>
<p>Now just pick your favorite vnc client and connect to the hypervisor, using the password generated by &quot;getrvidparms&quot;!</p>
<p>Note: If the vnc client complains the password is not valid, it is possible that your hypervisor and headnode clocks are out of sync! You can sync them by running &quot;ntpdate &lt;ntp server&gt;&quot; on both the hypervisor and the headnode.</p>
<h2 id="setting-up-a-network-bridge"><a href="#TOC"><strong>Setting up a network bridge</strong></a></h2>
<p>If you followed the above instructions, depending on the hypervisor OS flavor you are using, it is possible that your VM is not correctly binding to the correct interface on the hypervisor (which will cause it not to be able to reach your network). Fortunately, xCAT ships with a script that can be used to set up bridges automatically for us!</p>
<p>In order to use it, simply copy the &quot;xHRM&quot; script to your netboot images:</p>
<pre><code>    cp /opt/xcat/share/xcat/scripts/xHRM /install/netboot/rhels6/x86_64/compute/rootimg/bin/</code></pre>
<p>Repack the new rootimage:</p>
<pre><code>    packimage rhels6.2-x86_64-netboot-compute </code></pre>
<p>Set the &quot;usexhrm&quot; table field to &quot;1&quot; in your site table:</p>
<pre><code>    tabdump site | grep usexhrm
    &quot;usexhrm&quot;,&quot;1&quot;,,</code></pre>
<p>Restart xCAT:</p>
<pre><code>    service xcatd restart
    Restarting xCATd
     Shutting down vsftpd:                                     [  OK  ]
     Starting vsftpd for vsftpd:                               [  OK  ]</code></pre>
<p>And, finally, set your vm.nics to &quot;default&quot;!</p>
<pre><code>    nodech kvm1 vm.nics=default </code></pre>
<p>Now, next time you restart your hypervisor and your VM, the VM should bridge using the default interface on the hypervisor!</p>
<p>Note: if you already created the VM, you will have to purge the existing VM (rmvm -p kvm1) and create it again (mkvm kvm1 -s 1).</p>
<h2 id="clone-a-kvm-node"><a href="#TOC"><strong>Clone a kvm node</strong></a></h2>
<p>Clone is a concept that create a new node from the old one by reuse most of data that has been installed on the old node. Before creating a new node, a vm (virtual machine) master must be created first. The new node will be created from the vm master. The new node can attach to the vm master or not.<br />The node can NOT be run without the vm master if choosing to make the node attach to the vm master. The advantage is that the less disk space is needed.</p>
<h3 id="in-attaching-mode"><a href="#TOC"><strong>In attaching mode</strong></a></h3>
<p>In this mode, all the nodes will be attached to the vm master. Lesser disk space will be used than the general node.<br />Create the vm master kvmm from a node (kvm2) and make the original node kvm2 attaches to the new created vm master:</p>
<pre><code>    clonevm kvm2 -t kvmm
    kvm2: Cloning kvm2.hda.qcow2 (currently is 1050.6640625 MB and has a capacity of 4096MB)
    kvm2: Cloning of kvm2.hda.qcow2 complete (clone uses 1006.74609375 for a disk size of 4096MB)
    kvm2: Rebasing kvm2.hda.qcow2 from master
    kvm2: Rebased kvm2.hda.qcow2 from master</code></pre>
<p>After the performing, you can see the following entry has been added into the vmmaster table.</p>
<pre><code>     tabdump vmmaster  
     name,os,arch,profile,storage,storagemodel,nics,vintage,originator,comments,disable
    &quot;kvmm&quot;,&quot;rhels6&quot;,&quot;x86_64&quot;,&quot;compute&quot;,&quot;nfs://192.168.5.73/vms/kvm&quot;,,&quot;br0&quot;,&quot;Tue Nov 23 04:18:17 2010&quot;,&quot;root&quot;,,</code></pre>
<p>Clone a new node kvm4 from vm master kvmm:</p>
<pre><code>    clonevm kvm4 -b kvmm</code></pre>
<h3 id="in-detaching-mode"><a href="#TOC"><strong>In detaching mode</strong></a></h3>
<p>Create a vm master that the original node detaches with the created vm master.</p>
<pre><code>    clonevm kvm2 -t kvmmd -d
    kvm2: Cloning kvm2.hda.qcow2 (currently is 1049.4765625 MB and has a capacity of 4096MB)
    kvm2: Cloning of kvm2.hda.qcow2 complete (clone uses 1042.21875 for a disk size of 4096MB)</code></pre>
<p>Clone the kvm3 from the kvmmd with the detaching mode turn on:</p>
<pre><code>    clonevm kvm3 -b kvmmd -d
    kvm3: Cloning kvmmd.hda.qcow2 (currently is 1042.21875 MB and has a capacity of 4096MB)</code></pre>
<h2 id="faq"><a href="#TOC">FAQ</a></h2>
<h3 id="libvirtd-run-into-problem"><a href="#TOC"><strong>libvirtd run into problem</strong></a></h3>
<p>One error we saw on occasion was the following message:</p>
<pre><code>    rpower kvm1 on
    kvm1: internal error no supported architecture for os type &#39;hvm&#39;</code></pre>
<p>This error was fixed by restarting libvirtd on the host machine</p>
<pre><code>    xdsh kvmhost1 service libvirtd restart</code></pre>
<p>Note: In any case that you find there is libvirtd error message in syslog, you can try to restart the libvirtd.</p>
<h3 id="virtual-disk-has-problem"><a href="#TOC"><strong>Virtual disk has problem</strong></a></h3>
<p>When running command 'rpower kvm1 on', get the following error message:</p>
<pre><code>    kvm1: Error: unable to set user and group to &#39;0:0&#39;
      on &#39;/var/lib/xcat/pools/27f1df4b-e6cb-5ed2-42f2-9ef7bdd5f00f/kvm1.hda.qcow2&#39;: Invalid argument:</code></pre>
<p>Solution: try to figure out the nfs:// server was exported correctly. The nfs client should have root authority.</p>
<h3 id="vnc-client-complains-the-credentials-are-not-valid"><a href="#TOC"><strong>VNC client complains the credentials are not valid</strong></a></h3>
<p>When connecting to the hypervisor using VNC (to get a VM console), the vnc client complains with &quot;Authentication failed&quot;.</p>
<p>Solution: Check if the clocks on your hypervisor and headnode are in sync!</p>
<h3 id="rpower-fails-with-qemu-could-not-open-disk-image-varlibxcatpools2e66895a-e09a-53d5-74d3-eccdd9746eb5vmxyz.hda.qcow2-permission-denied-error-message"><a href="#TOC"><strong>rpower fails with &quot;qemu: could not open disk image /var/lib/xcat/pools/2e66895a-e09a-53d5-74d3-eccdd9746eb5/vmXYZ.hda.qcow2: Permission denied&quot; error message</strong></a></h3>
<p>When running rpower on a kvm vm, rpower complains with the following error message:</p>
<pre><code>    rpower vm1 on
    vm1: Error: internal error Process exited while reading console log output: char device redirected to /dev/pts/1
    qemu: could not open disk image /var/lib/xcat/pools/2e66895a-e09a-53d5-74d3-eccdd9746eb5/vm1.hda.qcow2: Permission denied: internal error Process exited while reading console log output: char device redirected to /dev/pts/1
    qemu: could not open disk image /var/lib/xcat/pools/2e66895a-e09a-53d5-74d3-eccdd9746eb5/vm1.hda.qcow2: Permission denied
    [root@xcat xCAT_plugin]#</code></pre>
<p>This might be caused by bad permissions in your NFS server / client (where clients will not mount the share with the correct permissions).</p>
<p>Solution:</p>
<p>Systems like CentOS 6 will have NFS v4 support activated by default. This might be causing the above mentioned problems so one solution is to simply disable NFS v4 support in your NFS server by uncommenting the following option in /etc/sysconfig/nfs:</p>
<pre><code>    RPCNFSDARGS=&quot;-N 4&quot;</code></pre>
<p>Finish by restarting your NFS services (i.e. service nfsd restart) and try powering on your VM again...</p>
<p>Note: if you are running a stateless hypervisor, we advise you to purge the VM (rmvm -p vmXYZ), restart the hypervisor and &quot;mkvm vmXYZ -s 4&quot; to recreate the VM as soon as the hypervisor is up and running.</p>
<h3 id="error-cannot-communicate-via-libvirt-to-host"><a href="#TOC">** Error: Cannot communicate via libvirt to &lt;host&gt; **</a></h3>
<p>This error mostly caused by the incorrect setting of the ssh tunnel between xCAT management node and &lt;host&gt;.</p>
<p><strong>Solution:</strong></p>
<pre><code>Check that xCAT MN could ssh to the &amp;lt;host&amp;gt; without password. </code></pre>
<h3 id="cannot-ping-to-the-vm-after-the-first-boot-of-stateful-install"><a href="#TOC">Cannot ping to the vm after the first boot of stateful install</a></h3>
<p>The new installed stateful vm node is not pingable after the first boot, you may see the following error message in the console when vm booting:</p>
<pre><code>    ADDRCONF(NETDEV_UP): eth0 link is not ready.</code></pre>
<p>This issue may be caused by the incorrect driver for vm. You can try to change driver to 'virtio' by following steps:</p>
<pre><code>    rmvm kvm1
    chdef kvm1 vmnicnicmodel=virtio
    mkvm kvm1</code></pre>
</body>
</html>
