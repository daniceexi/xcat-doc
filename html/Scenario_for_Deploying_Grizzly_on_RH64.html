<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#scenario-for-deploying-grizzly-openstack-on-rh-6.4">Scenario for Deploying Grizzly OpenStack on RH 6.4</a><ul>
<li><a href="#optional-reinstall-nodes">(optional) Reinstall nodes</a></li>
<li><a href="#optional-reset-chef">(optional) Reset Chef</a></li>
<li><a href="#standup-openstack-on-network-node">Standup OpenStack on network node</a></li>
<li><a href="#standup-openstack-on-compute-node">Standup OpenStack on compute node</a></li>
<li><a href="#use-openstack">Use OpenStack</a></li>
</ul></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#scenario-for-deploying-grizzly-openstack-on-rh-64">Scenario for Deploying Grizzly OpenStack on RH 6.4</a></li>
<li><a href="#optional-reinstall-nodes">(optional) Reinstall nodes</a></li>
<li><a href="#optional-reset-chef">(optional) Reset Chef</a></li>
<li><a href="#standup-openstack-on-network-node">Standup OpenStack on network node</a></li>
<li><a href="#standup-openstack-on-compute-node">Standup OpenStack on compute node</a></li>
<li><a href="#use-openstack">Use OpenStack</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->


<h2 id="scenario-for-deploying-grizzly-openstack-on-rh-6.4"><a href="#TOC">Scenario for Deploying Grizzly OpenStack on RH 6.4</a></h2>
<p>Note that standing up the Grizzly OpenStack cluster through xCAT 2.8.3 on RH 6.4 is not fully supported and tested. This wiki page describes one successful scenario that was repeatedly executed with some hand-tending to certain configuration files and to overcome some issues with the community versions of the Chef cookbooks.</p>
<p>Here are some notes on the cluster and this scenario:</p>
<ul>
<li>xCAT management node mn.cluster.com with IP 10.11.0.204 is not included in the actual OpenStack cluster. It acts as the Chef server.</li>
<li>xCAT 2.8.3, using the Chef cookbooks shipped with the xCAT-OpenStack rpm (community version at the time of xCAT 2.8.3 GA)</li>
<li>RHELS 6.4</li>
<li>The OpenStack Per-tenant Routers with Private Networks use case was followed</li>
<li>The cluster:
<ul>
<li>xCAT nodegroup referenced below: ops</li>
<li>op1 - 10.11.0.244 - the OpenStack server running Nova, Keystone, and most other OpenStack services</li>
<li>op2 - 10.11.0.201 - the OpenStack network node running Quantum, dnsmasq, etc. and other OpenStack network services</li>
<li>op3 - 10.11.0.208 - the OpenStack compute node running the OpenStack compute services and on which the VMs will be created</li>
</ul></li>
<li>Networking:
<ul>
<li>public network connected to xCAT management node only. HTTP proxies were set up from the ops nodes to route through the MN to access the rdo/epel repositories during Chef installs of the OpenStack software then turned off to allow OpenStack services to operate correctly within the cluster.</li>
<li>xCAT management network 10.11.0.0 between the xCAT mn and the ops nodes used by xCAT to manage the cluster. Also used as the network for OpenStack services to communicate across.</li>
</ul></li>
</ul>
<p>The details listed here are a quick capture of the steps gleaned from [Deploying_OpenStack] interspersed with manual changes for RH6.4.</p>
<h3 id="optional-reinstall-nodes"><a href="#TOC">(optional) Reinstall nodes</a></h3>
<p>If necessary, reinstall the nodes to start with a clean slate:</p>
<pre><code>  nodeset ops osimage=RH64_no_chef_kit


 make sure osimage has pkglist entries for: 

  httpd
  httpd-tools


 Download the following rpms and put them into &amp;lt;osimage.otherpkgdir&amp;gt;/ops_deps, run createrepo in that dir, and make sure osimage has otherpkgs.pkglist entry for: 

  ops_deps/epel-release
  ops_deps/rdo-release-grizzly


 OpenStack requires dnsmasq 2.59, but dnsmasq 2.48 was shipped with RH 6.4 and a newer version was not available through the RDO repository. Find and download a copy of this and add to otherpkgs for the osimage. 

 Boot the nodes with rpower, watch installs with rcons if necessary </code></pre>
<h3 id="optional-reset-chef"><a href="#TOC">(optional) Reset Chef</a></h3>
<p>On the MN, reset chef to clear out all previous definitions to start clean:</p>
<pre><code> knife cookbook bulk delete &#39;.*&#39; -y
 knife role bulk delete &#39;.*&#39; -y
 knife environment list
 knife environment delete cloud1 -y


 knife client list
 knife client delete op1.cluster.com -y
 knife client delete op2.cluster.com -y
 knife client delete op3.cluster.com -y


 knife node list
 knife node delete op1.cluster.com -y
 knife node delete op2.cluster.com -y
 knife node delete op3.cluster.com -y</code></pre>
<p>During one experiment, for some reason, lost all files in /etc/chef on the xCAT MN (the chef server/workstation), and all chef/knife commands were failing. To recreate them:</p>
<pre><code> [root@mn]# cd /etc/chef
 [root@mn]# knife configure client ./
 Creating client configuration
 Writing client.rb
 Writing validation.pem
 [root@mn]# chef-client</code></pre>
<p>Cookbook fix for RH quantum package:</p>
<pre><code> vi /install/chef-cookbooks/grizzly-xcat/cookbooks/openstack-network/attributes/default.rb
 [root@mn]# diff default.rb default.rb.ORIG
 754c754
 &amp;lt;login&amp;gt;
 shutdown -r now
 &amp;lt;during reboot, may need to capture F12 to boot from harddrive, and select OpenStack kernel&amp;gt;
 &amp;lt;if chef-client does not run from postscripts, run manually&amp;gt;


 verify controller services: 

 ssh op1
 source /root/openrc
  nova-manage service list


 service quantum-server status  
 &amp;gt;&amp;gt;&amp;gt; if still dead, verify previous fix:
     yum install openstack-quantum-openvswitch
 ln -s /etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini /etc/quantum/plugin.ini
 service quantum-server restart</code></pre>
<h3 id="standup-openstack-on-network-node"><a href="#TOC">Standup OpenStack on network node</a></h3>
<p>Standup OpenStack on network node:</p>
<pre><code> chdef op2 provmethod=RH64_with_chef_kit
 updatenode op2


 Fix quantum before the reboot: 

 ssh op2


 ln -s /etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini /etc/quantum/plugin.ini
 vi /etc/quantum/quantum.conf:
 ### comment out following lines (may be listed multiple times):
 #rpc_backend = quantum.openstack.common.rpc.impl_qpid
 #qpid_hostname =


 Being put in by quantum setup scripts (NOT the cookbooks):
 quantum-dhcp-setup
 quantum-l3-setup
 quantum-node-setup
 Need to edit these scripts after the quantum rpms are installed so that subsequent chef-client runs do not revert the quantum.conf back.


 turn off the auto run of chef-client on reboot: 

 chdef op2 provmethod=RH64_no_chef_kit


 Reboot the node: 

 rcons op2
 &amp;lt;login&amp;gt;
 shutdown -r now
 &amp;lt;during reboot, may need to capture F12 to boot from harddrive and select OpenStack kernel&amp;gt;


 Configure the network bridge: 

 updatenode op2 -P &#39;confignics --script configbr-ex&#39;  
 (will hang updatenode cmd, need to kill it;  keep rcons to node open, run &#39;service network restart&#39;)


 Re-run the chef-client on the node to redo any necessary configs that might have needed the new kernel and to properly start openvswitch 

 ssh op2
 chef-client


 Fix quantum again if necessary: 

 ssh op2


 ln -s /etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini /etc/quantum/plugin.ini
 vi /etc/quantum/quantum.conf:
 ### comment out following lines (may be listed multiple times):
 #rpc_backend = quantum.openstack.common.rpc.impl_qpid
 #qpid_hostname =


 Being put in by quantum setup scripts (NOT the cookbooks):
 quantum-dhcp-setup
 quantum-l3-setup
 quantum-node-setup
 Need to edit these scripts after the quantum rpms are installed so that subsequent chef-client runs do not revert the quantum.conf back.


 # re-run chef to fix quantum and openvswitch
 chef-client


 # verify openvswitch/quantum and restart any service not running:
 service openvswitch status
 service quantum-l3-agent status
 service quantum-openvswitch-agent status
 service quantum-dhcp-agent status
 service quantum-metadata-agent status</code></pre>
<h3 id="standup-openstack-on-compute-node"><a href="#TOC">Standup OpenStack on compute node</a></h3>
<p>Standup OpenStack on compute node:</p>
<pre><code> chdef op3 provmethod=RH64_with_chef_kit
 updatenode op3


 fix quantum before the reboot: 

 ssh op3


 ln -s /etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini /etc/quantum/plugin.ini
 vi /etc/quantum/quantum.conf:
 ### comment out following lines (may be listed multiple times):
 #rpc_backend = quantum.openstack.common.rpc.impl_qpid
 #qpid_hostname =


 Being put in by quantum setup scripts (NOT the cookbooks):
 quantum-dhcp-setup
 quantum-l3-setup
 quantum-node-setup
 Need to edit these scripts after the quantum rpms are installed so that subsequent chef-client runs do not revert the quantum.conf back.


 turn off the auto run of chef-client on reboot: 

 chdef op3 provmethod=RH64_no_chef_kit


 Reboot the node: 

 rcons op3
 &amp;lt;login&amp;gt;
 shutdown -r now
 &amp;lt;during reboot, may need to capture F12 to boot from harddrive and select OpenStack kernel&amp;gt;


 ### rerun the chef-client to redo any necessary configs that might have needed the new kernel
 chef-client</code></pre>
<h3 id="use-openstack"><a href="#TOC">Use OpenStack</a></h3>
<p>Continue following the Per Tenant example in the [Deploying_OpenStack] doc:</p>
<pre><code> On the controller node, check all services and fix any not running: 

 source /root/openrc
 nova-manage service-list
 quantum net-list
 nova secgroup-list


 nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0
 nova secgroup-add-rule default tcp 1 65535 0.0.0.0/0
 nova secgroup-add-rule default udp 1 65535 0.0.0.0/0


 glance image-create --name cirros --is-public true --container-format bare --disk-format qcow2 --location https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img


 glance image-list


 Create the external network and its subnet by admin user: 

 quantum net-create ext_net --router:external=True


 quantum subnet-create --name ext_subnet --allocation-pool start=10.11.107.1,end=10.11.107.20 --gateway 10.11.0.204 ext_net 10.11.0.0/16 -- --enable_dhcp=False





 Create a new tenant 

 keystone tenant-list
 keystone tenant-create --name tenantB
 TENANTB_ID=`keystone tenant-list | grep tenantB | awk  &#39;{print $2}&#39;`


 Create a new user and assign the member role to it in the new tenant (keystone role-list to get the appropriate id): 

 keystone user-create --name=user_b --pass=user_b --tenant-id ${TENANTB_ID} --email=user_b@domain.com
 USER_B_ID=`keystone user-list | grep user_b | awk &#39;{print $2}&#39;`
 Member_ID=`keystone role-list  | grep Member | awk &#39;{print $2}&#39;`
 keystone user-role-add --tenant-id ${TENANTB_ID} --user-id ${USER_B_ID} --role-id ${Member_ID}


 Create a new network for the tenant: 

 quantum net-create --tenant-id ${TENANTB_ID} tenantb-net
 TENANTB_NET_ID=`quantum net-list | grep tenantb-net| awk &#39;{print $2}&#39;`



 Create a new subnet inside the new tenant network: 

 quantum subnet-create --name tenantb-subnet --tenant-id ${TENANTB_ID} tenantb-net 192.168.1.0/24
 TENANTB_SUBNET_ID=`quantum subnet-list | grep  tenantb-subnet | awk &#39;{print $2}&#39;`


 Create a router for the new tenant: 

 quantum router-create --tenant-id ${TENANTB_ID} tenantb_router



 Add the router to the subnet: 

 quantum router-interface-add tenantb_router  ${TENANTB_SUBNET_ID}
 quantum router-gateway-set tenantb_router ext_net


 Create creds for tenant: 

 ###  CHANGE OS_AUTH_URL to my controller IP:
 ### echo -e &quot;export OS_TENANT_NAME=tenantB
 ### export OS_USERNAME=user_b
 ### export OS_PASSWORD=user_b
 ### export OS_AUTH_URL=\&quot;http://100.3.1.8:5000/v2.0/\&quot;&quot; &amp;gt;  /root/creds_tenantB_rc
 echo -e &quot;export OS_TENANT_NAME=tenantB
 export OS_USERNAME=user_b
 export OS_PASSWORD=user_b
 export OS_AUTH_URL=\&quot;http://10.11.0.244:5000/v2.0/\&quot;&quot; &amp;gt;  /root/creds_tenantB_rc


 source /root/creds_tenantB_rc


 Create virtual machine: 

 nova  boot --image cirros --flavor 1 --nic net-id=${TENANTB_NET_ID}  tenant_b_testvm1


 TENANTB_TESTVM1_ID=`nova list | grep tenant_b_testvm1 | awk &#39;{print $2}&#39;`


 Create a floating IP: 

 quantum floatingip-create ext_net


 ####  CHANGE IP to grep for
 ###FLOATINGIP_ID_JUST_CREATED=`quantum floatingip-list | grep 9.114 | awk &#39;{print $2}&#39;`
 FLOATINGIP_ID_JUST_CREATED=`quantum floatingip-list | grep 10.11 | awk &#39;{print $2}&#39;`


 #Get the port ID of the VM with ID
 VM_PORT_ID_JUST_GOT=`quantum  port-list -- --device_id  ${TENANTB_TESTVM1_ID} | grep subnet_id | awk &#39;{print $2}&#39;`


 #quantum floatingip-associate d7d3fb7e-b00a-4cb6-bbed-e379ab22119b d8003e37-e5cc-4222-9eb8-18e99a0310da
 quantum floatingip-associate ${FLOATINGIP_ID_JUST_CREATED}  ${VM_PORT_ID_JUST_GOT}


 ###  NEED TO DO THIS AGAIN HERE AS TENANTB????
 #Add this security rules to make your VMs pingable:
 nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0
 nova secgroup-add-rule default tcp 1 65535 0.0.0.0/0
 nova secgroup-add-rule default udp 1 65535 0.0.0.0/0


 ### waiting about 1 minute, you can run nova list to check the vm with 2 IPs
 nova list


 test connection: 

 ping 10.11.107.2


 Log onto new VM: 

 ssh cirros@10.11.107.2
  pw:   cubswin:)</code></pre>
</body>
</html>
