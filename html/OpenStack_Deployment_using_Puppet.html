<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#puppet-server-and-client-installation">Puppet server and client installation</a><ul>
<li><a href="#on-ubuntu">On Ubuntu</a></li>
<li><a href="#on-redhat">On Redhat</a></li>
</ul></li>
<li><a href="#openstack-deployment-with-puppet">OpenStack Deployment with Puppet</a><ul>
<li><a href="#configure-the-puppet-server">Configure the Puppet server</a></li>
<li><a href="#deploy-openstack-on-the-nodes">Deploy OpenStack on the nodes</a></li>
</ul></li>
<li><a href="#other-design-considerations">Other Design Considerations</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#puppet-server-and-client-installation">Puppet server and client installation</a></li>
<li><a href="#on-ubuntu">On Ubuntu</a></li>
<li><a href="#on-redhat">On Redhat</a></li>
<li><a href="#openstack-deployment-with-puppet">OpenStack Deployment with Puppet</a></li>
<li><a href="#configure-the-puppet-server">Configure the Puppet server</a></li>
<li><a href="#deploy-openstack-on-the-nodes">Deploy OpenStack on the nodes</a></li>
<li><a href="#other-design-considerations">Other Design Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><a href="Design_Warning">Design_Warning</a></p>
<h2 id="introduction"><a href="#TOC">Introduction</a></h2>
<p>This mini-design discusses how to use Puppet to deploy OpenStack software. Puppet is an automation software that helps system administrators manage software throughout its life cycle, from provisioning and configuration to patch management and compliance. Puppet is available as both open source and commercial software. We only support the open source Puppet in xCAT. Puppet lab (https://puppetlabs.com/) provides many modules that automates the deployment of some critical applications such as OpenStack. OpenStack (http://www.openstack.org/) is an open source software that provides infrastructure for cloud computing.</p>
<p>This doc discusses how to setup puppet server and client within xCAT cluster and then kick off the OpenStack deployment using puppet. We'll have the following assumption:</p>
<ul>
<li>All the nodes have an external network that has internet connection and a internal network.</li>
<li>The OpenStack controller will not be the same as the xCAT management node. This is due to the conflict of OpenStack DHCP and xCAT DHCP server.</li>
</ul>
<p>We'd like to divide it into following two functions:</p>
<ol style="list-style-type: decimal">
<li>Puppet server and client installation</li>
<li>OpenStack deployment with puppet</li>
</ol>
<p>Function #1 itself is a unique feature that allows user to use the puppet deploying other applications.</p>
<h2 id="puppet-server-and-client-installation"><a href="#TOC">Puppet server and client installation</a></h2>
<p>Puppet server and client can be installed on many operating systems. Due to time limit, we'll limit it to Ubuntu and RedHat for xCAT 2.8.1 release.</p>
<h3 id="on-ubuntu"><a href="#TOC">On Ubuntu</a></h3>
<p>The following 4 postscripts will be created, they will be installed under /install/postscripts directory.</p>
<ol style="list-style-type: decimal">
<li>install_puppet_server It can be run on the mn as a script or on a node as a postscript to install and configure the puppet server. It first installs the puppet-server rpm and its dependencies and then calls the config_puppet_server script to modify the puppet server configuration files. And then it restarts the puppet server so that the new configuration can take effect.</li>
<li>install_puppet_client It is run as a postscript on a node. It first download and installs the puppet client rpm and its dependencies and then calls config_puppet_client script to modify the puppet client configuration files. It does NOT start the puppet agent because it may kick off the application deployment prematurely.</li>
<li>config_puppet_server It is called by install_puppet_server on Ubuntu and the puppet kit on RH (discussed later). It sets the <strong>certname</strong> in /etc/puppet/puppet.conf file. This name will be referenced as the puppet server name by the client in order to certify with the server. A <strong>site.puppetserver</strong> value will be used as the <strong>certname</strong> if it is defined, otherwise <strong>site.master</strong> will be used. It also sets up the /etc/puppet/autosign.conf file so that the client certification can be done automatically.</li>
<li>config_puppet_client It is called by install_puppet_client on Ubuntu and the puppet kit on RH (discussed later). It sets the <strong>server</strong> name and its own node name in /etc/puppet/puppet.conf file.</li>
</ol>
<p>This is what the user will do when installing puppet:</p>
<p>First assign a node as a puppet server, the node can be mn or any node.</p>
<pre><code>   chdef -t site clustersite puppetserver=&amp;lt;nodename&amp;gt;</code></pre>
<p>If the puppet server is mn, run</p>
<pre><code>   install_puppet_server</code></pre>
<p>If puppet server is not mn, first add install_puppet_server to the postscripts table for the node,</p>
<pre><code>   chdef -t node -o &amp;lt;nodename&amp;gt; -p postbootscripts=install_puppet_server</code></pre>
<p>Then run updatnode or redeploy the node:</p>
<pre><code>   updatenode &amp;lt;nodename&amp;gt; -P install_puppet_server
 or
   rsetboot &amp;lt;nodename&amp;gt; net
   nodeset &amp;lt;nodename&amp;gt; osimage=&amp;lt;imgname&amp;gt;
   rpower &amp;lt;nodename&amp;gt; reset</code></pre>
<p>To install puppet client on nodes, first add install_puppet_client to the postscripts table for the nodes,</p>
<pre><code>   chdef -t node -o &amp;lt;noderange&amp;gt; -p postbootscripts=install_puppet_client</code></pre>
<p>Then run updatenode or redeploy the node:</p>
<pre><code>   updatenode &amp;lt;noderange&amp;gt; -P install_puppet_client
 or
   rsetbootseq &amp;lt;noderange&amp;gt; net
   nodeset &amp;lt;noderange&amp;gt; osimage=&amp;lt;imgname&amp;gt;
   rpower &amp;lt;noderange&amp;gt; reset</code></pre>
<h3 id="on-redhat"><a href="#TOC">On Redhat</a></h3>
<p>A kit will be used to install the puppet server and client on RedHat and other platform. In this release we'll create a kit just for rhels6 with x86_64 architecture. The puppet rpms and the dependency packages will be downloaded from https://yum.puppetlabs.com/el/6/dependencies/x86_64/ and https://yum.puppetlabs.com/el/6/products/x86_64/</p>
<p>The name of the kit is called <strong>puppet</strong>. There will be 2 kit components in the kit:</p>
<ul>
<li>puppet_server_kit</li>
<li>puppet_client_kit</li>
</ul>
<p>The buildkit.conf file looks like this:</p>
<pre><code> kit:
   basename=puppet
   description=Kit for installing puppet server and client
   version=1.0
   ostype=Linux
   kitlicense=EPL


 kitrepo:
  kitrepoid=rhels6_x86_64
  osbasename=rhels
  osmajorversion=6
  #osminorversion=
  osarch=x86_64

  #compat_osbasenames=


 kitcomponent:
   basename=puppet_client_kit
   description=For installing puppet client
   version=1.0
   release=1
   serverroles=servicenode,compute
   kitrepoid=rhels6_x86_64
   kitpkgdeps=puppet
   postinstall=client.rpm_post
   postbootscripts=client.post

 kitcomponent:
   basename=puppet_server_kit
   description=For installing puppet server
   version=1.0
   release=1
   serverroles=mgtnode
   kitrepoid=rhels6_x86_64
   kitpkgdeps=puppet-server
   postinstall=server.rpm_post
   postbootscripts=server.post


 kitpackage:
   filename=puppet-3*
   kitrepoid=rhels6_x86_64
   isexternalpkg=no
   rpm_prebuiltdir=rhels6/x86_64

 kitpackage:
   filename=puppet-server-*
   kitrepoid=rhels6_x86_64
   isexternalpkg=no
   rpm_prebuiltdir=rhels6/x86_64

 kitpackage:
   filename=*
   kitrepoid=rhels6_x86_64
   isexternalpkg=no
   rpm_prebuiltdir=rhels6/x86_64</code></pre>
<p>The server.rpm_post and client.rpm_post are used as the %post script for the <strong>puppet_server_kit.rpm</strong> and <strong>puppet_client_kit.rpm</strong> meta packages respectively. They are used to configure the puppet after it is installed. server.rpm_post calls config_puppet_server and client.rpm_post calls config_puppet_client. However, this will not work for stateless/statelite when the puppet rpms are installed into images by genimage command. This is because both config* scripts need the environmental variables such as $NODE, $PUPPETSERVER and $SITEMASTER etc. in order to do the configuration for puppet. When genimage is called, these environmental variables are not set and the $NODE cannot be the same for every node. In order to solve this problem, two other scripts server.post and client.post will be used as the postbootscripts in the <strong>postscripts</strong> table for the nodes.</p>
<p>The client.rpm_post looks like this:</p>
<pre><code>   if [ -f &quot;/proc/cmdline&quot; ]; then   # prevent running it during install into chroot image
       #configure the puppet agent configuration files
       /xcatpost/config_puppet_client &quot;$@&quot;
   fi
   exit 0</code></pre>
<p>The client.post looks like this:</p>
<pre><code>   if [ &quot;$NODESETSTATE&quot; = &quot;install&quot; ]; then
       #prevent getting called during full install bootup
       #because the function will be called in the rpm %post section instead
       exit 0
   else
       #configure the puppet agent configuration files
       /xcatpost/config_puppet_client &quot;$@&quot;
   fi
   exit 0</code></pre>
<p>The following is the user instruction on how to install puppet server and client on RH, assuming mn is the puppet server.</p>
<p>Add mn on the xCAT DB</p>
<pre><code>   xcatconfig -m</code></pre>
<p>Please make sure that there is an image name assigned to the mn and each node. To check, run</p>
<pre><code>   lsdef &amp;lt;nodename&amp;gt; provmethod</code></pre>
<p>Add puppet server name in the site table</p>
<pre><code>   chdef -t site clustersite puppetserver=&amp;lt;mnname&amp;gt;</code></pre>
<p>Download the puppet kit</p>
<pre><code>   wget http://xcat.sourceforge.net/#download... (TBD)</code></pre>
<p>Add the kit in xCAT</p>
<pre><code>   addkit puppet-1.0-Linux.tar.bz2
   addkitcomp -i &amp;lt;mn_image_name&amp;gt; puppet_server_kit
   addkitcomp -i &amp;lt;node_image_name&amp;gt; puppet_client_kit</code></pre>
<p>To install the puppet server on the mn, run</p>
<pre><code>   updatenode &amp;lt;mnname&amp;gt;  -P otherpkgs</code></pre>
<p>To install the puppet client on the node, run updatenode or redeploy the node. Please make sure yum is installed on all the nodes.</p>
<pre><code>   updatenode &amp;lt;noderange&amp;gt; -P otherpkgs
 or
   rsetbootseq &amp;lt;noderange&amp;gt; net
   nodeset &amp;lt;noderange&amp;gt; osimage=&amp;lt;imgname&amp;gt;
   rpower &amp;lt;noderange&amp;gt; reset</code></pre>
<h2 id="openstack-deployment-with-puppet"><a href="#TOC">OpenStack Deployment with Puppet</a></h2>
<p>With automation setup by the OpenStack Puppet Modules, deploying OpenStack is quite easy, if everything goes well. If something is wrong, you have to debug the modules which is not that easy. Hope we setup everything up front so that the installation goes smoothly.</p>
<h3 id="configure-the-puppet-server"><a href="#TOC">Configure the Puppet server</a></h3>
<p>1. Load the OpenStack modules</p>
<pre><code>  puppet module install puppetlabs-openstack
  puppet module list</code></pre>
<p>2. Create a site manifest site.pp for OpenStack</p>
<pre><code>  cat /etc/puppet/modules/openstack/examples/site.pp &amp;gt;&amp;gt; /etc/puppet/manifests/site.pp</code></pre>
<p>Note: There is 2 errors in /etc/puppet/manifests/site.pp file, they are found when deploying OpenStack Folsom on Ubuntu 12.04.2. You may need to make the following changes for your cluster: In 'openstack::controller' class, comment out export_resources entry and add a entry for secret_key. So the last two entried of the class look like this:</p>
<pre><code>   #export_resources    =&amp;gt; false,
   secret_key           =&amp;gt; &#39;dummy_secret_key&#39;,</code></pre>
<p>Note: I have created a script for step 1 and 2, but feel it is not worth to check in. This should not be a big burden for the user anyway.</p>
<p>3. Input cluster info in the site.pp file Now you can modify the file /etc/puppet/manifests/site.pp and input the network info and the a few passwords. We usually make all the passwords the same. The following entries must be filled:</p>
<pre><code>   $public_interface        = &#39;eth0&#39;
   $private_interface       = &#39;eth1&#39;
   # credentials
   $admin_email             = &#39;root@localhost&#39;
   $admin_password          = &#39;keystone_admin&#39;
   $keystone_db_password    = &#39;keystone_db_pass&#39;
   $keystone_admin_token    = &#39;keystone_admin_token&#39;
   $nova_db_password        = &#39;nova_pass&#39;
   $nova_user_password      = &#39;nova_pass&#39;
   $glance_db_password      = &#39;glance_pass&#39;
   $glance_user_password    = &#39;glance_pass&#39;
   $rabbit_password         = &#39;openstack_rabbit_password&#39;
   $rabbit_user             = &#39;openstack_rabbit_user&#39;
   $fixed_network_range     = &#39;10.0.0.0/24&#39;
   $floating_network_range  = &#39;192.168.101.64/28&#39;

   $controller_node_address  = &#39;192.168.101.11&#39;</code></pre>
<p>Add the OpenStack controller and compute nodes in the site.pp file. You can replace &quot;node /openstack_controller/&quot; and &quot;node /openstack_compute/&quot; or &quot;node /openstack_all/&quot; with the node names of your cluster, for example:</p>
<pre><code>   node &quot;node1&quot; {
      class { &#39;openstack::controller&#39;:
       ...
   }


   node &quot;node2,node3&quot; {
      class { &#39;openstack::compute&#39;:
      ...
   }</code></pre>
<h3 id="deploy-openstack-on-the-nodes"><a href="#TOC">Deploy OpenStack on the nodes</a></h3>
<p>1. Setup the OpenStack repo on the nodes</p>
<pre><code>   chdef -t node -o &amp;lt;noderange&amp;gt; -p postbootscripts=setup_openstack_repo
   updatenode &amp;lt;noderange&amp;gt; -P  setup_openstack_repo</code></pre>
<p>setup_openstack_repo has hard coded OpenStack repositories which you can modify to fit your needs. It uses the following repositories:</p>
<ul>
<li>Ubuntu: http://ubuntu-cloud.archive.canonical.com/ubuntu precise-updates/folsom main</li>
<li>RH: TBD</li>
</ul>
<p>2. Deploy OpenStack</p>
<pre><code>   xdsh &amp;lt;controller_nodename&amp;gt; &quot;puppet agent -t&quot;
   xdsh &amp;lt;compute_nodenames&amp;gt; &quot;puppet agent -t&quot;</code></pre>
<p>Now OpenStack is installed and configured on your node. Please refer to Puppet's own doc /etc/puppet/modules/openstack/README.md for detailed instructions on how to use puppet to deploy OpenStack</p>
<h2 id="other-design-considerations"><a href="#TOC">Other Design Considerations</a></h2>
<ul>
<li><strong>Required reviewers</strong>: Bruce Potter, Guang Cheng, Jie Hua</li>
<li><strong>Required approvers</strong>: Bruce Potter</li>
<li><strong>Database schema changes</strong>: N/A</li>
<li><strong>Affect on other components</strong>: N/A</li>
<li><strong>External interface changes, documentation, and usability issues</strong>: N/A</li>
<li><strong>Packaging, installation, dependencies</strong>: N/A</li>
<li><strong>Portability and platforms (HW/SW) supported</strong>: N/A</li>
<li><strong>Performance and scaling considerations</strong>: N/A</li>
<li><strong>Migration and coexistence</strong>: N/A</li>
<li><strong>Serviceability</strong>: N/A</li>
<li><strong>Security</strong>: N/A</li>
<li><strong>NLS and accessibility</strong>: N/A</li>
<li><strong>Invention protection</strong>: N/A</li>
</ul>
</body>
</html>
