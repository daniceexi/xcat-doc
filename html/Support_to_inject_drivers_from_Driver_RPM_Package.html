<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#interface">Interface</a></li>
<li><a href="#inject-the-drivers-to-initrd">Inject the drivers to initrd</a></li>
<li><a href="#code-logic">Code Logic</a><ul>
<li><a href="#to-generate-the-initrd-for-diskfull-against-rh">To generate the initrd for diskfull against rh:</a></li>
<li><a href="#to-generate-the-initrd-for-diskless-against-rh">To generate the initrd for diskless against rh</a></li>
<li><a href="#to-generate-the-initrd-for-diskfull-against-the-sles">To generate the initrd for diskfull against the sles</a></li>
<li><a href="#to-generate-the-initrd-for-diskless-against-the-sles">To generate the initrd for diskless against the sles</a></li>
</ul></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#interface">Interface</a></li>
<li><a href="#inject-the-drivers-to-initrd">Inject the drivers to initrd</a></li>
<li><a href="#code-logic">Code Logic</a></li>
<li><a href="#to-generate-the-initrd-for-diskfull-against-rh">To generate the initrd for diskfull against rh:</a></li>
<li><a href="#to-generate-the-initrd-for-diskless-against-rh">To generate the initrd for diskless against rh</a></li>
<li><a href="#to-generate-the-initrd-for-diskfull-against-the-sles">To generate the initrd for diskfull against the sles</a></li>
<li><a href="#to-generate-the-initrd-for-diskless-against-the-sles">To generate the initrd for diskless against the sles</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p>{{:Design Warning}}</p>
<h2 id="interface"><a href="#TOC">Interface</a></h2>
<p>For driver rpm support, the location of driver rpm only can be specified from the osimage object. A new column linuximage.driverupdatesrc will be added to store the location of driver rpm. It's a attribute of osimage object.</p>
<p>The the value format of driverupdatesrc can be a comma seperated section of: dud:&lt;full path of driver update disk&gt; or rpm:&lt;full path of driver rpm package&gt;. If no tag, xCAT will consider it's the 'rpm' format.</p>
<p>For example:</p>
<pre><code>dud:/install/dud/dd.img,rpm:/install/rpm/d.rpm</code></pre>
<p>The existed attribute 'netdrivers' (linuximage.netdrivers) will be used to specify the driver list that need to be loaded from the driver rpms.</p>
<p>If no 'netdrivers' specified, all the drivers from the driver rpms will be injected to the initrd.</p>
<p>For example:</p>
<pre><code>megaraid_sas.ko,bnx2.ko</code></pre>
<h2 id="inject-the-drivers-to-initrd"><a href="#TOC">Inject the drivers to initrd</a></h2>
<p>Run the 'genimage' ang 'nodeset' against the osimage to trigger the action that inject the drivers from the driver rpm to the initrd.</p>
<pre><code>[Diskless]
 genimage &amp;lt;osimagename&amp;gt;
[Diskfull]
 nodeset &amp;lt;noderange&amp;gt; osimage=&amp;lt;osimagename&amp;gt;</code></pre>
<p>Note: After injecting of the new drivers, the initrd will be different from the default one. Current initrd location '/tftpboot/xcat/&lt;os&gt;/&lt;arch&gt; cannot store the initrd that hacked one and original one. So I added a new level of directory base on 'profile' to store the new generated initrd. The initrd path for the pxe and yaboot also have been changed.</p>
<pre><code>&#39;/tftpboot/xcat/&amp;lt;os&amp;gt;/&amp;lt;arch&amp;gt;/&amp;lt;profile&amp;gt;&#39;</code></pre>
<h2 id="code-logic"><a href="#TOC">Code Logic</a></h2>
<p>The pseudo-code in following described the logic that injecting the drivers from driver disk and driver rpm to the initrd.</p>
<h3 id="to-generate-the-initrd-for-diskfull-against-rh"><a href="#TOC">To generate the initrd for diskfull against rh:</a></h3>
<pre><code>In cases: &#39;dracut + drvier rpm&#39;, &#39;!dracut + driver rpm&#39; and &#39;!dracut + driver disk&#39;
 unpack the initrd
 If has driver rpm, Extract the drivers from driver rpm
 For dracut (rh6)
   If has driver rpm, copy the firmware,drivers and run the &#39;depmod&#39;
 For rh5
   Unpack the modules.cgz for the orignial initrd
   If has driver disk:
     Unpack the driver disk and unpack the modules.cgz
     Copy firmware and drivers to initrd
     Generate the configure files: module-info, modules.dep ...
   If has driver rpm:
     Copy firmware and drivers to initrd
     generate the module-info.
       Add the entry to module-info if no entry for the driver was there
     generate the modules.dep   
       Use the &#39;depmod&#39; command to generate the dep against all the drivers.
       Since the &#39;depmod&#39; command needs the specific directory structure like &#39;/lib/modules/&amp;lt;kernelver&amp;gt; to generate the modules.dep, I copied the drivers which extracted from the modules.cgz to a specific dirctory &#39;./lib/modules/&amp;lt;kernelver&amp;gt;&#39;, then run the &#39;depmod&#39;. And since the modules.dep that used by the initrd has not the path and &#39;.ko&#39; postfix for each driver, then remove the path and &#39;.ko&#39; for the entries from the new generated moduels.dep. This logic works well from my testing.
   Pack te modules.cgz for initrd
 Pack the initrd


 In case: dracut + driver disk  ( I did not touch the code logic for this scenario)
   generate an image with the driver disk
   append the driver disk image to the original initrd</code></pre>
<h3 id="to-generate-the-initrd-for-diskless-against-rh"><a href="#TOC">To generate the initrd for diskless against rh</a></h3>
<pre><code> If has driver disk: (no change)
   Unpack the driver disk and modules.cgz
   Copy the firmware and drivers from driver disk to the rootimage
 If has driver rpm:
   Extract drivers from rpm package
   Copy the firmware and drivers to the rootimage
 Make the dependency for the modules by &#39;depmod&#39; command</code></pre>
<h3 id="to-generate-the-initrd-for-diskfull-against-the-sles"><a href="#TOC">To generate the initrd for diskfull against the sles</a></h3>
<pre><code> For the cases: arch=ppc or has driver rpm
   Unpack the initrd
   If has driver rpm
     Extract the drivers from driver rpms
     copy firmware and drivers to the initrd
     generate the dependency for driver modules
   If has driver disk
      mkpath /cus_driverdisk, and copy driver disk to /cus_driverdisk
   Pack the initrd


 For the case: arch=x86 and without driver rpm
   Generate an image with the driver disk
   Append the driver disk image to the original initrd</code></pre>
<h3 id="to-generate-the-initrd-for-diskless-against-the-sles"><a href="#TOC">To generate the initrd for diskless against the sles</a></h3>
<pre><code> If has driver disk (not change)
   Unpack the driver disk
   Copy the drivers from the driver disk to the rootimage
 If has the driver rpm
   Extract the drivers from driver rpms
   copy firmware and drivers to the rootimage
 generate the dependency for driver modules</code></pre>
</body>
</html>
