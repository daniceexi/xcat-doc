<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#tables-in-2.8.2">Tables (in 2.8.2)</a><ul>
<li><a href="#cfgmgt-table">cfgmgt Table</a></li>
<li><a href="#clouds-table">clouds Table</a></li>
<li><a href="#cloud-table">cloud Table</a></li>
</ul></li>
<li><a href="#xcat-openstack-rpm-in-2.8.2">xCAT-openstack rpm (in 2.8.2)</a></li>
<li><a href="#use-of-the-table-data">Use of the Table Data</a><ul>
<li><a href="#workflow-of-deploy-openstack-with-chef-implemented-in-xcat-2.8.3">Workflow of Deploy Openstack with Chef (implemented in xCAT 2.8.3 ?)</a></li>
<li><a href="#workflow-of-deploy-openstack-with-puppet-in-xcat-2.8.3">Workflow of Deploy Openstack with Puppet (in xCAT 2.8.3 ?)</a></li>
</ul></li>
<li><a href="#other-design-considerations">Other Design Considerations</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#tables-in-282">Tables (in 2.8.2)</a></li>
<li><a href="#cfgmgt-table">cfgmgt Table</a></li>
<li><a href="#clouds-table">clouds Table</a></li>
<li><a href="#cloud-table">cloud Table</a></li>
<li><a href="#xcat-openstack-rpm-in-282">xCAT-openstack rpm (in 2.8.2)</a></li>
<li><a href="#use-of-the-table-data">Use of the Table Data</a></li>
<li><a href="#workflow-of-deploy-openstack-with-chef-implemented-in-xcat-283&amp;nbsp">Workflow of Deploy Openstack with Chef (implemented in xCAT 2.8.3 ?)</a></li>
<li><a href="#workflow-of-deploy-openstack-with-puppet-in-xcat-283&amp;nbsp">Workflow of Deploy Openstack with Puppet (in xCAT 2.8.3 ?)</a></li>
<li><a href="#other-design-considerations">Other Design Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><a href="Design_Warning">Design_Warning</a></p>
<p>Note: this is a very rough strawman for this mini-design. Still needs work.</p>
<h2 id="background"><a href="#TOC">Background</a></h2>
<p>In order for xCAT to automate some of the steps of setting up a cloud based on openstack, it needs some information about the cloud and the chef/puppet configuration that should be set up. This design describes the tables that should exist in xcat for this purpose and a little bit about what each attribute will be used for. The assumption is that the user would fill out these tables before using xcat and chef/puppet to set up the cloud.</p>
<h2 id="tables-in-2.8.2"><a href="#TOC">Tables (in 2.8.2)</a></h2>
<h3 id="cfgmgt-table"><a href="#TOC">cfgmgt Table</a></h3>
<p>Add the new table cfgmgt in xCAT, and it will be in xCAT by default. It's not in the xCAT-Openstack-xx.rpm This table is used for puppetserver and chefserver .</p>
<ul>
<li><strong>node</strong> - the node name of chef-client(or puppet-client). This is the key.</li>
<li><strong>cfgmgr</strong> - puppet or chef</li>
<li><strong>cfgserver</strong> - the node name of chef-server or puppet-server</li>
<li><strong>roles</strong> - call it <strong>cfgmgtroles</strong> in the node def object. a comma-separated list of roles this node will have. These role names map to the chef/puppet recipes that should be run for this node. From chef point, each role you specify would have a list of recipes it requires. Take openstack cookbooks as an example, there are some roles,such as: mysql-master, keystone, glance, nova-controller, nova-conductor, cinder-all. Users can add their roles into the cookbooks. Once one role is updated to the chef-server, and it can be assigned to the chef-client node.</li>
</ul>
<h3 id="clouds-table"><a href="#TOC">clouds Table</a></h3>
<p>We need to support xcat setting up more than one cloud. A typical case would be they have a production cloud and a test cloud. So we will list the clouds in the clouds table:</p>
<ul>
<li><strong>name</strong> - user specified cloud name. This is the key for the table.</li>
<li><strong>controller</strong> - node name of the controller node.</li>
<li><strong>publicnet</strong> - name of network in networks table to be used for the openstack public network</li>
<li><strong>novanet</strong> - name of network in networks table to be used for the openstack nove network</li>
<li><strong>mgtnet</strong> - name of network in networks table to be used for the openstack management network</li>
<li><strong>vmnet</strong> - name of network in networks table to be used for the openstack vm network</li>
<li><strong>adminpw</strong></li>
<li><strong>dbpw</strong></li>
</ul>
<h3 id="cloud-table"><a href="#TOC">cloud Table</a></h3>
<p>This is a node oriented table, storing cloud info for each node.</p>
<ul>
<li><strong>node</strong> - the node name. This is the key.</li>
<li><strong>cloudname</strong> - the cloud this node is in. This points to the clouds.name attribute.</li>
</ul>
<h2 id="xcat-openstack-rpm-in-2.8.2"><a href="#TOC">xCAT-openstack rpm (in 2.8.2)</a></h2>
<p>The xCAT-openstack rpm will be a meta-meta rpm. It would include the cloud tables and chef &amp; puppet recipes specific to openstack and then require the xCAT rpm so it would pull in all of xcat.</p>
<h2 id="use-of-the-table-data"><a href="#TOC">Use of the Table Data</a></h2>
<p>When nodeset or updatenode is run, xcat will pull info from these tables and plug the info in the correct places in the chef/puppet recipes.</p>
<p>In addition, the mypostscript.tmpl file will include environment variables for the chef/puppet server (from the noderes table), so that the chef/puppet postscript will no who to contact.</p>
<h3 id="workflow-of-deploy-openstack-with-chef-implemented-in-xcat-2.8.3"><a href="#TOC">Workflow of Deploy Openstack with Chef (implemented in xCAT 2.8.3 ?)</a></h3>
<p>1 Install the chef-server/chef-client:</p>
<p>1.1 If the chefserver node is not installation, install the chef-server during postbootscripts when OS provision; otherwise, just need to run &quot;updatenode&quot; to install the chef-server</p>
<p>1.2 If the chefclient node is not installation, install the chef-client during postbootscripts when OS provision; otherwise, just need to run &quot;updatenode&quot; to install the chef-client.</p>
<p>Refer to [Adding_Chef_in_xCAT_Cluster] to get more information.</p>
<p>2. Configure the chef-server</p>
<p>2.1 Prepare the chef-cookbooks</p>
<p>The chef-cookbooks will be on the MN firstly, and then distribute them to each chef-server. The users can use scp or xdcp to do the distribution. After that, the cfgmgt.path which is used to specify the cookbooks/recipes paths on the chef-server should be updated. (jjh: I think we can put the chef-cookbooks in the /install/chef directory on MN. And the distribution could be done by the script config_ops_chef_server automatically . Considering there are not so much chef-server, so the performance will not be an issue. What do you think of it?)</p>
<p>And the mypostscript.tmpl file will include environment variables for the chef server.</p>
<p>publicnet, novanet, mgtnet,vmnet,adminpw,dbpw, cfgmtgpath, chef-client-list, roles_of_&lt;each_chef_client&gt;</p>
<p>Run &quot;updatenode &lt;chef-server-noderange&gt; -P config_ops_chef_server&quot; . The script config_ops_chef_server will</p>
<pre><code> (1)generate chef environment file
 (2)use knife command to load the environment file
 (3)apply the environment name to the chef-client nodes
 (4)upload the cookbooks/roles
 (5)assign the roles to the chef-client. </code></pre>
<p>If we want to do only one action, we can specify the argument for config_ops_chef_env.</p>
<p>3. Run &quot;chef-client&quot; on each client node to deploy the openstack.</p>
<pre><code> xdsh &amp;lt;controller-noderange&amp;gt; -s chef-client 
 xdsh &amp;lt;computer-noderange&amp;gt; -s chef-client </code></pre>
<p>Currently, there are many outputs of chef-client. If there are many nodes, the output of xdsh may be not easy to read directly.</p>
<h3 id="workflow-of-deploy-openstack-with-puppet-in-xcat-2.8.3"><a href="#TOC">Workflow of Deploy Openstack with Puppet (in xCAT 2.8.3 ?)</a></h3>
<p>Under construction.</p>
<h2 id="other-design-considerations"><a href="#TOC">Other Design Considerations</a></h2>
<ul>
<li><strong>Required reviewers</strong>: Bruce, Linda, Ling, Guang Cheng and Jie Hua.</li>
<li><strong>Required approvers</strong>: Bruce Potter</li>
<li><strong>Affect on other components</strong>: N/A</li>
<li><strong>External interface changes, documentation, and usability issues</strong>: N/A</li>
<li><strong>Packaging, installation, dependencies</strong>: N/A</li>
<li><strong>Portability and platforms (HW/SW) supported</strong>: N/A</li>
<li><strong>Performance and scaling considerations</strong>: N/A</li>
<li><strong>Migration and coexistence</strong>: N/A</li>
<li><strong>Serviceability</strong>: N/A</li>
<li><strong>Security</strong>: N/A</li>
<li><strong>NLS and accessibility</strong>: N/A</li>
<li><strong>Invention protection</strong>: N/A</li>
</ul>
</body>
</html>
