<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#on-rhel6">On RHEL6:</a><ul>
<li><a href="#preparation">Preparation:</a></li>
<li><a href="#steps">Steps:</a></li>
</ul></li>
<li><a href="#sles-11">SLES 11</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#on-rhel6">On RHEL6:</a></li>
<li><a href="#preparation">Preparation:</a></li>
<li><a href="#steps">Steps:</a></li>
<li><a href="#sles-11">SLES 11</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->



<p><strong>This document is no longer used! It's content has been integrated into the main xcat cookbooks.</strong></p>
<p>This doc describes how to set up an xCAT management node and service node to boot compute nodes over the system p HFI network.</p>
<h2 id="on-rhel6"><a href="#TOC">On RHEL6:</a></h2>
<h3 id="preparation"><a href="#TOC">Preparation:</a></h3>
<ol style="list-style-type: decimal">
<li><p>We are using the following node names as an example in this document:</p>
<pre><code>Management node (MN): c250mgrs04-pvt
Service node (SN): c250f07c04ap01
Compute node (CN): c250f07c04ap13</code></pre></li>
<li>All the steps should be run on the xCAT management node. For those commands that need to run on the service node, we are using xdsh to run the command remotely on the service node.</li>
<li>The following RPMs and scripts referred to in this document currently must be obtained from IBM and put on the xCAT MN in the suggested directories:
<ul>
<li>/hfi/dd/kernel-2.6.<em>hfi-</em>.ppc64.rpm</li>
<li>/hfi/dd/hfi_util-*.el6.ppc64.rpm</li>
<li>/hfi/dd/net-tools-*.el6.ppc64.rpm</li>
<li>/hfi/dhcp/dhcp-*.el6.ppc64.rpm</li>
<li>/hfi/dhcp/dhclient-*.el6.ppc64.rpm</li>
<li>/hfi/scripts/hficonfig</li>
<li>/hfi/scripts/compute.rhel6.ppc64.synclist</li>
</ul></li>
</ol>
<h3 id="steps"><a href="#TOC">Steps:</a></h3>
<ol style="list-style-type: decimal">
<li><p>After installing xCAT on the management node according [XCAT_pLinux_Clusters], increase the /boot file system size for service node since we need to use a customized kernel on service node, there will be two kernels existing on service nodes, /boot needs more space.</p>
<p>This is just for a workaround of a customized kernel. After the kernel is accepted by Linux community, there will be only one kernel existing on service node, and we don't need to increase the /boot space at that time.</p>
<p>In file /opt/xcat/share/xcat/install/rh/service.rhels6.ppc64.tmpl, change the line:</p>
<p>From:</p>
<pre><code>part /boot --size 50 --fstype ext4</code></pre>
<p>To:</p>
<pre><code>part /boot --size 200 --fstype ext4</code></pre></li>
<li>Refer to the rest of [XCAT_pLinux_Clusters] and [Setting_Up_a_Linux_Hierarchical_Cluster] for instructions for setting up a basic xCAT MN and SN and stateless compute nodes. The rest of the instructions below are additional steps you need to take to be able to boot the compute nodes over the HFI network. Eventually, this document will be integrated with the other two.</li>
<li><p>After the basic MN is set up and the SN is installed, install the HFI device drivers on xCAT MN</p>
<pre><code>cd /hfi/dd
rpm -ivh kernel-2.6.32hfi-3.ppc64.rpm
rpm -ivh --nodeps hfi_util-1.0-0.el6.ppc64.rpm
rpm -ivh --force net-tools-1.60-102.el6.ppc64.rpm</code></pre></li>
<li>Configure the xCAT SN with the HFI device driver
<ol style="list-style-type: decimal">
<li><p>Copy the HFI driver and DHCP packages to service node:</p>
<pre><code>xdcp c250f07c04ap01 -R /hfi /hfi</code></pre></li>
<li><p>Install the HFI device drivers on the xCAT SN</p>
<pre><code>xdsh c250f07c04ap01 rpm -ivh /hfi/dd/kernel-2.6.32hfi-2.ppc64.rpm
xdsh c250f07c04ap01 rpm -ivh --nodeps /hfi/dd/hfi_util-1.0-0.el6.ppc64.rpm
xdsh c250f07c04ap01 rpm -ivh --force /hfi/dd/net-tools-1.60-102.el6.ppc64.rpm
xdsh c250f07c04ap01 /sbin/new-kernel-pkg --mkinitrd --depmod --install 2.6.32hfi
xdsh c250f07c04ap01 /sbin/new-kernel-pkg --rpmposttrans 2.6.32hfi</code></pre></li>
<li><p>Create soft links and change yaboot.conf to boot from the customized kernel with HFI support</p>
<pre><code>xdsh c250f07c04ap01 ln -sf /boot/vmlinuz-2.6.32hfi /boot/vmlinuz
xdsh c250f07c04ap01 ln -sf /boot/System.map-2.6.32hfi /boot/System.map</code></pre></li>
</ol></li>
</ol>
<p>Login to the service node and change the &quot;default=&quot; setting in /boot/etc/yaboot.conf to the new label with HFI support. For example, change it from:</p>
<pre><code>        boot=/dev/sda1
        init-message=&quot;Welcome to Red Hat Enterprise Linux!\nHit &amp;lt;TAB&amp;gt; for boot options&quot;
        partition=3
        timeout=5
        install=/usr/lib/yaboot/yaboot
        delay=5
        enablecdboot
        enableofboot
        enablenetboot
        nonvram
        fstype=raw
        default=linux
        image=/vmlinuz-2.6.32hfi
        label=2.6.32hfi
        read-only
        initrd=/initrd-2.6.32hfi.img
        append=&quot;rd_NO_LUKS rd_NO_LVM rd_NO_MD rd_NO_DM LANG=en_US.UTF-8 SYSFONT=latarcyrhebsun16 KEYTABLE=us console=hvc0 crashkernel=auto rhgb quiet root=UUID=e2123609-7080-45f0-b583-23d5ef27dbba&quot;
        image=/vmlinuz-2.6.32-71.el6.ppc64
        label=linux
        read-only
        initrd=/initramfs-2.6.32-71.el6.ppc64.img
        append=&quot;rd_NO_LUKS rd_NO_LVM rd_NO_MD rd_NO_DM LANG=en_US.UTF-8 SYSFONT=latarcyrhebsun16 KEYTABLE=us console=hvc0 crashkernel=auto rhgb quiet root=UUID=e2123609-7080-45f0-b583-23d5ef27dbba&quot;</code></pre>
<p>TO:</p>
<pre><code>        boot=/dev/sda1
        init-message=&quot;Welcome to Red Hat Enterprise Linux!\nHit &amp;lt;TAB&amp;gt; for boot options&quot;
        partition=3
        timeout=5
        install=/usr/lib/yaboot/yaboot
        delay=5
        enablecdboot
        enableofboot
        enablenetboot
        nonvram
        fstype=raw
        default=2.6.32hfi
        image=/vmlinuz-2.6.32hfi
        label=2.6.32hfi
        read-only
        initrd=/initrd-2.6.32hfi.img
        append=&quot;rd_NO_LUKS rd_NO_LVM rd_NO_MD rd_NO_DM LANG=en_US.UTF-8 SYSFONT=latarcyrhebsun16 KEYTABLE=us console=hvc0 crashkernel=auto rhgb quiet root=UUID=e2123609-7080-45f0-b583-23d5ef27dbba&quot;
        image=/vmlinuz-2.6.32-71.el6.ppc64
        label=linux
        read-only
        initrd=/initramfs-2.6.32-71.el6.ppc64.img
        append=&quot;rd_NO_LUKS rd_NO_LVM rd_NO_MD rd_NO_DM LANG=en_US.UTF-8 SYSFONT=latarcyrhebsun16 KEYTABLE=us console=hvc0 crashkernel=auto rhgb quiet root=UUID=e2123609-7080-45f0-b583-23d5ef27dbba&quot;

4. Reset the service node to boot from the kernel with HFI 

        xdsh c250f07c04ap01 reboot</code></pre>
<ol start="5" style="list-style-type: decimal">
<li><p>Now the HFI interfaces should be available on the service node. Sync the /etc/hosts from MN to SN and run the hficonfig postscript to configure the HFI interfaces with IP addresses.</p>
<pre><code>xdcp c250f07c04ap01 /etc/hosts /etc/hosts
cp /hfi/scripts/hficonfig /install/postscripts/hficonfig
chdef c250f07c04ap01 postscripts=servicenode,xcatserver,xcatclient,hficonfig
updatenode c250f07c04ap01</code></pre></li>
</ol>
<p>In <strong>xCAT 2.7</strong>, the xcatserver and xcatclient postscripts are not longer needed in the postscripts table. You should use the following command:</p>
<p>chdef c250f07c04ap01 postscripts=servicenode,hficonfig</p>
<ol start="6" style="list-style-type: decimal">
<li><p>Install the DHCP server/client on MN and SN.</p>
<pre><code>rpm -Uvh /hfi/dhcp/dhcp-4.1.1-13.P1.el6.ppc64.rpm
rpm -Uvh /hfi/dhcp/dhclient-4.1.1-13.P1.el6.ppc64.rpm
xdsh c250f07c04ap01 rpm -Uvh /hfi/dhcp/dhcp-4.1.1-13.P1.el6.ppc64.rpm
xdsh c250f07c04ap01 rpm -Uvh /hfi/dhcp/dhclient-4.1.1-13.P1.el6.ppc64.rpm</code></pre></li>
<li><p>Create a new networks definition in the xCAT database for the HFI interface. Generally we only need to create one new HFI network definition (for hf0) for diskless booting of compute nodes over HFI.</p>
<pre><code>mkdef -t network -o hfinet net=20.0.0.0 mask=255.0.0.0 gateway=20.255.255.254 mgtifname=hf0 dhcpserver=20.7.4.1 tftpserver=20.7.4.1 nameservers=20.7.4.1</code></pre></li>
</ol>
<p>where the above net, mask, and gateway are appropriate for your hf0 network, and 20.7.4.1 should be changed to be the IP address of the hf0 NIC on your SN.</p>
<ol start="8" style="list-style-type: decimal">
<li><p>Create compute node definitions. Make sure the servicenode and xcatmaster attributes are set correctly.</p>
<p>servicenode attribute should be set to the IP address or hostname of the ethernet NIC on the service node that faces the MN. The xcatmaster attribute should be set to hf0 IP address on the service node. An example <a href="http://xcat.sourceforge.net/man5/xcatstanzafile.5.html">mkdef stanza file</a> for defining the compute node:</p>
<pre><code>c250f07c04ap13:
objtype=node
arch=ppc64
cons=fsp
groups=lpar,all
hcp=f07c04fsp1_a
id=13
installnic=hf0
ip=20.7.4.13
mgt=fsp
monserver=20.7.4.1
netboot=yaboot
nfsserver=20.7.4.1
nodetype=ppc,osi
hwtype=lpar
os=rhels6
parent=f07c04fsp1_a
postscripts=hficonfig
pprofile=c250f07c04ap13
primarynic=hf0
profile=compute
provmethod=netboot
servicenode=10.7.4.1
tftpserver=20.7.4.1
xcatmaster=20.7.4.1</code></pre></li>
<li><p>Create a diskless image for the compute node</p>
<pre><code>copycds -n rhels6 /iso/RHEL6.0-20100922.1-Server-ppc64-DVD1.iso</code></pre></li>
</ol>
<p>Where rhels6 stands for the OS version (RHEL 6 Server).</p>
<ol start="10" style="list-style-type: decimal">
<li><p>The HFI kernel can be installed by xCAT automatically, but the other two packages, hfi_util and nettools, require the rpm options --nodeps and --force respectively, which xCAT cannot handle automatically. So we need to modify the postinstall file manually which will be run during the diskless image generation.</p>
<p>Add the following lines to /opt/xcat/share/xcat/netboot/rh/compute.rhels6.ppc64.postinstall. (rhels6 stands for the OS version - it should be the same as the previous step.)</p>
<pre><code>cp /hfi/dd/hfi_util-1.0-0.el6.ppc64.rpm /install/netboot/rhels6/ppc64/compute/rootimg/tmp/hfi_util-1.0-0.el6.ppc64.rpm
cp /hfi/dd/net-tools-1.60-102.el6.ppc64.rpm /install/netboot/rhels6/ppc64/compute/rootimg/tmp/nettools-1.60-102.el6.ppc64.rpm
cp /hfi/dhcp/dhclient-4.1.1-13.P1.el6.ppc64.rpm /install/netboot/rhels6/ppc64/compute/rootimg/tmp/dhclient-.1.1-13.P1.el6.ppc64.rpm
cp /hfi/dhcp/dhcp-4.1.1-13.P1.el6.ppc64.rpm /install/netboot/rhels6/ppc64/compute/rootimg/tmp/dhcp-4.1.1-13.P1.el6.ppc64.rpm
chroot /install/netboot/rhels6/ppc64/compute/rootimg/ /bin/rpm -ivh /tmp/net-tools-1.60-102.el6.ppc64.rpm --force
chroot /install/netboot/rhels6/ppc64/compute/rootimg/ /bin/rpm -ivh /tmp/hfi_util-1.0-0.el6.ppc64.rpm --nodeps --force
chroot /install/netboot/rhels6/ppc64/compute/rootimg/ /bin/rpm -Uvh /tmp/dhclient-4.1.1-13.P1.el6.ppc64.rpm --force
chroot /install/netboot/rhels6/ppc64/compute/rootimg/ /bin/rpm -Uvh /tmp/dhcp-4.1.1-13.P1.el6.ppc64.rpm --force</code></pre></li>
<li><p>Sync /etc/hosts to the diskless image. This is used by the postscript hficonfig to configure all the HFI interfaces on the compute nodes.</p>
<pre><code>cp /hfi/scripts/compute.rhels6.ppc64.synclist /install/custom/netboot/rh/compute.rhels6.ppc64.synclist</code></pre></li>
<li><p>Generate the diskless image</p>
<pre><code>cd /opt/xcat/share/xcat/netboot/rh/ &amp;&amp; /opt/xcat/share/xcat/netboot/rh/genimage -i hf0 -n hf_if -o rhels6 -p compute -k 2.6.32hfi</code></pre></li>
</ol>
<p>where hf0 stands for the boot interface on compute nodes, and hf_if stands for the hfi device driver.</p>
<ol start="13" style="list-style-type: decimal">
<li><p>pack the image:</p>
<pre><code>packimage -o rhels6 -p compute -a ppc64</code></pre></li>
<li><p>Get the compute node mac address and set up dhcp services.</p>
<pre><code>getmacs c250f07c04ap13 --hfi -D</code></pre></li>
<li><p>Prepare for the compute node boot</p>
<pre><code>nodeset c250f07c04ap13 netboot</code></pre></li>
<li><p>Make sure your site.dhcpinterfaces attribute is set correctly to have the MN and SN listen only on the correct NICs.</p>
<pre><code>&amp;gt; tabdump site | grep dhcp
&quot;dhcpinterfaces&quot;,&quot;c250mgrs04-pvt|eth0;c250f07c04ap01|hf0&quot;,,</code></pre></li>
</ol>
<p>Issue makedhcp to setup dhcp services. Specify --HFI option to identify this is a HFI devices.</p>
<pre><code>    makedhcp c250f07c04ap13 --HFI</code></pre>
<ol start="17" style="list-style-type: decimal">
<li><p>Reboot the node to boot from network.</p>
<pre><code>rnetboot c250f07c04ap13 --hfi</code></pre></li>
<li><p>Open a console to watch the compute node installation.</p>
<pre><code>rcons c250f07c04ap13</code></pre></li>
</ol>
<h2 id="sles-11"><a href="#TOC">SLES 11</a></h2>
<p>Instructions for SLES 11 will come at a later time.</p>
</body>
</html>
