<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#installing-other-packages-with-ubuntu-official-mirror"><strong>Installing other packages with Ubuntu official mirror</strong></a><ul>
<li><a href="#a1-compute-nodes-can-access-the-internet">A1: Compute nodes can access the internet</a></li>
<li><a href="#a2-compute-nodes-can-not-access-the-internet">A2: Compute nodes can not access the internet</a><ul>
<li><a href="#optional-1-use-apt-proxy">optional 1: Use apt proxy</a></li>
<li><a href="#optional-2-use-local-mirror">Optional 2: Use local mirror</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#installing-other-packages-with-ubuntu-official-mirror"><strong>Installing other packages with Ubuntu official mirror</strong></a>
<ul>
<li><a href="#a1-compute-nodes-can-access-the-internet">A1: Compute nodes can access the internet</a></li>
</ul></li>
<li><a href="#a2-compute-nodes-can-not-access-the-internet">A2: Compute nodes can not access the internet</a>
<ul>
<li><a href="#optional-1--use-apt-proxy">optional 1: Use apt proxy</a></li>
<li><a href="#optional-2-use-local-mirror">Optional 2: Use local mirror</a></li>
</ul></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<h2 id="installing-other-packages-with-ubuntu-official-mirror"><a href="#TOC"><strong>Installing other packages with Ubuntu official mirror</strong></a></h2>
<p>The Ubuntu iso is being used to install the compute nodes only include packages to run a base operating system, it is likely that users will need to install additional Ubuntu packages from the internet Ubuntu repo or local repo, this section describes how to install additional Ubuntu packages.</p>
<h4 id="a1-compute-nodes-can-access-the-internet"><a href="#TOC">A1: Compute nodes can access the internet</a></h4>
<p>step1: Specify the repository</p>
<p>Use the internet repository directly when define the otherpkgdir attribute:</p>
<pre><code>    chdef -t osimage &lt;osimage name&gt; otherpkgdir=&quot;http://us.archive.ubuntu.com/ubuntu/ precise main,http://us.archive.ubuntu.com/ubuntu/ precise-update main&quot;</code></pre>
<p>step2: Specify otherpkglist file</p>
<p>create an otherpkglist file, /install/custom/install/ubuntu/compute.otherpkgs.pkglist. Add the packages' name into thist file. And modify the otherpkglist attribute for osimage object.</p>
<pre><code>    chdef -t osimage &lt;osimage name&gt; otherpkglist=/install/custom/install/ubuntu/compute.otherpkgs.pkglist</code></pre>
<p>step3: Run &quot;updatenode <nodename> -S&quot; or &quot;updatenode <nodename> -P otherpkgs&quot;</p>
<p>Run updatenode -S to install/update the packages on the compute nodes</p>
<pre><code>    updatenode &lt;nodename&gt; -S</code></pre>
<p>Run updatenode otherpkgs to install/update the packages on the compute nodes</p>
<pre><code>    updatenode &lt;nodename&gt; -P otherpkgs </code></pre>
<h3 id="a2-compute-nodes-can-not-access-the-internet"><a href="#TOC">A2: Compute nodes can not access the internet</a></h3>
<p>If compute nodes cannot access the internet, there are two ways to install additional packages:use apt proxy or use local mirror;</p>
<h4 id="optional-1-use-apt-proxy"><a href="#TOC">optional 1: Use apt proxy</a></h4>
<p>Step 1: Install Squid on the server which can access the internet (Here uses management node as the proxy server)</p>
<pre><code>    apt-get install squid</code></pre>
<p>Step 2: Edit the Squid configuration file /etc/squid3/squid.conf, find the line &quot;#http_access deny to_localhost&quot;. Add the following 2 lines behind this line.</p>
<pre><code>    acl cn_apt src &lt;compute node sub network&gt;/&lt;net mask length&gt;
    http_access allow cn_apt</code></pre>
<p>For more refer <a href="http://wiki.squid-cache.org/SquidFaq/ConfiguringSquid">Squid configuring</a>.</p>
<p>Step 3: Restart the proxy service</p>
<pre><code>    service squid3 restart</code></pre>
<p>Step 4: Create a postscript under /install/postscripts/ directory, called aptproxy, add following lines</p>
<pre><code>    #!/bin/sh
    PROXYSERVER=$1
    if [ -z $PROXYSERVER ];then
        PROXYSERVER=$MASTER
    fi
    
    PROXYPORT=$2
    if [ -z $PROXYPORT ];then
        PROXYPORT=3128
    fi
    
    if [ -e &quot;/etc/apt/apt.conf&quot; ];then
        sed &#39;/^Acquire::http::Proxy/d&#39; /etc/apt/apt.conf &amp;gt; /etc/apt/apt.conf.new
        mv -f /etc/apt/apt.conf.new /etc/apt/apt.conf
    fi
    echo &quot;Acquire::http::Proxy \&quot;http://${PROXYSERVER}:$PROXYPORT\&quot;;&quot; &amp;gt;&amp;gt; /etc/apt/apt.conf</code></pre>
<p>Step 5: add this postscript to compute nodes, the [proxy server ip] and [proxy server port] are optional parameters for this postscript. If they are not specified, xCAT will use the management node ip and 3128 by default.</p>
<pre><code>    chdef &lt;node range&gt; -p postscripts=&quot;aptproxy [proxy server ip] [proxy server port]&quot;</code></pre>
<p>Step 6: Edit the otherpkglist file, add the require software packages' name.</p>
<p>Step 7: Edit the otherpkgdir attribute for os image object, can use the internet repositories directly.</p>
<p>Step 8: Run nodeset, rsetboot, rpower commands to provision the compute nodes.</p>
<h4 id="optional-2-use-local-mirror"><a href="#TOC">Optional 2: Use local mirror</a></h4>
<p>Find a server witch can connect the internet, and can be accessed by the compute nodes.</p>
<p>step 1: Install apt-mirror</p>
<pre><code>    apt-get install apt-mirror</code></pre>
<p>step 2: Configure apt-mirror</p>
<pre><code>    vim /etc/apt/mirror.list</code></pre>
<p>step 3: Run apt-mirror to download the repositories(The needed space can be found in <a href="https://wiki.ubuntu.com/Mirrors?action=show&amp;redirect=Archive">Ubuntu Mirrors</a>)</p>
<pre><code>    apt-mirror /etc/apt/mirror.list</code></pre>
<p>step 4: Install apache</p>
<pre><code>    apt-get install apache2</code></pre>
<p>step 5: Setup links to link our local repository folder to our shared apache directory</p>
<pre><code>    ln -s /var/spool/apt-mirror/mirror/archive.ubuntu.com /var/www/archive-ubuntu</code></pre>
<p>When setting the otherpkgdir attribute for the osimages, can use http://&lt;local mirror server ip&gt;/archive-ubuntu/ precise main</p>
<p>For more information about setting local repository mirror can refer <a href="http://ubuntuforums.org/showthread.php?t=599479">How to Setup Local Repository Mirror</a></p>
</body>
</html>
