<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#ganglia-installation-notes">Ganglia Installation Notes</a></li>
<li><a href="#install-prereqs">Install Prereqs</a></li>
<li><a href="#get-and-install-rrdtool">Get and Install RRDTool</a></li>
<li><a href="#get-and-install-ganglia">Get and Install Ganglia</a></li>
<li><a href="#configure-ganglia-on-the-management-node">Configure Ganglia on the Management Node</a></li>
<li><a href="#compute-nodes-quick-and-dirty-method">Compute Nodes (Quick and Dirty method)</a></li>
<li><a href="#compute-nodes-stateless-more-permanent-method">Compute Nodes (Stateless more permanent method)</a></li>
<li><a href="#add-rvitals-to-ganglia-monitoring">Add rvitals to Ganglia monitoring</a></li>
<li><a href="#section">...</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#ganglia-installation-notes">Ganglia Installation Notes</a></li>
<li><a href="#install-prereqs">Install Prereqs</a></li>
<li><a href="#get-and-install-rrdtool">Get and Install RRDTool</a></li>
<li><a href="#get-and-install-ganglia">Get and Install Ganglia</a></li>
<li><a href="#configure-ganglia-on-the-management-node">Configure Ganglia on the Management Node</a></li>
<li><a href="#compute-nodes-quick-and-dirty-method">Compute Nodes (Quick and Dirty method)</a></li>
<li><a href="#compute-nodes-stateless-more-permanent-method">Compute Nodes (Stateless more permanent method)</a></li>
<li><a href="#add-rvitals-to-ganglia-monitoring">Add rvitals to Ganglia monitoring</a></li>
<li><a href="#">...</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><a href="Howto_Warning">Howto_Warning</a></p>
<h2 id="ganglia-installation-notes"><a href="#TOC">Ganglia Installation Notes</a></h2>
<p>This HOWTO will cover installing the base Ganglia on to a system running xCAT that uses stateless images. Please update it if you find errors. For this example we're using RedHat 5.x. Also, this is just a simple example. You can get better documentation at the Ganglia site <a href="https://sourceforge.net/docman/display_doc.php?docid=128909&amp;group_id=43021">here</a>. This is just a quick howto where we install Ganglia on the management node and then on stateless images.</p>
<h2 id="install-prereqs"><a href="#TOC">Install Prereqs</a></h2>
<pre><code>yum -y install apr-devel apr-util check-devel cairo-devel pango-devel
wget \ ftp://ftp.muug.mb.ca/mirror/fedora/linux/releases/9/Everything/source/SRPMS/libconfuse-2.6-1.fc9.src.rpm
rpm -ivh libconfuse-2.6-1.fc9.src.rpm
cd /usr/src/redhat/SPECS
rpmbuild -ba x86_64 libconfuse.spec
cd ../RPMS/x86_64/
rpm -ivh libconfuse-devel-2.6-1.x86_64.rpm libconfuse-2.6-1.x86_64.rpm</code></pre>
<h2 id="get-and-install-rrdtool"><a href="#TOC">Get and Install RRDTool</a></h2>
<p>This example will use all the defaults to install RRDTool. RRDTool is the round robin database engine behind Ganglia and also the way Ganglia plots graphs.</p>
<pre><code>cd /install/packages/
wget http://oss.oetiker.ch/rrdtool/pub/rrdtool.tar.gz
tar zxvf rrdtool*
cd rrdtool-*
./configure
make -j8
make install
which rrdtool
echo &quot;/usr/local/rrdtool-1.3.4/lib&quot; &amp;gt;/etc/ld.so.conf.d/rrd.conf
ldconfig</code></pre>
<h2 id="get-and-install-ganglia"><a href="#TOC">Get and Install Ganglia</a></h2>
<p>Get it <a href="http://sourceforge.net/project/showfiles.php?group_id=43021&amp;package_id=35280">here</a>. Download the ganglia-3.1.1.tar.gz file and place it in /install/packages</p>
<pre><code>cd /install/packages/
tar zxvf ganglia*tgz
cd ganglia-3.1.1/
./configure --with-gmetad
make -j8
make install
cp -a web /var/www/html/ganglia/
cp gmetad/gmetad.init /etc/rc.d/init.d/gmetad
mkdir /etc/ganglia
gmond -t | tee /etc/ganglia/gmond.conf
cp gmetad/gmetad.conf /etc/ganglia/
mkdir -p /var/lib/ganglia/rrds
chown nobody:nobody /var/lib/ganglia/rrds
chkconfig --add gmetad
chkconfig --add gmond</code></pre>
<h2 id="configure-ganglia-on-the-management-node"><a href="#TOC">Configure Ganglia on the Management Node</a></h2>
<p>Edit /etc/ganglia/gmond.conf so that:</p>
<pre><code>name = &quot;unspecified&quot;</code></pre>
<p>becomes</p>
<pre><code>name = &quot;yourclustername&quot;</code></pre>
<p>Then, we need to allow support for the python modules. Add the following in the modules { } stanza:</p>
<pre><code>modules {
  #... a bunch of modules
  module {
    name = &quot;python_module&quot;
    path = &quot;modpython.so&quot;
    params = &quot;/usr/lib64/ganglia/python_modules/&quot;
  }
}
include (&#39;/etc/ganglia/conf.d/*.conf&#39;)
include (&#39;/etc/ganglia/conf.d/*.pyconf&#39;)</code></pre>
<p>Change /var/www/html/ganglia/conf.php so that</p>
<pre><code>define(&quot;RRDTOOL&quot;, &quot;/usr/bin/rrdtool&quot;);</code></pre>
<p>becomes</p>
<pre><code>define(&quot;RRDTOOL&quot;, &quot;/usr/local/bin/rrdtool&quot;);</code></pre>
<p>On my cluster, eth1 on the management server is the interface that connects to the compute nodes. Therefore, to make it so that my gmond traffic goes out on the same broadcast domain as the compute nodes I did this:</p>
<pre><code>route add -host 239.2.11.71 dev eth1</code></pre>
<p>(You should use the same 239.2.11.71 unless you changed it in the gmond.conf file, but attach it to whatever interface is connected to the nodes.)</p>
<p>To permanently add this route, so that it is available upon reboot, create the file /etc/sysconfig/network-scripts/route-&lt;your ethernet&gt;. (I wanted to bind Ganglia to eth1, so I created /etc/sysconfig/network-scripts/route-eth1). Then add the contents:</p>
<pre><code>239.2.11.71 dev eth1</code></pre>
<p>At this point we can now restart everything and look at the web page and see our management node:</p>
<pre><code>service gmond start
service gmetad start
service httpd restart</code></pre>
<p>Now pull up a web browser and look at the management node:<br />http://localhost/ganglia</p>
<p>If you followed the instructions... (or if I documented it correctly) then you should now see the graphs of your cluster and the management node. Nice work! Now lets install the compute nodes.</p>
<h2 id="compute-nodes-quick-and-dirty-method"><a href="#TOC">Compute Nodes (Quick and Dirty method)</a></h2>
<p>For compute nodes, we just need to copy the files on to them and it will work fine. Assuming you have a compute group, just run the following:</p>
<pre><code>pscp /usr/sbin/gmond compute:/usr/sbin/gmond
psh compute mkdir -p /etc/ganglia/
pscp /etc/ganglia/gmond.conf compute:/etc/ganglia/
pscp /etc/init.d/gmond compute:/etc/init.d/
pscp /usr/lib64/libganglia-3.1.1.so.0 compute:/usr/lib64/
pscp /lib64/libexpat.so.0 compute:/lib64/
pscp /usr/lib64/libconfuse.so.0 compute:/usr/lib64/
pscp /usr/lib64/libapr-1.so.0 compute:/usr/lib64/
pscp -r /usr/lib64/ganglia compute:/usr/lib64/
psh compute service gmond start</code></pre>
<p>Now if you restart gmetad or refresh your web browser on the management node you should see all the nodes in it.</p>
<h2 id="compute-nodes-stateless-more-permanent-method"><a href="#TOC">Compute Nodes (Stateless more permanent method)</a></h2>
<p>This is basically the same as the other method. But here, we put those files in the stateless image. My stateless image is called 'compute'. In this example we've already ran genimage to create the base stateless image. So to add Ganglia to the existing stateless image I do the following:</p>
<pre><code>export IMGROOT=/install/netboot/rhels5.2/x86_64/compute/rootimg
echo $IMGROOT
cp /usr/sbin/gmond $IMGROOT/usr/sbin/gmond
mkdir -p $IMGROOT/etc/ganglia/
cp /etc/ganglia/gmond.conf $IMGROOT/etc/ganglia/
cp /etc/init.d/gmond $IMGROOT/etc/init.d/
cp /usr/lib64/libganglia-3.1.1.so.0 $IMGROOT/usr/lib64/
cp /lib64/libexpat.so.0 $IMGROOT/lib64/
cp /usr/lib64/libconfuse.so.0 $IMGROOT/usr/lib64/
cp /usr/lib64/libapr-1.so.0 $IMGROOT/usr/lib64/
cp -a /usr/lib64/ganglia $IMGROOT/usr/lib64/
chroot $IMGROOT chkconfig --add gmond</code></pre>
<p>Now I pack the image up and deploy it to nodes:</p>
<pre><code>packimage -p compute -a x86_64 -o rhels5.2
nodeset compute netboot
rpower compute boot</code></pre>
<p>Now when these nodes come up they're all set and you should see them in your Ganglia web page.</p>
<h2 id="add-rvitals-to-ganglia-monitoring"><a href="#TOC">Add rvitals to Ganglia monitoring</a></h2>
<p>You can add rvitals to Ganglia monitoring by using the spoofing mechanisms of gmetric. This is a two step process: 1. Use a script to run rvitals and 2. Use a cron job to run it however often you feel you should. The following script can be saved as /opt/xcat/share/xcat/scripts/xcat-gmetric.pl</p>
<pre><code>#!/usr/bin/perl
use strict;
use Socket;

my $nr = shift;
if($nr eq &quot;&quot;){
        print &quot;please supply an xCAT noderange as an argument\n&quot;;
        exit 1;
}
#if($ENV{XCATROOT} eq &quot;&quot;){
#       print &quot;XCATROOT is not defined in environment\n&quot;;
#       print &quot;Is xCAT installed?\n&quot;;
#       exit 1;
#}

my %vitals = (
        temp =&amp;gt; [&quot;Celsius&quot;, &quot;int16&quot;],
        voltage =&amp;gt;  [&quot;Voltage&quot;, &quot;float&quot;],
        fanspeed =&amp;gt; [&quot;RPM&quot;, &quot;float&quot;]
);

foreach my $k (keys %vitals){
        foreach my $i (`rvitals $nr $k`) {
                my $ip;
                chomp $i;
                my($host,$desc,$val) = split(&quot;: &quot;, $i);
                $val = (split(&quot; &quot;, $val))[0];

                my $packet_ip = gethostbyname($host);
                if(defined $packet_ip){
                        $ip = inet_ntoa($packet_ip);
                }else{
                        print &quot;Could not get IP for $host\n&quot;;
                        next;
                }
                my $type = $vitals{$k}-&amp;gt;[1];
                my $unit = $vitals{$k}-&amp;gt;[0];
                my $cmd = &quot;gmetric -n &#39;$desc&#39; -v $val -t $type -u $unit -S $ip:$host&quot;;
                `$cmd`;
        }
}</code></pre>
<p>Then you can create a contab that will run it as often as you like. To run it every minute run:</p>
<pre><code>crontab -e</code></pre>
<p>Then add the following line to it:</p>
<pre><code>* * * * * /opt/xcat/share/xcat/scripts/xcat-gmetric.pl compute</code></pre>
<p>That will run the script every minute and run IPMI commands on the compute group. You can use the xCAT noderange options to run on different compute groups. Once the cron job is running you will start to see IPMI entries in the Ganglia graph. Mine looks kind of like this:</p>
<p>[[img src=Xcat-ganglia.png]]</p>
<h2 id="section"><a href="#TOC">...</a></h2>
<h2 id="conclusion"><a href="#TOC">Conclusion</a></h2>
<p>Hopefully this helps you get started with gmond. I would encourage other readers to add their customizations and send to the xCAT mailing list or me directly so I can post them: vallard AT benincosa.com</p>
</body>
</html>
