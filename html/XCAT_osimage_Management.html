<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#overview-and-background">Overview and Background</a></li>
<li><a href="#what-is-osimage">What is osimage?</a></li>
<li><a href="#why-do-i-want-to-convert-to-osimage-based-configuration">Why do I want to convert to osimage based configuration?</a></li>
<li><a href="#procedure-for-using-osimage">Procedure for using osimage</a></li>
<li><a href="#convert-to-osimage-based-configuration">Convert to osimage based configuration</a></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#overview-and-background">Overview and Background</a></li>
<li><a href="#what-is-osimage">What is osimage?</a></li>
<li><a href="#why-do-i-want-to-convert-to-osimage-based-configuration">Why do I want to convert to osimage based configuration?</a></li>
<li><a href="#procedure-for-using-osimage">Procedure for using osimage</a></li>
<li><a href="#convert-to-osimage-based-configuration">Convert to osimage based configuration</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><strong>THIS DOCUMENT IS STILL UNDER CONSTRUCTION</strong></p>
<p>The purpose of this document is to provide a central location for all xCAT operating system image management concepts. This document was originally based on and expands the xCAT OS Image management discussion from the document [Convert_Non-osimage_Based_System_To_Osimage_Based_System]. Also, there are many places in various xCAT documents that include different aspects of OS image management as steps within larger processes. This document attempts to provide pointers for you when you remember having read how to do a particular customization somewhere but can't quite find where.</p>
<p>[[img src=Official-xcat-doc.png]]</p>
<h2 id="overview"><a href="#TOC">Overview</a></h2>
<p>Managing basic Linux operating systems images with xCAT can be very easy. Customizing those images can also be easy once you understand what can be customized, when those customizations are applied, and where to put your custom files.</p>
<p>Customizations can include:</p>
<ul>
<li>installing additional operating system packages</li>
<li>installing additional software packages that you have downloaded from other sources</li>
<li>installing additional software bundled into xCAT kits</li>
<li>running pre-scripts, postscripts, postbootscripts, postinstall scripts that you provide</li>
<li>installing custom drivers</li>
<li>installing a custom kernel</li>
<li>updating files through synclists</li>
<li>excluding files from diskless images to reduce their footprint</li>
<li>controlling the details of a statefull install through a custom template</li>
<li>specifying disk partitioning of a stateful install through a custom partitionfile</li>
<li>managing the various persistent and non-persistent files in statelite images</li>
<li>identifying the network boot interface and additional network interfaces in the image should be configured by DHCP</li>
</ul>
<p>Understanding the types of xCAT operating system images is also important. xCAT supports the deployment of:</p>
<ul>
<li>statefull (full-disk) OS images</li>
<li>diskless OS images</li>
<li>statelite OS images</li>
</ul>
<p>The customizations</p>
<p><strong><em>'Other items to include or reference in this doc'</em></strong></p>
<ul>
<li>types of netboot: pxe, xnba, yaboot</li>
<li>running, debugging postscripts</li>
<li>flowcontrol</li>
<li>nodestatus</li>
<li>use of DHCP, customizations</li>
<li>ESXi - statefull, stateless</li>
<li>mixed OS or mixed arch clusters</li>
<li>service node issues (shared vs. local /install or /tftpboot)</li>
</ul>
<p><strong><em>'THE OLD DOCUMENT STARTS HERE -- MOVING RELEVANT PARTS INTO THE NEW DOC ABOVE'</em></strong></p>
<p><strong>Note: This documentation is written for xCAT 2.8.1 and newer releases. For earlier xCAT versions, see [Convert_Non-osimage_Based_System_To_Osimage_Based_System_Old]</strong></p>
<p>[[img src=Official-xcat-doc.png]]</p>
<h2 id="overview-and-background"><a href="#TOC">Overview and Background</a></h2>
<p>This documentation illustrates how to convert a Linux non-osimage based system to an osimage based system. This doc only works for xCAT on Linux, xCAT on AIX system uses a different mechanism and is not covered by this doc.</p>
<p>In the old xCAT releases, the Linux os provisioning configuration was determined by the node attributes &quot;os&quot;, &quot;arch&quot;, &quot;profile&quot; and &quot;provmethod&quot;; xCAT code will internally use these four attributes to setup the os provisioning configuration, for example, if the node attributes are set to:</p>
<pre><code> os=rhels6.3
 arch=x86_64
 profile=compute
 provmethod=install</code></pre>
<p>The os provisioning configuration for this node will look like:</p>
<pre><code> kickstart template(template): /opt/xcat/share/xcat/install/rh/compute.rhels6.x86_64.tmpl or /install/custom/install/rh/compute.rhels6.x86_64.tmpl
 os repository(pkgdir): /install/rhels6.3/x86_64
 package list file(pkglist): /opt/xcat/share/xcat/install/rh/compute.rhels6.x86_64.pkglist or /install/custom/install/rh/compute.rhels6.x86_64.pkglist
 otherpkgs directory(otherpkgdir) /install/post/otherpkgs/rhels6.3/x86_64/
 otherpkgs list(otherpkgslist): /install/custom/install/rh/compute.rhels6.x86_64.otherpkgs.pkglist
 synclist file(synclists): /install/custom/install/rh/compute.rhels6.x86_64.pkglist</code></pre>
<p>We can see that the path of configuration files are determined implicitly based on the node attributes &quot;os&quot;, &quot;arch&quot;, &quot;profile&quot; and &quot;provmethod&quot;; furthermore, the search for some of the configuration files like template and pkglist uses the longest prefix matching algorithm, which will sometimes confuse administrators and users. Another drawback is that you could not customize as much for the os provisioning configuration.</p>
<p>In some recent xCAT release(actually not that recent, it was first announced with xCAT 2.3 in year 2009, and a lot of enhancements were done later.), a new &quot;osimage&quot; concept was introduced to address all of the problems with the old way of using &quot;os&quot;, &quot;arch&quot;, &quot;profile&quot; and &quot;provmethod&quot;. Since then, the osimage feature has been tested thoroughly and has been used widely by different teams in many different types of xCAT clusters.</p>
<h2 id="what-is-osimage"><a href="#TOC">What is osimage?</a></h2>
<p>The osimage is an xCAT object definition type that can be managed through mkdef,lsdef,chdef,and rmdef commands. The osimage object contains the configuration information for the os provisioning, including the information in the example mentioned above. After the osimage is created and customized correctly, it can be associated with any node that uses the os provisioning configuration defined in the osimage. When you run the copycds command, xCAT will create some default osimage definitions for that OS and architecture. The osimage information is stored in xCAT tables osimage and linuximage. For more details about these tables, see the <a href="http://xcat.sourceforge.net/man5/osimage.5.html">osimage</a> and <a href="http://xcat.sourceforge.net/man5/linuximage.5.html">linuximage</a> manpages.</p>
<h2 id="why-do-i-want-to-convert-to-osimage-based-configuration"><a href="#TOC">Why do I want to convert to osimage based configuration?</a></h2>
<p><strong>xCAT team strongly recommends using the osimage configuration instead of the old methodology that relies on the &quot;os&quot;, &quot;arch&quot;, &quot;profile&quot; and &quot;provmethod&quot; attribute settings</strong>. The osimage methodology has several advantages in comparison to the previous one:</p>
<p>1. It is cleaner: All the configuration information is set explicitly in the osimage object in the xCAT database. You do not need to calculate or remember the location of the configuration files. You will not run into problems whenthe os provisioning actually uses a different configuration file than you expected because of the implicit way of calculating the path and configuration files.</p>
<p>2. It is easier: You can use *def commands to manage the osimage easily. The command syntax is exactly the same as for node management, except that you need to add the flag &quot;-t osimage&quot; to let the *def commands know that you are managing osimage objects.</p>
<p>3. It is more flexible: The osimage provides many configurable options that can be used to customize the os provisioning configuration. If you do not want to customize too much, the default osimage objects created by copycds should be able to satisfy your requirements.</p>
<h2 id="procedure-for-using-osimage"><a href="#TOC">Procedure for using osimage</a></h2>
<p>The use of osimage does not change the general Linux os provisioning procedure, the only difference is that you need to specify the osimage when you run the genimage and nodeset commands. The procedure of using osimage has been covered by different xCAT docs like <a href="https://sourceforge.net/apps/mediawiki/xcat/index.php?title=XCAT_iDataPlex_Cluster_Quick_Start">XCAT iDataPlex Cluster Quick Start</a> and <a href="https://sourceforge.net/apps/mediawiki/xcat/index.php?title=XCAT_pLinux_Clusters">xCAT pLinux Clusters</a>, here is only a summary of the procedure of using osimage:</p>
<p>1. Select or Create an osimage Definition</p>
<p>The copycds command also automatically creates several osimage defintions in the database that can be used for node deployment. To see them:</p>
<pre><code>lsdef -t osimage          # see the list of osimages
lsdef -t osimage &amp;lt;osimage-name&amp;gt;          # see the attributes of a particular osimage</code></pre>
<p>From the list above, select the osimage for your distro, architecture, provisioning method (in this case install), and profile (compute, service, etc.). Although it is optional, we recommend you make a copy of the osimage, changing its name to a simpler name. For example:</p>
<pre><code>lsdef -t osimage -z rhels6.2-x86_64-install-compute | sed &#39;s/^[^ ]\+:/myosimage:/&#39; | mkdef -z</code></pre>
<p>This displays the osimage &quot;rhels6.2-x86_64-install-compute&quot; in a format that can be used as input to mkdef, but on the way there it uses sed to modify the name of the object to &quot;myosimage&quot;.</p>
<p>2. Customize the osimage definitions</p>
<p>Initially, this osimage object points to templates, pkglists, etc. that are shipped by default with xCAT. And some attributes, for example otherpkglist and synclists, won't have any value at all because xCAT doesn't ship a default file for that. You can now change/fill in any <a href="http://xcat.sourceforge.net/man7/osimage.7.html">osimage attributes</a> that you want. A general convention is that if you are modifying one of the default files that an osimage attribute points to, copy it into /install/custom and have your osimage point to it there. (If you modify the copy under /opt/xcat directly, it will be over-written the next time you upgrade xCAT.)</p>
<p>You can use chdef command to change the osimage definitions, there are a lot of configurable options for osimage definitions, you can use</p>
<pre><code> lsdef -t osimage -h</code></pre>
<p>to list the attributes of osimage definitions. To change an attribute, run the command like:</p>
<pre><code> chdef -t osimage myosimage pkglist=/install/custom/install/rh/myosimage.pkglist</code></pre>
<p>For diskless (provmethod=netboot) and statelite (provemethod=statelite) osimages, one important attribute to set is rootimgdir. You will want to make sure this value does not conflict with any other osimage definition,since it is the target location genimage will use to build your OS image chroot filesystem.</p>
<pre><code>  chdef -t osimage myosimage rootimgdir=/install/netboot/rhels6.3/x86_64/myosimage</code></pre>
<p>3. Create diskless images</p>
<pre><code> genimage &amp;lt;osimage_name&amp;gt;
 packimage &amp;lt;osimage_name&amp;gt;
 or
 liteimg &amp;lt;osimage_name&amp;gt;</code></pre>
<p>4. Associate the osimage with nodes</p>
<p>nodeset command now accepts the osimage as a parameter, you can run nodeset command to associate the osimage with nodes.</p>
<pre><code> nodeset &amp;lt;noderange&amp;gt; osimage=&amp;lt;osimage_name&amp;gt;</code></pre>
<p>The nodeset command will set the node attribute provmethod to be the osimage name, if the nodes' provmethod has already been set to be an osimage, or you need to run nodeset against nodes with different osimages in one invocation, you can run nodeset command with the keyword osimage(this is a feature available only in xCAT 2.8 and later releases):</p>
<pre><code> nodeset &amp;lt;noderange&amp;gt; osimage</code></pre>
<h2 id="convert-to-osimage-based-configuration"><a href="#TOC">Convert to osimage based configuration</a></h2>
<p>The core part of converting to osimage based configuration is to translate the current os provisioning configuration into the osimage definitions.</p>
<p>1. Categorize the current os provisioning configurations</p>
<p>The existing os provisioning configuration is determined by the node attributes &quot;os&quot;, &quot;arch&quot;, &quot;profile&quot; and &quot;provmethod&quot;. The following commands can be used to categorize the os provisioning configuration:</p>
<pre><code> lsdef -t node -i os,arch,profile,provmethod -c | xdshbak -c

 or

 tabdump nodetype | awk -F&#39;,&#39; &#39;{print $2,$3,$4,$5,$1}&#39; | sort</code></pre>
<p>Here is an example output of the <em>lsdef -t node -i os,arch,profile,provmethod -c | xdshbak -c</em>:</p>
<pre><code>[root@xcatmn ~]# lsdef -t node -i os,arch,profile,provmethod -c | xdshbak -c

HOSTS:
-------------------------------------------------------------------------
node01,node02,node03,node04,node05,node06,node07,node08,node09,node10
-------------------------------------------------------------------------------
arch=x86_64
os=rhels6.3
profile=compute
provmethod=install

HOSTS:
-------------------------------------------------------------------------
node11,node12,node13,node14,node15,node16,node17,node18,node19,node20
-------------------------------------------------------------------------------
arch=x86_64
os=rhels6.3
profile=compute
provmethod=netboot

HOSTS:
-------------------------------------------------------------------------
node21,node22,node23,node24,node25,node26,node27,node28,node29,node30
-------------------------------------------------------------------------------
arch=x86_64
os=rhels6.3
profile=compute
provmethod=statelite
[root@xcatmn ~]#</code></pre>
<p>According to the output, there are three os provisioning configuration categories, and each category has 10 nodes.</p>
<p>2. (Optional) Create node groups for each os provisioning configuration category</p>
<p>To simplify the subsequent steps, it is a good idea to add these nodes in each os provisioning configuration category to different node groups.</p>
<pre><code> chdef node01-node10 -p groups=osimage1
 chdef node11-node20 -p groups=osimage2
 chdef node21-node30 -p groups=osimage3</code></pre>
<p>3. Select or create an osimage for each os provisioning configuration</p>
<p>Before creating new osimages manually, you might want to check if the default osimage definitions created by xCAT could match your requirements.</p>
<pre><code> [root@xcatmn ~]# lsdef -t osimage
 rhels6.3-x86_64-install-compute  (osimage)
 rhels6.3-x86_64-install-compute_ad  (osimage)
 rhels6.3-x86_64-install-hpc  (osimage)
 rhels6.3-x86_64-install-iscsi  (osimage)
 rhels6.3-x86_64-install-kvm  (osimage)
 rhels6.3-x86_64-install-service  (osimage)
 rhels6.3-x86_64-install-storage  (osimage)
 rhels6.3-x86_64-install-xen  (osimage)
 rhels6.3-x86_64-netboot-compute  (osimage)
 rhels6.3-x86_64-netboot-kvm  (osimage)
 rhels6.3-x86_64-netboot-nfsroot  (osimage)
 rhels6.3-x86_64-netboot-service  (osimage)
 rhels6.3-x86_64-netboot-xen  (osimage)
 rhels6.3-x86_64-statelite-compute  (osimage)
 rhels6.3-x86_64-statelite-kvm  (osimage)
 rhels6.3-x86_64-statelite-nfsroot  (osimage)
 rhels6.3-x86_64-statelite-service  (osimage)
 rhels6.3-x86_64-statelite-xen  (osimage)
 [root@xcatmn ~]# lsdef -t osimage rhels6.3-x86_64-install-compute
 Object name: rhels6.3-x86_64-install-compute
   imagetype=linux
   osarch=x86_64
   osdistroname=rhels6.3-x86_64
   osname=Linux
   osvers=rhels6.3
   otherpkgdir=/install/post/otherpkgs/rhels6.3/x86_64
   pkgdir=/install/rhels6.3/x86_64
   pkglist=/opt/xcat/share/xcat/install/rh/compute.rhels6.x86_64.pkglist
   profile=compute
   provmethod=install
   template=/opt/xcat/share/xcat/install/rh/compute.rhels6.x86_64.tmpl
 [root@xcatmn ~]# </code></pre>
<p>If the default osimage definitions created by xCAT do not match your requirements, or the default osimage definitions are not created on your xCAT management node at all, you need to create one osimage definition for each os provisioning configuration, following the instructions above.</p>
<pre><code> mkdef -t osimage osimage1 -u
   osarch=x86_64 \
   osvers=rhels6.3 \
   profile=compute \
   provmethod=install


 mkdef -t osimage osimage2 -u
   osarch=x86_64 \
   osvers=rhels6.3 \
   profile=compute \
   provmethod=netboot


 mkdef -t osimage osimage3 -u
   osarch=x86_64 \
   osvers=rhels6.3 \
   profile=compute \
   provmethod=statelite</code></pre>
<p>4. Create diskless images</p>
<p>For stateless and statelite osimages, you will need to run genimage and packimage/liteimg to create the diskless image.</p>
<pre><code> genimage osimage1
 genimage osimage2
 genimage osimage3


 packimage osimage1
 packimage osimage2
 packimage osimage3


 or


 liteimg osimage1
 liteimg osimage2
 liteimg osimage3</code></pre>
<p>5. Associate the osimage with the nodes</p>
<p>You can run:</p>
<pre><code> nodeset node01-node10 osimage=osimage1
 nodeset node11-node20 osimage=osimage2
 nodeset node21-node30 osimage=osimage3

 or if you are running xCAT 2.8 or later release:

 chdef node01-node10 provmethod=osimage1
 chdef node11-node20 provmethod=osimage2
 chdef node21-node30 provmethod=osimage3
 nodeset node01-node30 osimage</code></pre>
<p><strong>Note:</strong> for diskful nodes, you might not want to run nodeset to avoid re-provisioning when the diskful nodes are rebooted. If this is the case, run chdef to set the node's provmethod attribute to the osimage name. Then, when you are ready to re-provision the node you can use the short 'nodeset &lt;noderange&gt; osimage' command to provision this image.</p>
</body>
</html>
