<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#chef-installation">chef installation</a><ul>
<li><a href="#on-ubuntu">On Ubuntu</a></li>
<li><a href="#on-redhat">On Redhat</a></li>
</ul></li>
<li><a href="#openstack-deployment-with-chef">OpenStack Deployment with Chef</a><ul>
<li><a href="#configure-the-chef-serveror-workstation">Configure the chef server(or workstation)</a></li>
<li><a href="#deploy-openstack">Deploy openstack</a><ul>
<li><a href="#modify-the-configuration-file-on-server-or-workstation">Modify the configuration file on server( or workstation)</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<p><!-- START doctoc generated TOC please keep comment here to allow auto update --> <!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --> Table of Contents</p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#chef-installation">chef installation</a></li>
<li><a href="#on-ubuntu">On Ubuntu</a></li>
<li><a href="#on-redhat">On Redhat</a></li>
<li><a href="#openstack-deployment-with-chef">OpenStack Deployment with Chef</a></li>
<li><a href="#configure-the-chef-serveror-workstation">Configure the chef server(or workstation)</a></li>
<li><a href="#deploy-openstack">Deploy openstack</a>
<ul>
<li><a href="#modify-the-configuration-file-on-server-or-workstation">Modify the configuration file on server( or workstation)</a></li>
</ul></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<p><a href="Design_Warning">Design_Warning</a></p>
<h2 id="introduction"><a href="#TOC">Introduction</a></h2>
<p>This mini-design discusses how to use Chef to deploy OpenStack software. Chef is an an open-source automation configuration management tool written in Ruby and Erlang. It uses a pure-Ruby, domain-specific language (DSL) for writing system configuration &quot;recipes&quot; or &quot;cookbooks&quot;. Chef was written by Opscode (http://www.opscode.com/chef/) and is released as open source under the Apache License 2.0. Chef is a DevOps tool used for configuring cloud services or to streamline the task of configuring a company's internal servers.Chef supports a wide variety of cloud providers including Amazon AWS, Google App Engine, OpenStack and so on. OpenStack (http://www.openstack.org/) is an open source software that provides infrastructure for cloud computing.</p>
<p>This doc discusses how to setup chef server and client within xCAT cluster and then kick off the OpenStack deployment using chef. We'll have the following assumption:</p>
<ul>
<li>All the nodes have an external network that has internet connection and a internal network.</li>
<li>The OpenStack controller will not be the same as the xCAT management node. This is due to the conflict of OpenStack DHCP and xCAT DHCP server.</li>
</ul>
<p>We'd like to divide it into following two functions:</p>
<ol style="list-style-type: decimal">
<li>chef installation</li>
<li>OpenStack deployment with chef</li>
</ol>
<p>Function #1 itself is a unique feature that allows user to use the chef deploying other applications.</p>
<h2 id="chef-installation"><a href="#TOC">chef installation</a></h2>
<p>Chef comprises three main elements: a server, one (or more) nodes, and at least one workstation.</p>
<p>Server - The Chef Server acts as a hub that is available to every node in the Chef organization. This ensures that the right cookbooks (and recipes) are available, that the right policies are being applied, that the node object used during the previous Chef run is available to the current Chef run, and that all of the nodes that will be maintained by Chef are registered and known to the Chef Server.</p>
<p>Workstation - The workstation is the location from which cookbooks (and recipes) are authored, policy data (such as roles, environments, and data bags) are defined, data is synchronized with the Chef repository, and data is uploaded to the Chef Server. The workstation could be configured on the chef server.</p>
<p>Client - Each node contains a chef-client that performs the various infrastructure automation tasks that each node requires.</p>
<h3 id="on-ubuntu"><a href="#TOC">On Ubuntu</a></h3>
<p>The following 6 postscripts will be created, they will be installed under /install/postscripts directory.</p>
<ol style="list-style-type: decimal">
<li>install_chef_server It can be run on the mn as a script or on a node as a postscript to install and configure the chef server. It first installs the chef-server deb(or rpm) and then calls the config_chef_server script to modify the chef server configuration files.</li>
<li>install_chef_workstation It is run as a postscript on a node. It first download and installs the chef deb(or rpm) and then calls config_chef_workstation script to copy the admin.pem and chef-validator.pem from server to workstation, and then modify the knife.rb configuration file.</li>
<li>install_chef_client It is run as a postscript on a node. It first download and installs the chef deb(or rpm) and then calls config_chef_client script to modify the client.rb configuration file, and then run &quot;/opt/chef/bin/chef-client&quot; to register the client on the server.</li>
<li>config_chef_server It is called by install_chef_server on Ubuntu and the chef kit on RH (discussed later). It runs the &quot;sudo chef-server-ctl reconfigure&quot; to do the configuration.</li>
<li>config_chef_workstation It is called by install_chef_workstation on Ubuntu and the chef kit on RH (discussed later). It copies the admin.pem and chef-validator.pem from server to workstation, and then modifies the knife.rb configuration file.</li>
<li>config_chef_client It is called by install_chef_client on Ubuntu and the chef kit on RH (discussed later). It copies chef-validator.pem from server to client, and then modifies the client.rb configuration file.</li>
</ol>
<p>This is what the user will do when installing chef:</p>
<p>First assign a node as a chefserver, the node can be mn or any node.</p>
<pre><code>   chdef -t site clustersite chefserver=&amp;lt;nodename&amp;gt;</code></pre>
<p>If the chef server in mn, run</p>
<pre><code>   install_chef_server</code></pre>
<p>If chef server is not mn, first add install_chef_server to the postscripts table for the node,</p>
<pre><code>   chdef -t node -o &amp;lt;nodename&amp;gt; -p postbootscripts=install_chef_server</code></pre>
<p>Then run updatnode or redeploy the node:</p>
<pre><code>   updatenode &amp;lt;nodename&amp;gt; -P install_chef_server
 or
   rsetboot &amp;lt;nodename&amp;gt; net
   nodeset &amp;lt;nodename&amp;gt; osimage=&amp;lt;imgname&amp;gt;
   rpower &amp;lt;nodename&amp;gt; reset</code></pre>
<p>To install chef workstation on nodes, first add install_chef_workstation to the postscripts table for the nodes,</p>
<pre><code>   chdef -t node -o &amp;lt;noderange&amp;gt; -p postbootscripts=install_chef_workstation </code></pre>
<p>Then run updatenode or redeploy the node:</p>
<pre><code>   updatenode &amp;lt;noderange&amp;gt; -P install_chef_workstation 
 or
   rsetboot &amp;lt;noderange&amp;gt; net
   nodeset &amp;lt;noderange&amp;gt; osimage=&amp;lt;imgname&amp;gt;
   rpower &amp;lt;noderange&amp;gt; reset</code></pre>
<p>To install chef client on nodes, first add install_chef_client to the postscripts table for the nodes,</p>
<pre><code>   chdef -t node -o &amp;lt;noderange&amp;gt; -p postbootscripts=install_chef_client</code></pre>
<p>Then run updatenode or redeploy the node:</p>
<pre><code>   updatenode &amp;lt;noderange&amp;gt; -P install_chef_client
 or
   rsetboot &amp;lt;noderange&amp;gt; net
   nodeset &amp;lt;noderange&amp;gt; osimage=&amp;lt;imgname&amp;gt;
   rpower &amp;lt;noderange&amp;gt; reset</code></pre>
<h3 id="on-redhat"><a href="#TOC">On Redhat</a></h3>
<p>Under discussion and dev.</p>
<h2 id="openstack-deployment-with-chef"><a href="#TOC">OpenStack Deployment with Chef</a></h2>
<p>With automation setup by the OpenStack chef Modules, deploying OpenStack is quite easy, if everything goes well. If something is wrong, you have to debug the modules which is not that easy. Hope we setup everything up front so that the installation goes smoothly.</p>
<p><strong>The following deployment is on Ubuntu 12.</strong></p>
<h3 id="configure-the-chef-serveror-workstation"><a href="#TOC">Configure the chef server(or workstation)</a></h3>
<p>1. Add the ubuntu repos on the internet</p>
<pre><code>ubuntusource=&quot;deb http://us.archive.ubuntu.com/ubuntu/ precise main\n
deb http://us.archive.ubuntu.com/ubuntu/ precise-updates main\n
deb http://us.archive.ubuntu.com/ubuntu/ precise universe\n
deb http://us.archive.ubuntu.com/ubuntu/ precise-updates universe\n
&quot;
echo -e $ubuntusource &amp;gt;&amp;gt; /etc/apt/sources.list
apt-get update</code></pre>
<p>2. install git and rake</p>
<pre><code>apt-get install -y git rake</code></pre>
<p>3. download the cookbooks</p>
<pre><code>mkdir -p /usr/ling/chef
cd /usr/ling/chef


git clone git://github.com/mattray/openstack-cookbooks.git
cd /usr/ling/chef/openstack-cookbooks/cookbooks
knife cookbook site download apache2 0.99.4
knife cookbook site download apt 1.1.2
knife cookbook site download mysql 1.0.5
knife cookbook site download openssl 1.0.0
knife cookbook site download rabbitmq 1.2.1


tar -axvf apache2-0.99.4.tar.gz
tar -axvf apt-1.1.2.tar.gz 
tar -axvf mysql-1.0.5.tar.gz
tar -axvf openssl-1.0.0.tar.gz
tar -axvf rabbitmq-1.2.1.tar.gz</code></pre>
<p>4. upload the cookbooks</p>
<pre><code>knife cookbook upload -a -o /usr/ling/chef/openstack-cookbooks/cookbooks
knife cookbook list
  apache2    0.99.4
  apt        1.1.2
  glance     0.2.0
  mysql      1.0.5
  nova       0.3.0
  openssl    1.0.0
  rabbitmq   1.2.1
  swift      0.1.0</code></pre>
<p>5. Roles</p>
<pre><code>cd /usr/ling/chef/openstack-cookbooks
rake roles


knife role list
 glance-single-machine
 nova-dashboard-server
 nova-db
 nova-multi-compute
 nova-multi-controller
 nova-rabbitmq-server
 nova-single-machine</code></pre>
<p>6. Configure Attributes for Deployment</p>
<pre><code>cd /usr/ling/chef/openstack-cookbooks
rake databag:upload_all
knife node run_list add oscn2.ppd.pok.ibm.com &quot;role[nova-single-machine]&quot;</code></pre>
<h3 id="deploy-openstack"><a href="#TOC">Deploy openstack</a></h3>
<h4 id="modify-the-configuration-file-on-server-or-workstation"><a href="#TOC">Modify the configuration file on server( or workstation)</a></h4>
<p>Modify the following files:</p>
<pre><code>/usr/ling/chef/openstack-cookbooks/cookbooks/nova/recipes/config.rb  and mysql.rb
diff config.rb config.rb.save
88c88</code></pre>
</body>
</html>
